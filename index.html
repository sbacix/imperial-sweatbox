<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Imperial Archives | Library</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;700&display=swap');

        :root {
            --bg-body: #1e2128;
            --bg-card: #252932;
            --bg-surface: #2d323d;
            --text-primary: #e2e8f0;
            --text-secondary: #94a3b8;
            --accent: #818cf8;
            --accent-soft: rgba(129, 140, 248, 0.1);
            --border: rgba(255, 255, 255, 0.04);
            --shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.2);
        }

        body.light {
            --bg-body: #f1f5f9;
            --bg-card: #ffffff;
            --bg-surface: #f8fafc;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --accent: #6366f1;
            --accent-soft: rgba(99, 102, 241, 0.08);
            --border: rgba(0, 0, 0, 0.05);
            --shadow: 0 4px 15px -3px rgba(0, 0, 0, 0.05);
        }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: var(--bg-body);
            color: var(--text-primary);
            transition: all 0.4s ease;
            overflow-x: hidden;
        }

        .mono { font-family: 'JetBrains Mono', monospace; }

        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-body); }
        ::-webkit-scrollbar-thumb { background: var(--bg-surface); border-radius: 10px; }

        .archive-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 20px;
            box-shadow: var(--shadow);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .archive-card:hover {
            transform: translateY(-5px);
            border-color: var(--accent);
        }

        .input-base {
            background: var(--bg-surface);
            border: 1px solid var(--border);
            color: var(--text-primary);
            border-radius: 12px;
            transition: all 0.2s;
        }

        .input-base:focus {
            border-color: var(--accent);
            outline: none;
            box-shadow: 0 0 0 3px var(--accent-soft);
        }

        .btn-primary {
            background: var(--accent);
            color: white;
            border-radius: 12px;
        }

        .coord-btn {
            background: var(--bg-surface);
            color: var(--accent);
            border: 1px solid var(--border);
            transition: all 0.2s;
            font-size: 10px;
            font-weight: 700;
            padding: 6px 12px;
            border-radius: 8px;
        }
        
        .coord-btn:hover {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }

        #filterSidebar {
            background: var(--bg-card);
            border-left: 1px solid var(--border);
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        #filterSidebar.open { transform: translateX(0); }

        .loot-pill {
            background: var(--bg-surface);
            border: 1px solid var(--border);
            border-radius: 14px;
            padding: 12px;
            margin-bottom: 10px;
            transition: background 0.2s;
        }

        .loot-pill:hover {
            background: var(--accent-soft);
        }

        .stat-badge {
            font-size: 10px;
            font-weight: 600;
            padding: 2px 6px;
            border-radius: 6px;
            background: rgba(0,0,0,0.1);
        }

        .toggle-btn.active {
            background: var(--accent);
            color: white !important;
        }

        #toast {
            position: fixed;
            bottom: 2.5rem;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--bg-surface);
            color: var(--text-primary);
            padding: 0.8rem 1.8rem;
            border-radius: 14px;
            font-weight: 600;
            font-size: 14px;
            z-index: 1000;
            transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            border: 1px solid var(--accent);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }
        #toast.show { transform: translateX(-50%) translateY(0); }
    </style>
</head>
<body class="min-h-screen">

    <div id="toast">Ready</div>

    <!-- Smooth Header -->
    <header class="sticky top-0 z-40 w-full bg-[var(--bg-body)]/80 backdrop-blur-xl border-b border-[var(--border)]">
        <div class="max-w-[1400px] mx-auto px-6 h-20 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-indigo-500 rounded-xl flex items-center justify-center text-white shadow-lg shadow-indigo-500/20">
                    <i class="fas fa-atlas"></i>
                </div>
                <div>
                    <h1 class="text-base font-extrabold tracking-tight">Library of <span class="text-indigo-400">Imperial</span></h1>
                    <p class="text-[10px] text-[var(--text-secondary)] font-bold tracking-[0.1em] uppercase">Tactical Inventory Matrix</p>
                </div>
            </div>

            <div class="hidden md:flex flex-1 max-w-xl mx-8 relative">
                <i class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-[var(--text-secondary)]"></i>
                <input 
                    type="text" id="globalSearch" 
                    placeholder="Search sources or specific drops..."
                    class="w-full input-base py-2.5 pl-11 pr-6 text-sm"
                >
            </div>

            <div class="flex items-center gap-3">
                <button id="themeToggle" class="input-base w-10 h-10 flex items-center justify-center text-[var(--text-secondary)]">
                    <i class="fas fa-leaf" id="themeIcon"></i>
                </button>
                <button id="toggleFilters" class="btn-primary px-5 py-2.5 text-xs font-bold uppercase tracking-widest flex items-center gap-2 shadow-lg shadow-indigo-500/20">
                    <i class="fas fa-sliders"></i> Matrix
                </button>
            </div>
        </div>
    </header>

    <main class="max-w-[1400px] mx-auto px-6 py-8">
        <div id="activeTags" class="flex flex-wrap gap-2 mb-8 min-h-[32px]"></div>

        <div class="flex items-center justify-between mb-8">
            <h2 id="resultsInfo" class="text-xs font-bold text-[var(--text-secondary)] uppercase tracking-widest">
                Scanning Records...
            </h2>
        </div>

        <div id="sourceGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8"></div>

        <div id="emptyState" class="hidden py-40 flex flex-col items-center text-center">
            <div class="w-16 h-16 bg-[var(--bg-surface)] rounded-2xl flex items-center justify-center mb-6 opacity-50">
                <i class="fas fa-binoculars text-2xl"></i>
            </div>
            <h3 class="text-lg font-bold">No Records Found</h3>
            <p class="text-[var(--text-secondary)] text-sm mb-6">Matrix initialization returned zero matches in this sector.</p>
            <button onclick="clearAllFilters()" class="text-indigo-400 font-bold uppercase text-xs tracking-widest hover:underline">Flush Archive</button>
        </div>
    </main>

    <!-- Matrix Sidebar -->
    <div id="sidebarOverlay" class="fixed inset-0 bg-black/50 z-[50] opacity-0 pointer-events-none transition-opacity duration-300"></div>
    <aside id="filterSidebar" class="fixed top-0 right-0 h-full w-[360px] z-[60] transform translate-x-full shadow-2xl flex flex-col">
        <div class="p-6 border-b border-[var(--border)] flex items-center justify-between">
            <h2 class="font-bold text-sm uppercase tracking-widest">Archive Matrix</h2>
            <button id="closeSidebar" class="text-[var(--text-secondary)] hover:text-[var(--text-primary)]"><i class="fas fa-times"></i></button>
        </div>

        <div class="flex-1 overflow-y-auto p-6 space-y-8 custom-scrollbar">
            <section class="space-y-4">
                <label class="text-[10px] font-bold text-[var(--text-secondary)] uppercase tracking-widest">Quality Classification</label>
                <div class="grid grid-cols-4 gap-2" id="tierFilters">
                    <button data-tier="0" class="tier-btn input-base py-2 text-xs font-bold">T0</button>
                    <button data-tier="1" class="tier-btn input-base py-2 text-xs font-bold">T1</button>
                    <button data-tier="2" class="tier-btn input-base py-2 text-xs font-bold">T2</button>
                    <button data-tier="3" class="tier-btn input-base py-2 text-xs font-bold">T3</button>
                </div>
            </section>

            <section class="space-y-3">
                <label class="text-[10px] font-bold text-[var(--text-secondary)] uppercase tracking-widest">Active Search Protocols</label>
                <button id="interestToggle" class="toggle-btn input-base w-full py-3 text-[10px] font-bold uppercase tracking-widest flex items-center justify-center gap-2">
                    <i class="fas fa-star text-amber-400"></i> High Interest Only
                </button>
                <button id="coordsToggle" class="toggle-btn input-base w-full py-3 text-[10px] font-bold uppercase tracking-widest flex items-center justify-center gap-2">
                    <i class="fas fa-crosshairs text-indigo-400"></i> Localized Data Only
                </button>
            </section>

            <section class="space-y-4">
                <label class="text-[10px] font-bold text-[var(--text-secondary)] uppercase tracking-widest">Level Parameters</label>
                <div class="flex items-center gap-3">
                    <input type="number" id="minLevel" placeholder="0" class="w-full input-base px-3 py-2 text-sm font-bold">
                    <span class="text-[var(--text-secondary)] opacity-50 font-bold">-</span>
                    <input type="number" id="maxLevel" placeholder="115" class="w-full input-base px-3 py-2 text-sm font-bold">
                </div>
            </section>

            <section class="space-y-6">
                <div>
                    <label class="block text-[10px] font-bold text-emerald-400 uppercase tracking-widest mb-3">Buff Preference</label>
                    <select id="posStat1" class="w-full input-base px-3 py-2 text-xs font-bold outline-none"></select>
                </div>
                <div>
                    <label class="block text-[10px] font-bold text-rose-400 uppercase tracking-widest mb-3">Debuff Preference</label>
                    <select id="negStat1" class="w-full input-base px-3 py-2 text-xs font-bold outline-none"></select>
                </div>
            </section>

            <section class="space-y-4 pb-12">
                <label class="text-[10px] font-bold text-[var(--text-secondary)] uppercase tracking-widest">Authorized Professions</label>
                <div id="professionFilters" class="flex flex-wrap gap-2"></div>
            </section>
        </div>

        <div class="p-6 border-t border-[var(--border)]">
            <button onclick="clearAllFilters()" class="w-full py-3 rounded-xl text-[10px] font-bold uppercase tracking-widest bg-rose-500/10 text-rose-500 hover:bg-rose-500 hover:text-white transition-all">Clear All Constraints</button>
        </div>
    </aside>

    <script>
        const MANUAL_INTEREST_LIST = [
            "Adamastor's Faceplate", "Ancient Heart", "Archaic Medallion", "Bat Heart", "Borange Fluff",
            "Cat Food", "Cataratite", "Coalescence", "Colossus' Shard", "Contraband Absinthe",
            "Contraband Hibiscus", "Creepvine Cluster", "Cursed Wings", "Cyclone Blue Leaves",
            "Death Whistle Leaf", "Decaying Heart", "Defiled Luxroot", "Defishious", "Dernic Parasite",
            "Doom Stone", "Draconic Bone Marrow", "Earthly Aura", "Elephelk Trunk", "Enhanced Behaviour Microchip",
            "Enhanced Potential Microchip", "Evolving Spores", "Eye of The Beast", "Fairy Powder",
            "Farcor's Trust", "Fiery Aura", "Flow of Fate", "Gilded Bark", "Glacial Anomaly",
            "Glowing Tree Sap", "Haleva Plant", "Haphazard Serum", "Ice Cream Sandwich", "Kerasot Sporehead",
            "Large Titanium Chunk", "Lashing Hellfire", "Lithoflesh", "Letvus Delight", "Lunar Charm",
            "Luxrooot Cuttings", "Mangrove Root", "Mellow Mango", "Myconid Spores", "Myocardial Leg",
            "Naval Stone", "Nightmare Fuel", "Nivlan Honey", "Obelisk Core", "Plane of Nonexistence",
            "Pride of the Heights", "Prismatic Spores", "Red Mercury", "Remedial Paste", "Ritual Catalyst",
            "Rock-Hard Beak", "Sentient Leukocyte", "Serpent Tongue", "Shattered Dawnlight", "Shrieker's Head",
            "Smokebomb", "Soulbound Cinders", "Tentacle", "Throbbing Avos Heart", "Unicorn Horn",
            "Watery Aura", "Windy Aura", "World Illuminator"
        ];
        const INTEREST_NAMES = new Set(MANUAL_INTEREST_LIST.map(n => n.trim().toLowerCase()));
        
        let SOURCE_DATA = [];
        let GLOBAL_ITEM_LOOKUP = {};
        const STATE = {
            search: "", minLv: 0, maxLv: 115, tiers: new Set(), profs: new Set(),
            posStat1: "", negStat1: "", interestOnly: false, coordsOnly: false, theme: "dark",
            allProfs: [], allPosStats: [], allNegStats: []
        };

        const isNum = (v) => v !== null && v !== undefined && v !== "" && isFinite(Number(v));
        function debounce(func, wait) {
            let timeout; return function(...args) { clearTimeout(timeout); timeout = setTimeout(() => func.apply(this, args), wait); };
        }

        async function loadShopData() {
            let ingredients = {}, drops = {}, htoi = [];
            try {
                const [resI, resD, resH] = await Promise.all([
                    fetch('ingredients.json').then(r => r.ok ? r.json() : {}),
                    fetch('drops.json').then(r => r.ok ? r.json() : {}),
                    fetch('htoi.json').then(r => r.ok ? r.json() : [])
                ]);
                ingredients = resI; drops = resD; htoi = resH;
            } catch (e) { console.error("Archive Buffer Offline", e); }
            processJsonData(ingredients, drops, htoi);
        }

        function processJsonData(ingredients, dropsMap, htoiArray) {
            GLOBAL_ITEM_LOOKUP = {};
            Object.keys(ingredients).forEach(k => {
                const lower = k.trim().toLowerCase();
                GLOBAL_ITEM_LOOKUP[lower] = { ...ingredients[k], originalName: k };
            });

            const globalMobCoords = {};
            const addMobCoords = (mobName, coords) => {
                if (!mobName) return;
                const key = mobName.toLowerCase().trim();
                if (!globalMobCoords[key]) globalMobCoords[key] = [];
                const arr = Array.isArray(coords) ? coords : [coords].filter(x => x);
                arr.forEach(c => {
                    if (isNum(c.x) && isNum(c.z)) {
                        const nx = Number(c.x), ny = isNum(c.y) ? Number(c.y) : 0, nz = Number(c.z);
                        if (Math.abs(nx) + Math.abs(ny) + Math.abs(nz) === 0) return; // Ignore 0,0,0
                        const obj = { x: nx, y: isNum(c.y) ? ny : null, z: nz };
                        if (!globalMobCoords[key].some(ex => ex.x === obj.x && ex.z === obj.z)) globalMobCoords[key].push(obj);
                    }
                });
            };

            Object.values(dropsMap).forEach(arr => {
                if (Array.isArray(arr)) arr.forEach(d => addMobCoords(d.name, d.details?.coords));
            });
            htoiArray.forEach(h => {
                Object.keys(h).forEach(prop => {
                    if (['name', 'id', 'level'].includes(prop)) return;
                    try {
                        const parsed = JSON.parse(h[prop]);
                        if (Array.isArray(parsed)) parsed.forEach(e => addMobCoords(e.name || e.description, e.location_coords || e.coords));
                    } catch(e) {}
                });
            });

            const sourceRegistry = {};
            const registerSource = (mobName, location, screenshot, itemName) => {
                if (!mobName) return;
                const sName = mobName.trim();
                const sLoc = location?.trim() || "Undisclosed Sector";
                const sourceKey = `${sName.toLowerCase()}|${sLoc.toLowerCase()}`;

                if (!sourceRegistry[sourceKey]) {
                    sourceRegistry[sourceKey] = {
                        name: sName,
                        location: sLoc,
                        screenshots: new Set(),
                        loot: new Set(),
                        coords: globalMobCoords[sName.toLowerCase()] || []
                    };
                }
                if (screenshot) sourceRegistry[sourceKey].screenshots.add(screenshot);
                if (itemName) sourceRegistry[sourceKey].loot.add(itemName.toLowerCase().trim());
            };

            Object.keys(dropsMap).forEach(itemName => {
                const arr = dropsMap[itemName];
                if (Array.isArray(arr)) arr.forEach(d => registerSource(d.name, d.details?.location, d.details?.screenshots, itemName));
            });
            htoiArray.forEach(h => {
                const itemName = h.name;
                Object.keys(h).forEach(prop => {
                    if (['name', 'id', 'level'].includes(prop)) return;
                    try {
                        const parsed = JSON.parse(h[prop]);
                        if (Array.isArray(parsed)) parsed.forEach(e => registerSource(e.name || e.description || prop.toUpperCase(), e.location, e.screenshots, itemName));
                    } catch(e) {}
                });
            });

            const finalSources = Object.values(sourceRegistry).map(src => {
                const lootDetails = Array.from(src.loot).map(lootName => {
                    const info = GLOBAL_ITEM_LOOKUP[lootName] || { originalName: lootName, stats: [], lvl: 0, tier: -1, profs: [] };
                    return {
                        name: info.originalName,
                        level: Number(info.lvl) || 0,
                        tier: info.tier !== undefined ? Number(info.tier) : -1,
                        professions: info.profs || [],
                        stats: info.stats || []
                    };
                });
                const searchStr = [src.name, src.location, ...lootDetails.map(l => l.name)].join(' ').toLowerCase();
                return { ...src, loot: lootDetails, searchStr, screenshots: Array.from(src.screenshots) };
            });

            SOURCE_DATA = finalSources;
            computeState();
            render();
        }

        function computeState() {
            const allItems = Object.values(GLOBAL_ITEM_LOOKUP);
            STATE.allProfs = [...new Set(allItems.flatMap(i => i.profs || []))].sort();
            STATE.allPosStats = [...new Set(allItems.flatMap(i => (i.stats || []).filter(s => s.pos).map(s => s.label)))].sort();
            STATE.allNegStats = [...new Set(allItems.flatMap(i => (i.stats || []).filter(s => !s.pos).map(s => s.label)))].sort();
            
            document.getElementById('posStat1').innerHTML = '<option value="">All Attributes</option>' + STATE.allPosStats.map(s => `<option value="${s}">${s}</option>`).join('');
            document.getElementById('negStat1').innerHTML = '<option value="">All Attributes</option>' + STATE.allNegStats.map(s => `<option value="${s}">${s}</option>`).join('');
            document.getElementById('professionFilters').innerHTML = STATE.allProfs.map(p => `<button data-prof="${p}" class="prof-chip input-base px-3 py-1.5 rounded-lg text-[10px] font-bold uppercase tracking-wider">${p}</button>`).join('');
        }

        function filterData() {
            return SOURCE_DATA.filter(src => {
                if (STATE.search && !src.searchStr.includes(STATE.search.toLowerCase())) return false;
                if (STATE.coordsOnly && src.coords.length === 0) return false;
                if (STATE.interestOnly && !src.loot.some(l => INTEREST_NAMES.has(l.name.toLowerCase()))) return false;

                const hasMatchingLoot = src.loot.some(l => {
                    if (l.level < STATE.minLv || l.level > STATE.maxLv) return false;
                    if (STATE.tiers.size > 0 && !STATE.tiers.has(l.tier.toString())) return false;
                    if (STATE.profs.size > 0 && !l.professions.some(p => STATE.profs.has(p))) return false;
                    if (STATE.posStat1 && !l.stats.some(s => s.label === STATE.posStat1 && s.pos)) return false;
                    if (STATE.negStat1 && !l.stats.some(s => s.label === STATE.negStat1 && !s.pos)) return false;
                    return true;
                });

                const anyLootFilters = STATE.minLv > 0 || STATE.maxLv < 115 || STATE.tiers.size > 0 || STATE.profs.size > 0 || STATE.posStat1 || STATE.negStat1;
                if (anyLootFilters && !hasMatchingLoot) return false;
                return true;
            }).sort((a,b) => a.name.localeCompare(b.name));
        }

        function render() {
            const grid = document.getElementById('sourceGrid'), info = document.getElementById('resultsInfo');
            const data = filterData();
            const view = data.slice(0, 60);
            
            info.textContent = data.length > 0 ? `${data.length} Strategic Sources Retrieved` : "Database Out of Sync: Null Results";
            
            if (view.length === 0) {
                grid.innerHTML = "";
                document.getElementById('emptyState').classList.remove('hidden');
            } else {
                document.getElementById('emptyState').classList.add('hidden');
                grid.innerHTML = view.map(src => {
                    const coordsHtml = src.coords.map(c => {
                        const hasY = isNum(c.y);
                        const label = hasY ? `${c.x}, ${c.y}, ${c.z}` : `${c.x}, ${c.z}`;
                        return `<button onclick="copyToClipboard('${c.x}','${c.y}','${c.z}')" class="coord-btn mono">${label}</button>`;
                    }).join('');

                    const lootHtml = src.loot.map(l => `
                        <div class="loot-pill">
                            <div class="flex justify-between items-start mb-2">
                                <div class="overflow-hidden">
                                    <h4 class="text-[11px] font-bold uppercase truncate">${l.name}</h4>
                                    <div class="flex items-center gap-2 mt-0.5">
                                        <span class="mono text-[8px] font-bold text-indigo-400">Lv.${l.level}</span>
                                        <div class="flex gap-0.5 text-amber-400 text-[8px]">
                                            ${l.tier >= 0 ? Array(l.tier).fill('â˜…').join('') : ''}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="flex flex-wrap gap-1.5 mt-2">
                                ${l.stats.slice(0, 4).map(s => `
                                    <span class="stat-badge ${s.pos ? 'text-emerald-400' : 'text-rose-400'}">
                                        ${s.label}: ${s.value}
                                    </span>
                                `).join('')}
                            </div>
                        </div>
                    `).join('');

                    return `
                    <div class="archive-card p-6">
                        <div class="flex justify-between items-start mb-4">
                            <div class="flex-1 overflow-hidden">
                                <h3 class="text-base font-black tracking-tight truncate uppercase pr-2">${src.name}</h3>
                                <div class="flex items-center gap-2 mt-1">
                                    <i class="fas fa-map-marker-alt text-[var(--text-secondary)] text-[10px]"></i>
                                    <p class="text-[10px] font-bold text-[var(--text-secondary)] truncate uppercase tracking-wider">${src.location}</p>
                                </div>
                            </div>
                            ${src.screenshots.length > 0 ? `<a href="${src.screenshots[0].split(',')[0]}" target="_blank" class="w-9 h-9 flex items-center justify-center rounded-xl bg-[var(--bg-surface)] text-indigo-400 hover:bg-indigo-500 hover:text-white transition-all"><i class="fas fa-camera text-xs"></i></a>` : ''}
                        </div>

                        <div class="mb-6">
                            <p class="text-[9px] font-bold uppercase tracking-[0.2em] text-[var(--text-secondary)] mb-3 opacity-60">Geolocation Records</p>
                            <div class="flex flex-wrap gap-2">
                                ${coordsHtml || '<span class="text-[10px] font-medium opacity-20 uppercase">Data Missing</span>'}
                            </div>
                        </div>

                        <div class="flex-1 overflow-y-auto max-h-[320px] custom-scrollbar pr-1">
                            <p class="text-[9px] font-bold uppercase tracking-[0.2em] text-[var(--text-secondary)] mb-3 opacity-60">Linked Artifacts (${src.loot.length})</p>
                            ${lootHtml}
                        </div>
                    </div>
                `}).join('');
            }
            renderActiveTags();
        }

        function renderActiveTags() {
            const container = document.getElementById('activeTags');
            const tags = [];
            if (STATE.search) tags.push({ id: 'search', val: STATE.search });
            if (STATE.interestOnly) tags.push({ id: 'interest', val: 'Priority Targets' });
            if (STATE.coordsOnly) tags.push({ id: 'coords', val: 'Geolocated Sources' });
            STATE.tiers.forEach(t => tags.push({ id: 'tier-'+t, val: `Tier ${t}` }));
            STATE.profs.forEach(p => tags.push({ id: 'prof-'+p, val: p }));

            container.innerHTML = tags.map(t => `
                <div class="flex items-center gap-2 px-3 py-1.5 bg-indigo-500/10 text-indigo-400 border border-indigo-500/20 rounded-xl text-[10px] font-bold uppercase tracking-wider">
                    ${t.val}
                    <button onclick="removeFilter('${t.id}')" class="hover:text-white transition-colors"><i class="fas fa-times"></i></button>
                </div>
            `).join('');
        }

        function copyToClipboard(x, y, z) {
            const hasY = isNum(y) && y !== 'null' && y !== 'undefined';
            const cmd = hasY ? `/compass ${x}, ${y}, ${z}` : `/compass ${x}, ${z}`;
            const el = document.createElement('textarea'); 
            el.value = cmd; el.style.position = "fixed"; el.style.left = "-9999px"; 
            document.body.appendChild(el); el.select();
            try {
                document.execCommand('copy'); 
                const t = document.getElementById('toast'); 
                t.textContent = "COPIED: " + cmd; 
                t.classList.add('show');
                setTimeout(() => t.classList.remove('show'), 2500);
            } catch(e) {}
            document.body.removeChild(el);
        }

        function removeFilter(id) {
            if (id === 'search') { STATE.search = ""; document.getElementById('globalSearch').value = ""; }
            else if (id === 'interest') { STATE.interestOnly = false; document.getElementById('interestToggle').classList.remove('active'); }
            else if (id === 'coords') { STATE.coordsOnly = false; document.getElementById('coordsToggle').classList.remove('active'); }
            else if (id.startsWith('tier-')) { STATE.tiers.delete(id.split('-')[1]); document.querySelectorAll('.tier-btn').forEach(b => { if(b.dataset.tier == id.split('-')[1]) b.classList.remove('active'); }); }
            else if (id.startsWith('prof-')) { STATE.profs.delete(id.split('-')[1]); document.querySelectorAll('.prof-chip').forEach(b => { if(b.dataset.prof == id.split('-')[1]) b.classList.remove('active'); }); }
            render();
        }

        function clearAllFilters() {
            STATE.search = ""; STATE.tiers.clear(); STATE.profs.clear(); 
            STATE.interestOnly = false; STATE.coordsOnly = false;
            STATE.minLv = 0; STATE.maxLv = 115;
            document.getElementById('globalSearch').value = "";
            document.querySelectorAll('.active').forEach(e => e.classList.remove('active'));
            document.querySelectorAll('input[type="number"]').forEach(i => i.value = "");
            render();
        }

        document.getElementById('toggleFilters').addEventListener('click', () => {
            document.getElementById('filterSidebar').classList.add('open');
            document.getElementById('sidebarOverlay').classList.replace('opacity-0', 'opacity-100');
            document.getElementById('sidebarOverlay').classList.remove('pointer-events-none');
        });
        document.getElementById('closeSidebar').addEventListener('click', () => {
            document.getElementById('filterSidebar').classList.remove('open');
            document.getElementById('sidebarOverlay').classList.replace('opacity-100', 'opacity-0');
            document.getElementById('sidebarOverlay').classList.add('pointer-events-none');
        });
        document.getElementById('sidebarOverlay').addEventListener('click', () => document.getElementById('closeSidebar').click());
        document.getElementById('globalSearch').addEventListener('input', debounce(e => { STATE.search = e.target.value; render(); }, 250));
        document.getElementById('minLevel').addEventListener('input', e => { STATE.minLv = Number(e.target.value) || 0; render(); });
        document.getElementById('maxLevel').addEventListener('input', e => { STATE.maxLv = Number(e.target.value) || 115; render(); });
        document.getElementById('posStat1').addEventListener('change', e => { STATE.posStat1 = e.target.value; render(); });
        document.getElementById('negStat1').addEventListener('change', e => { STATE.negStat1 = e.target.value; render(); });
        
        document.querySelectorAll('.tier-btn').forEach(b => b.addEventListener('click', () => {
            const t = b.dataset.tier; if (STATE.tiers.has(t)) STATE.tiers.delete(t); else STATE.tiers.add(t);
            b.classList.toggle('active'); render();
        }));

        document.getElementById('professionFilters').addEventListener('click', e => {
            const b = e.target.closest('.prof-chip'); if (!b) return;
            const p = b.dataset.prof; if (STATE.profs.has(p)) STATE.profs.delete(p); else STATE.profs.add(p);
            b.classList.toggle('active'); render();
        });

        document.getElementById('interestToggle').addEventListener('click', e => {
            STATE.interestOnly = !STATE.interestOnly; e.currentTarget.classList.toggle('active'); render();
        });
        document.getElementById('coordsToggle').addEventListener('click', e => {
            STATE.coordsOnly = !STATE.coordsOnly; e.currentTarget.classList.toggle('active'); render();
        });

        document.getElementById('themeToggle').addEventListener('click', () => {
            const body = document.body;
            body.classList.toggle('light');
        });

        window.onload = loadShopData;
    </script>
</body>
</html>
