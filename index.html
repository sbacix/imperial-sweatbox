<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Imperial Archives | Library</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;700&display=swap');

        :root {
            --bg-body: #070709;
            --bg-row: #0f0f13;
            --bg-surface: #16161c;
            --text-primary: #f8fafc;
            --text-secondary: #64748b;
            --accent: #6366f1;
            --accent-soft: rgba(99, 102, 241, 0.1);
            --border: rgba(255, 255, 255, 0.05);
        }

        body.light {
            --bg-body: #f1f5f9;
            --bg-row: #ffffff;
            --bg-surface: #e2e8f0;
            --text-primary: #0f172a;
            --text-secondary: #475569;
            --accent: #4f46e5;
            --accent-soft: rgba(79, 70, 229, 0.08);
            --border: rgba(0, 0, 0, 0.08);
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-body);
            color: var(--text-primary);
            transition: background 0.3s ease;
            overflow-x: hidden;
        }

        .mono { font-family: 'JetBrains Mono', monospace; }

        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: var(--bg-body); }
        ::-webkit-scrollbar-thumb { background: var(--bg-surface); border-radius: 3px; }

        /* Tactical Row Layout */
        .source-row {
            background: var(--bg-row);
            border-bottom: 1px solid var(--border);
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .source-row:hover {
            background: var(--accent-soft);
            border-color: var(--accent);
            z-index: 10;
        }

        .input-base {
            background: var(--bg-surface);
            border: 1px solid var(--border);
            color: var(--text-primary);
            transition: all 0.2s;
        }

        .input-base:focus {
            border-color: var(--accent);
            outline: none;
        }

        .btn-primary {
            background: var(--accent);
            color: white;
        }

        .tactical-btn {
            background: #ef4444;
            color: white;
            border: 1px solid #f87171;
            transition: all 0.2s;
            font-size: 9px;
            font-weight: 700;
            padding: 4px 10px;
            border-radius: 4px;
        }
        
        .tactical-btn:hover {
            background: #dc2626;
            filter: drop-shadow(0 0 8px rgba(239, 68, 68, 0.4));
        }

        #filterSidebar {
            background: var(--bg-row);
            border-left: 1px solid var(--border);
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        #filterSidebar.open { transform: translateX(0); }

        .stat-badge {
            font-size: 10px;
            font-weight: 700;
            padding: 2px 6px;
            border-radius: 4px;
            background: var(--bg-surface);
            border: 1px solid var(--border);
        }

        .toggle-btn.active {
            background: var(--accent);
            color: white !important;
        }

        #toast {
            position: fixed;
            bottom: 2rem;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: #1e293b;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 700;
            font-size: 13px;
            z-index: 1000;
            transition: transform 0.3s;
            border: 1px solid var(--accent);
        }
        #toast.show { transform: translateX(-50%) translateY(0); }
    </style>
</head>
<body class="min-h-screen">

    <div id="toast">Initializing Archive...</div>

    <header class="sticky top-0 z-40 w-full bg-[var(--bg-body)]/90 backdrop-blur-lg border-b border-[var(--border)]">
        <div class="max-w-[1600px] mx-auto px-6 h-16 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <i class="fas fa-database text-indigo-500 text-lg"></i>
                <h1 class="text-sm font-black uppercase tracking-[0.2em]">Imperial <span class="text-indigo-500">Archive</span></h1>
            </div>

            <div class="hidden md:flex flex-1 max-w-2xl mx-12 relative">
                <i class="fas fa-terminal absolute left-4 top-1/2 -translate-y-1/2 text-indigo-500/50 text-xs"></i>
                <input 
                    type="text" id="globalSearch" 
                    placeholder="ENTER QUERY PARAMETERS..."
                    class="w-full input-base rounded-md py-2 pl-10 pr-6 text-xs mono tracking-wider"
                >
            </div>

            <div class="flex items-center gap-2">
                <button id="themeToggle" class="input-base w-8 h-8 rounded flex items-center justify-center">
                    <i class="fas fa-circle-half-stroke" id="themeIcon"></i>
                </button>
                <button id="toggleFilters" class="btn-primary px-4 py-1.5 rounded text-[10px] font-black uppercase tracking-widest flex items-center gap-2">
                    <i class="fas fa-filter"></i> Matrix
                </button>
            </div>
        </div>
    </header>

    <main class="max-w-[1600px] mx-auto">
        <div class="px-6 py-4 flex items-center justify-between border-b border-[var(--border)] bg-[var(--bg-body)]">
            <div id="activeTags" class="flex flex-wrap gap-2"></div>
            <div id="resultsInfo" class="text-[10px] mono font-bold text-[var(--text-secondary)] uppercase">
                Awaiting Data Input...
            </div>
        </div>

        <div id="sourceGrid" class="flex flex-col"></div>

        <div id="emptyState" class="hidden py-40 flex flex-col items-center text-center">
            <i class="fas fa-ghost text-4xl opacity-10 mb-4"></i>
            <h3 class="text-sm font-black uppercase tracking-widest opacity-40">Zero Results In Current Sector</h3>
            <button onclick="clearAllFilters()" class="mt-4 text-indigo-500 font-bold uppercase text-[10px] tracking-widest hover:underline">Flush Archive Buffer</button>
        </div>
    </main>

    <!-- Sidebar Filter -->
    <div id="sidebarOverlay" class="fixed inset-0 bg-black/60 z-[50] opacity-0 pointer-events-none transition-opacity duration-300"></div>
    <aside id="filterSidebar" class="fixed top-0 right-0 h-full w-[380px] z-[60] transform translate-x-full shadow-2xl flex flex-col">
        <div class="p-6 border-b border-[var(--border)] flex items-center justify-between">
            <h2 class="font-black text-xs uppercase tracking-widest">Protocol Matrix</h2>
            <button id="closeSidebar" class="text-[var(--text-secondary)]"><i class="fas fa-times"></i></button>
        </div>

        <div class="flex-1 overflow-y-auto p-6 space-y-8 custom-scrollbar">
            <section class="space-y-4">
                <label class="text-[9px] font-black uppercase tracking-widest text-[var(--text-secondary)]">Classification</label>
                <div class="grid grid-cols-4 gap-1" id="tierFilters">
                    <button data-tier="0" class="tier-btn input-base py-2 rounded text-[10px] font-bold">T0</button>
                    <button data-tier="1" class="tier-btn input-base py-2 rounded text-[10px] font-bold">T1</button>
                    <button data-tier="2" class="tier-btn input-base py-2 rounded text-[10px] font-bold">T2</button>
                    <button data-tier="3" class="tier-btn input-base py-2 rounded text-[10px] font-bold">T3</button>
                </div>
            </section>

            <section class="space-y-3">
                <label class="text-[9px] font-black uppercase tracking-widest text-[var(--text-secondary)]">Active Protocols</label>
                <button id="interestToggle" class="toggle-btn input-base w-full py-2.5 rounded text-[10px] font-black uppercase tracking-widest flex items-center justify-center gap-2">
                    <i class="fas fa-bolt text-yellow-500"></i> High Priority Loot
                </button>
                <button id="coordsToggle" class="toggle-btn input-base w-full py-2.5 rounded text-[10px] font-black uppercase tracking-widest flex items-center justify-center gap-2">
                    <i class="fas fa-crosshairs text-red-500"></i> Localized Data Only
                </button>
            </section>

            <section class="space-y-4">
                <label class="text-[9px] font-black uppercase tracking-widest text-[var(--text-secondary)]">Loot Threshold</label>
                <div class="flex items-center gap-2">
                    <input type="number" id="minLevel" placeholder="MIN" class="w-full input-base rounded py-2 px-3 text-[10px] font-bold mono">
                    <span class="opacity-30">-</span>
                    <input type="number" id="maxLevel" placeholder="MAX" class="w-full input-base rounded py-2 px-3 text-[10px] font-bold mono">
                </div>
            </section>

            <section class="space-y-6">
                <div>
                    <label class="block text-[9px] font-black text-emerald-500 uppercase tracking-widest mb-2">Primary Buff</label>
                    <select id="posStat1" class="w-full input-base rounded px-3 py-2 text-[10px] font-bold outline-none"></select>
                </div>
                <div>
                    <label class="block text-[9px] font-black text-rose-500 uppercase tracking-widest mb-2">Primary Debuff</label>
                    <select id="negStat1" class="w-full input-base rounded px-3 py-2 text-[10px] font-bold outline-none"></select>
                </div>
            </section>

            <section class="space-y-4 pb-12">
                <label class="text-[9px] font-black uppercase tracking-widest text-[var(--text-secondary)]">Authorized Professions</label>
                <div id="professionFilters" class="flex flex-wrap gap-1"></div>
            </section>
        </div>

        <div class="p-4 border-t border-[var(--border)]">
            <button onclick="clearAllFilters()" class="w-full py-3 rounded text-[10px] font-black uppercase tracking-widest bg-red-500/10 text-red-500 hover:bg-red-500 hover:text-white transition-all">Emergency Matrix Reset</button>
        </div>
    </aside>

    <script>
        const MANUAL_INTEREST_LIST = [
            "Adamastor's Faceplate", "Ancient Heart", "Archaic Medallion", "Bat Heart", "Borange Fluff",
            "Cat Food", "Cataratite", "Coalescence", "Colossus' Shard", "Contraband Absinthe",
            "Contraband Hibiscus", "Creepvine Cluster", "Cursed Wings", "Cyclone Blue Leaves",
            "Death Whistle Leaf", "Decaying Heart", "Defiled Luxroot", "Defishious", "Dernic Parasite",
            "Doom Stone", "Draconic Bone Marrow", "Earthly Aura", "Elephelk Trunk", "Enhanced Behaviour Microchip",
            "Enhanced Potential Microchip", "Evolving Spores", "Eye of The Beast", "Fairy Powder",
            "Farcor's Trust", "Fiery Aura", "Flow of Fate", "Gilded Bark", "Glacial Anomaly",
            "Glowing Tree Sap", "Haleva Plant", "Haphazard Serum", "Ice Cream Sandwich", "Kerasot Sporehead",
            "Large Titanium Chunk", "Lashing Hellfire", "Lithoflesh", "Letvus Delight", "Lunar Charm",
            "Luxrooot Cuttings", "Mangrove Root", "Mellow Mango", "Myconid Spores", "Myocardial Leg",
            "Naval Stone", "Nightmare Fuel", "Nivlan Honey", "Obelisk Core", "Plane of Nonexistence",
            "Pride of the Heights", "Prismatic Spores", "Red Mercury", "Remedial Paste", "Ritual Catalyst",
            "Rock-Hard Beak", "Sentient Leukocyte", "Serpent Tongue", "Shattered Dawnlight", "Shrieker's Head",
            "Smokebomb", "Soulbound Cinders", "Tentacle", "Throbbing Avos Heart", "Unicorn Horn",
            "Watery Aura", "Windy Aura", "World Illuminator"
        ];
        const INTEREST_NAMES = new Set(MANUAL_INTEREST_LIST.map(n => n.trim().toLowerCase()));
        
        let SOURCE_DATA = [];
        let GLOBAL_ITEM_LOOKUP = {};
        const STATE = {
            search: "", minLv: 0, maxLv: 115, tiers: new Set(), profs: new Set(),
            posStat1: "", negStat1: "", interestOnly: false, coordsOnly: false, theme: "dark",
            allProfs: [], allPosStats: [], allNegStats: []
        };

        const isNum = (v) => v !== null && v !== undefined && v !== "" && isFinite(Number(v));
        function debounce(func, wait) {
            let timeout; return function(...args) { clearTimeout(timeout); timeout = setTimeout(() => func.apply(this, args), wait); };
        }

        async function loadShopData() {
            let ingredients = {}, drops = {}, htoi = [];
            try {
                const [resI, resD, resH] = await Promise.all([
                    fetch('ingredients.json').then(r => r.ok ? r.json() : {}),
                    fetch('drops.json').then(r => r.ok ? r.json() : {}),
                    fetch('htoi.json').then(r => r.ok ? r.json() : [])
                ]);
                ingredients = resI; drops = resD; htoi = resH;
            } catch (e) { console.error("Data Fetch Error", e); }
            processJsonData(ingredients, drops, htoi);
        }

        function processJsonData(ingredients, dropsMap, htoiArray) {
            GLOBAL_ITEM_LOOKUP = {};
            Object.keys(ingredients).forEach(k => {
                const lower = k.trim().toLowerCase();
                GLOBAL_ITEM_LOOKUP[lower] = { ...ingredients[k], originalName: k };
            });

            const globalMobCoords = {};
            const addMobCoords = (mobName, coords) => {
                if (!mobName) return;
                const key = mobName.toLowerCase().trim();
                if (!globalMobCoords[key]) globalMobCoords[key] = [];
                const arr = Array.isArray(coords) ? coords : [coords].filter(x => x);
                arr.forEach(c => {
                    if (isNum(c.x) && isNum(c.z)) {
                        const nx = Number(c.x), ny = isNum(c.y) ? Number(c.y) : 0, nz = Number(c.z);
                        // Filter out 0,0,0
                        if (Math.abs(nx) + Math.abs(ny) + Math.abs(nz) === 0) return;

                        const obj = { x: nx, y: isNum(c.y) ? ny : null, z: nz };
                        if (!globalMobCoords[key].some(ex => ex.x === obj.x && ex.z === obj.z)) globalMobCoords[key].push(obj);
                    }
                });
            };

            Object.values(dropsMap).forEach(arr => {
                if (Array.isArray(arr)) arr.forEach(d => addMobCoords(d.name, d.details?.coords));
            });
            htoiArray.forEach(h => {
                Object.keys(h).forEach(prop => {
                    if (['name', 'id', 'level'].includes(prop)) return;
                    try {
                        const parsed = JSON.parse(h[prop]);
                        if (Array.isArray(parsed)) parsed.forEach(e => addMobCoords(e.name || e.description, e.location_coords || e.coords));
                    } catch(e) {}
                });
            });

            const sourceRegistry = {};
            const registerSource = (mobName, location, screenshot, itemName) => {
                if (!mobName) return;
                const sName = mobName.trim();
                const sLoc = location?.trim() || "UNDISCLOSED_SECTOR";
                const sourceKey = `${sName.toLowerCase()}|${sLoc.toLowerCase()}`;

                if (!sourceRegistry[sourceKey]) {
                    sourceRegistry[sourceKey] = {
                        name: sName,
                        location: sLoc,
                        screenshots: new Set(),
                        loot: new Set(),
                        coords: globalMobCoords[sName.toLowerCase()] || []
                    };
                }
                if (screenshot) sourceRegistry[sourceKey].screenshots.add(screenshot);
                if (itemName) sourceRegistry[sourceKey].loot.add(itemName.toLowerCase().trim());
            };

            Object.keys(dropsMap).forEach(itemName => {
                const arr = dropsMap[itemName];
                if (Array.isArray(arr)) arr.forEach(d => registerSource(d.name, d.details?.location, d.details?.screenshots, itemName));
            });
            htoiArray.forEach(h => {
                const itemName = h.name;
                Object.keys(h).forEach(prop => {
                    if (['name', 'id', 'level'].includes(prop)) return;
                    try {
                        const parsed = JSON.parse(h[prop]);
                        if (Array.isArray(parsed)) parsed.forEach(e => registerSource(e.name || e.description || prop.toUpperCase(), e.location, e.screenshots, itemName));
                    } catch(e) {}
                });
            });

            const finalSources = Object.values(sourceRegistry).map(src => {
                const lootDetails = Array.from(src.loot).map(lootName => {
                    const info = GLOBAL_ITEM_LOOKUP[lootName] || { originalName: lootName, stats: [], lvl: 0, tier: -1, profs: [] };
                    return {
                        name: info.originalName,
                        level: Number(info.lvl) || 0,
                        tier: info.tier !== undefined ? Number(info.tier) : -1,
                        professions: info.profs || [],
                        stats: info.stats || []
                    };
                });

                const searchStr = [src.name, src.location, ...lootDetails.map(l => l.name)].join(' ').toLowerCase();
                return { ...src, loot: lootDetails, searchStr, screenshots: Array.from(src.screenshots) };
            });

            SOURCE_DATA = finalSources;
            computeState();
            render();
        }

        function computeState() {
            const allItems = Object.values(GLOBAL_ITEM_LOOKUP);
            STATE.allProfs = [...new Set(allItems.flatMap(i => i.profs || []))].sort();
            STATE.allPosStats = [...new Set(allItems.flatMap(i => (i.stats || []).filter(s => s.pos).map(s => s.label)))].sort();
            STATE.allNegStats = [...new Set(allItems.flatMap(i => (i.stats || []).filter(s => !s.pos).map(s => s.label)))].sort();
            
            document.getElementById('posStat1').innerHTML = '<option value="">IGNORE</option>' + STATE.allPosStats.map(s => `<option value="${s}">${s}</option>`).join('');
            document.getElementById('negStat1').innerHTML = '<option value="">IGNORE</option>' + STATE.allNegStats.map(s => `<option value="${s}">${s}</option>`).join('');
            document.getElementById('professionFilters').innerHTML = STATE.allProfs.map(p => `<button data-prof="${p}" class="prof-chip input-base px-2 py-1 rounded text-[8px] font-black uppercase tracking-wider">${p}</button>`).join('');
        }

        function filterData() {
            return SOURCE_DATA.filter(src => {
                if (STATE.search && !src.searchStr.includes(STATE.search.toLowerCase())) return false;
                if (STATE.coordsOnly && src.coords.length === 0) return false;
                if (STATE.interestOnly && !src.loot.some(l => INTEREST_NAMES.has(l.name.toLowerCase()))) return false;

                const hasMatchingLoot = src.loot.some(l => {
                    if (l.level < STATE.minLv || l.level > STATE.maxLv) return false;
                    if (STATE.tiers.size > 0 && !STATE.tiers.has(l.tier.toString())) return false;
                    if (STATE.profs.size > 0 && !l.professions.some(p => STATE.profs.has(p))) return false;
                    if (STATE.posStat1 && !l.stats.some(s => s.label === STATE.posStat1 && s.pos)) return false;
                    if (STATE.negStat1 && !l.stats.some(s => s.label === STATE.negStat1 && !s.pos)) return false;
                    return true;
                });

                const anyLootFilters = STATE.minLv > 0 || STATE.maxLv < 115 || STATE.tiers.size > 0 || STATE.profs.size > 0 || STATE.posStat1 || STATE.negStat1;
                if (anyLootFilters && !hasMatchingLoot) return false;

                return true;
            }).sort((a,b) => a.name.localeCompare(b.name));
        }

        function render() {
            const grid = document.getElementById('sourceGrid'), info = document.getElementById('resultsInfo');
            const data = filterData();
            const view = data.slice(0, 80);
            
            info.textContent = data.length > 0 ? `RECORDS_RETRIEVED: ${data.length}` : "STATUS: NULL_DATA";
            
            if (view.length === 0) {
                grid.innerHTML = "";
                document.getElementById('emptyState').classList.remove('hidden');
            } else {
                document.getElementById('emptyState').classList.add('hidden');
                grid.innerHTML = view.map(src => {
                    const coordsHtml = src.coords.map(c => {
                        const hasY = isNum(c.y);
                        const label = hasY ? `${c.x}, ${c.y}, ${c.z}` : `${c.x}, ${c.z}`;
                        return `<button onclick="copyToClipboard('${c.x}','${c.y}','${c.z}')" class="tactical-btn mono">${label}</button>`;
                    }).join('');

                    const lootRows = src.loot.map(l => `
                        <div class="flex items-center gap-6 py-2 border-t border-[var(--border)] border-dashed last:border-0">
                            <div class="w-1/4">
                                <div class="text-[11px] font-black uppercase text-indigo-400 truncate">${l.name}</div>
                                <div class="flex items-center gap-2 mt-1">
                                    <span class="mono text-[8px] font-bold opacity-50">Lv.${l.level}</span>
                                    <span class="text-[7px] text-yellow-500">${l.tier >= 0 ? Array(l.tier).fill('â˜…').join('') : ''}</span>
                                </div>
                            </div>
                            <div class="flex-1 flex flex-wrap gap-2">
                                ${l.stats.slice(0, 8).map(s => `
                                    <div class="stat-badge mono ${s.pos ? 'stat-positive' : 'stat-negative'}">
                                        ${s.label}: ${s.value}
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `).join('');

                    return `
                    <div class="source-row px-6 py-5 flex gap-8">
                        <div class="w-1/4 flex flex-col justify-center">
                            <div class="flex items-center gap-3">
                                <h3 class="text-sm font-black uppercase text-white tracking-tight">${src.name}</h3>
                                ${src.screenshots.length > 0 ? `<a href="${src.screenshots[0].split(',')[0]}" target="_blank" class="text-indigo-500 hover:text-white"><i class="fas fa-camera text-[10px]"></i></a>` : ''}
                            </div>
                            <p class="text-[9px] mono text-[var(--text-secondary)] mt-1 uppercase tracking-widest">${src.location}</p>
                        </div>

                        <div class="w-1/5 flex flex-wrap items-center gap-1">
                            ${coordsHtml || '<span class="text-[9px] mono opacity-10 uppercase tracking-tighter">no_loc_data</span>'}
                        </div>

                        <div class="flex-1 space-y-1">
                            ${lootRows}
                        </div>
                    </div>
                `}).join('');
            }
            renderActiveTags();
        }

        function renderActiveTags() {
            const container = document.getElementById('activeTags');
            const tags = [];
            if (STATE.search) tags.push({ id: 'search', val: STATE.search });
            if (STATE.interestOnly) tags.push({ id: 'interest', val: 'TARGET_PRIORITY' });
            if (STATE.coordsOnly) tags.push({ id: 'coords', val: 'LOCALIZED_ONLY' });
            STATE.tiers.forEach(t => tags.push({ id: 'tier-'+t, val: `TIER_${t}` }));
            STATE.profs.forEach(p => tags.push({ id: 'prof-'+p, val: p }));

            container.innerHTML = tags.map(t => `
                <div class="flex items-center gap-2 px-3 py-1 bg-indigo-500/10 text-indigo-500 border border-indigo-500/20 rounded-md text-[9px] font-black mono uppercase">
                    ${t.val}
                    <button onclick="removeFilter('${t.id}')" class="hover:text-white transition-colors"><i class="fas fa-times"></i></button>
                </div>
            `).join('');
        }

        function copyToClipboard(x, y, z) {
            const hasY = isNum(y) && y !== 'null' && y !== 'undefined';
            const cmd = hasY ? `/compass ${x}, ${y}, ${z}` : `/compass ${x}, ${z}`;
            const el = document.createElement('textarea'); 
            el.value = cmd; el.style.position = "fixed"; el.style.left = "-9999px"; 
            document.body.appendChild(el); el.select();
            try {
                document.execCommand('copy'); 
                const t = document.getElementById('toast'); 
                t.textContent = "UPLINK: " + cmd; 
                t.classList.add('show');
                setTimeout(() => t.classList.remove('show'), 2000);
            } catch(e) {}
            document.body.removeChild(el);
        }

        function removeFilter(id) {
            if (id === 'search') { STATE.search = ""; document.getElementById('globalSearch').value = ""; }
            else if (id === 'interest') { STATE.interestOnly = false; document.getElementById('interestToggle').classList.remove('active'); }
            else if (id === 'coords') { STATE.coordsOnly = false; document.getElementById('coordsToggle').classList.remove('active'); }
            else if (id.startsWith('tier-')) { STATE.tiers.delete(id.split('-')[1]); document.querySelectorAll('.tier-btn').forEach(b => { if(b.dataset.tier == id.split('-')[1]) b.classList.remove('active'); }); }
            else if (id.startsWith('prof-')) { STATE.profs.delete(id.split('-')[1]); document.querySelectorAll('.prof-chip').forEach(b => { if(b.dataset.prof == id.split('-')[1]) b.classList.remove('active'); }); }
            render();
        }

        function clearAllFilters() {
            STATE.search = ""; STATE.tiers.clear(); STATE.profs.clear(); 
            STATE.interestOnly = false; STATE.coordsOnly = false;
            STATE.minLv = 0; STATE.maxLv = 115;
            document.getElementById('globalSearch').value = "";
            document.querySelectorAll('.active').forEach(e => e.classList.remove('active'));
            document.querySelectorAll('input[type="number"]').forEach(i => i.value = "");
            render();
        }

        document.getElementById('toggleFilters').addEventListener('click', () => {
            document.getElementById('filterSidebar').classList.add('open');
            document.getElementById('sidebarOverlay').classList.replace('opacity-0', 'opacity-100');
            document.getElementById('sidebarOverlay').classList.remove('pointer-events-none');
        });
        document.getElementById('closeSidebar').addEventListener('click', () => {
            document.getElementById('filterSidebar').classList.remove('open');
            document.getElementById('sidebarOverlay').classList.replace('opacity-100', 'opacity-0');
            document.getElementById('sidebarOverlay').classList.add('pointer-events-none');
        });
        document.getElementById('sidebarOverlay').addEventListener('click', () => document.getElementById('closeSidebar').click());
        document.getElementById('globalSearch').addEventListener('input', debounce(e => { STATE.search = e.target.value; render(); }, 250));
        document.getElementById('minLevel').addEventListener('input', e => { STATE.minLv = Number(e.target.value) || 0; render(); });
        document.getElementById('maxLevel').addEventListener('input', e => { STATE.maxLv = Number(e.target.value) || 115; render(); });
        document.getElementById('posStat1').addEventListener('change', e => { STATE.posStat1 = e.target.value; render(); });
        document.getElementById('negStat1').addEventListener('change', e => { STATE.negStat1 = e.target.value; render(); });
        
        document.querySelectorAll('.tier-btn').forEach(b => b.addEventListener('click', () => {
            const t = b.dataset.tier; if (STATE.tiers.has(t)) STATE.tiers.delete(t); else STATE.tiers.add(t);
            b.classList.toggle('active'); render();
        }));

        document.getElementById('professionFilters').addEventListener('click', e => {
            const b = e.target.closest('.prof-chip'); if (!b) return;
            const p = b.dataset.prof; if (STATE.profs.has(p)) STATE.profs.delete(p); else STATE.profs.add(p);
            b.classList.toggle('active'); render();
        });

        document.getElementById('interestToggle').addEventListener('click', e => {
            STATE.interestOnly = !STATE.interestOnly; e.currentTarget.classList.toggle('active'); render();
        });
        document.getElementById('coordsToggle').addEventListener('click', e => {
            STATE.coordsOnly = !STATE.coordsOnly; e.currentTarget.classList.toggle('active'); render();
        });

        document.getElementById('themeToggle').addEventListener('click', () => {
            const body = document.body; const icon = document.getElementById('themeIcon');
            if (body.classList.contains('light')) {
                body.classList.remove('light'); icon.classList.replace('fa-circle-half-stroke', 'fa-circle-half-stroke');
            } else {
                body.classList.add('light');
            }
        });

        window.onload = loadShopData;
    </script>
</body>
</html>
