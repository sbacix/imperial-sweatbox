<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Great Database</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap');

        :root {
            --bg-main: #121214; 
            --bg-card: #1c1c1f; 
            --bg-input: #09090b;
            --text-main: #ececec;
            --text-dim: #71717a;
            --border-main: #2d2d31;
            
            --zest-indigo: rgba(99, 102, 241, 0.5);
            --zest-purple: rgba(168, 85, 247, 0.5);
            --zest-cyan: rgba(34, 211, 238, 0.5);
        }

        body.light {
            --bg-main: #f4f4f5; 
            --bg-card: #ffffff; 
            --bg-input: #fafafa;
            --text-main: #18181b;
            --text-dim: #a1a1aa;
            --border-main: #e4e4e7;
            
            --zest-indigo: rgba(99, 102, 241, 0.2);
            --zest-purple: rgba(168, 85, 247, 0.2);
            --zest-cyan: rgba(34, 211, 238, 0.2);
        }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: var(--bg-main);
            color: var(--text-main);
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: var(--bg-main);
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: var(--border-main);
            border-radius: 10px;
        }

        .stat-pos { color: #10b981; }
        .stat-neg { color: #f43f5e; }

        @keyframes glowCycle {
            0% { box-shadow: 0 15px 35px -10px var(--zest-indigo); border-color: #6366f1; }
            33% { box-shadow: 0 15px 35px -10px var(--zest-purple); border-color: #a855f7; }
            66% { box-shadow: 0 15px 35px -10px var(--zest-cyan); border-color: #22d3ee; }
            100% { box-shadow: 0 15px 35px -10px var(--zest-indigo); border-color: #6366f1; }
        }

        @keyframes titleCycle {
            0% { color: #a855f7; } 
            25% { color: #ec4899; } 
            50% { color: #22d3ee; } 
            75% { color: #f472b6; }
            100% { color: #a855f7; } 
        }

        .zest-card {
            background: var(--bg-card);
            border: 1px solid var(--border-main);
            transition: all 0.3s cubic-bezier(0.23, 1, 0.32, 1);
            position: relative;
        }

        .zest-card:hover {
            transform: translateY(-8px);
            animation: glowCycle 4s infinite linear;
            z-index: 10;
        }

        .animated-title {
            animation: titleCycle 6s infinite ease-in-out;
        }

        .glass-header {
            background: var(--bg-main);
            backdrop-filter: blur(16px);
            border-bottom: 1px solid var(--border-main);
            opacity: 0.98;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        header.compact {
            padding-top: 0.75rem;
            padding-bottom: 0.75rem;
        }

        header.compact .branding-large {
            display: none;
        }

        header.compact .branding-small {
            display: flex;
        }

        #filterDrawer {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease-in-out, opacity 0.3s ease;
            opacity: 0;
        }

        #filterDrawer.open {
            max-height: 1200px;
            opacity: 1;
        }

        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        select {
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%2371717a'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 1rem;
        }

        #toast {
            visibility: hidden;
            min-width: 280px;
            background: var(--bg-card);
            color: var(--text-main);
            text-align: center;
            border-radius: 12px;
            padding: 16px;
            position: fixed;
            z-index: 100;
            left: 50%;
            transform: translateX(-50%);
            bottom: 40px;
            font-size: 14px;
            font-weight: 800;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
            border: 1px solid #4f46e5;
            opacity: 0;
            transition: opacity 0.3s, bottom 0.3s;
        }

        #toast.show {
            visibility: visible;
            opacity: 1;
            bottom: 50px;
        }

        .zest-btn {
            background-color: var(--bg-input);
            border: 1px solid var(--border-main);
            color: var(--text-main);
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .zest-btn:hover {
            filter: brightness(1.1);
            transform: scale(1.02);
            border-color: #6366f1;
        }

        .interest-toggle.active, .coords-toggle.active {
            background-color: #4f46e5;
            border-color: #6366f1;
            color: white;
        }

        .bg-custom-main { background-color: var(--bg-main); }
        .bg-custom-card { background-color: var(--bg-card); }
        .bg-custom-input { background-color: var(--bg-input); }
        .border-custom { border-color: var(--border-main); }
        .text-custom-main { color: var(--text-main); }
        .text-custom-dim { color: var(--text-dim); }
    </style>
</head>
<body class="min-h-screen custom-scrollbar pb-20">

    <div id="toast">Copied Compass Command!</div>

    <header id="mainHeader" class="sticky top-0 z-50 glass-header">
        <!-- Developer Credit Watermark -->
        <div class="absolute top-2 left-4 text-[9px] font-black uppercase tracking-widest text-zinc-600 opacity-60 z-10">
            <span class="animated-title">Slopcoded</span> for your sake by <span class="animated-title">Sbacix</span>
        </div>

        <div class="max-w-[1700px] mx-auto px-6 py-6 transition-all duration-300" id="headerContent">
            
            <!-- Branding Row (Large) -->
            <div class="flex flex-col items-center text-center mb-6 branding-large">
                <div class="bg-gradient-to-tr from-indigo-500 to-cyan-400 p-3 rounded-2xl shadow-2xl mb-2">
                    <i class="fas fa-database text-white text-3xl"></i>
                </div>
                <h1 class="text-3xl lg:text-6xl font-black tracking-tighter leading-tight text-custom-main uppercase">
                    The Great <span class="animated-title">Database</span>
                </h1>
                <p class="text-[11px] font-black text-indigo-400 uppercase tracking-[0.5em] mt-1">Property of Imperial</p>
            </div>

            <!-- Dashboard Interaction Row -->
            <div class="grid grid-cols-1 lg:grid-cols-3 items-center gap-6">
                
                <!-- Left: Branding Small & Search -->
                <div class="flex items-center gap-4 order-2 lg:order-1">
                    <div class="hidden branding-small items-center gap-2 shrink-0">
                        <i class="fas fa-database text-indigo-500 text-xl"></i>
                        <span class="text-xs font-black uppercase animated-title hidden sm:inline">The Database</span>
                    </div>
                    <div class="relative flex-1">
                        <i class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-zinc-500 text-base"></i>
                        <input 
                            type="text" 
                            id="globalSearch"
                            placeholder="Search names, mobs, or telemetry..."
                            class="w-full bg-custom-input border border-custom rounded-xl py-3.5 pl-12 pr-4 focus:outline-none focus:ring-2 focus:ring-indigo-500/50 transition-all text-sm text-custom-main placeholder:text-zinc-500"
                        >
                    </div>
                </div>

                <div class="hidden lg:block lg:order-2 branding-large"></div>

                <!-- Right: Theme & Dashboard Toggles -->
                <div class="flex justify-end items-center gap-3 order-3">
                    <button id="themeToggle" class="zest-btn flex items-center justify-center w-12 h-12 rounded-xl text-indigo-500 shadow-sm" title="Toggle Theme">
                        <i class="fas fa-moon text-lg" id="themeIcon"></i>
                    </button>
                    <button id="toggleFilters" class="zest-btn flex items-center gap-3 px-6 py-3 rounded-xl font-black text-xs uppercase tracking-widest whitespace-nowrap">
                        <i class="fas fa-sliders-h text-indigo-500"></i>
                        <span>Dashboard</span>
                        <i id="chevron" class="fas fa-chevron-down text-[10px] ml-1 transition-transform"></i>
                    </button>
                </div>
            </div>

            <!-- Drawer -->
            <div id="filterDrawer" class="mt-6 border-t border-custom">
                <div class="py-8 space-y-8">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                        <div class="space-y-4">
                            <label class="block text-xs font-black text-custom-dim uppercase tracking-widest">Level Range</label>
                            <div class="flex items-center gap-3">
                                <input type="number" id="minLevel" value="0" class="w-full bg-custom-input border border-custom rounded-lg py-3 px-4 text-sm font-bold outline-none focus:border-indigo-500">
                                <span class="text-custom-dim font-bold">—</span>
                                <input type="number" id="maxLevel" value="115" class="w-full bg-custom-input border border-custom rounded-lg py-3 px-4 text-sm font-bold outline-none focus:border-indigo-500">
                            </div>
                        </div>
                        <div class="space-y-4">
                            <label class="block text-xs font-black text-custom-dim uppercase tracking-widest">Ingredient Tiers</label>
                            <div class="flex gap-2" id="tierFilters">
                                <button data-tier="0" class="tier-btn flex-1 py-3 rounded-lg border border-custom bg-custom-input text-xs font-black uppercase tracking-widest">T0</button>
                                <button data-tier="1" class="tier-btn flex-1 py-3 rounded-lg border border-custom bg-custom-input text-xs font-black uppercase tracking-widest">T1</button>
                                <button data-tier="2" class="tier-btn flex-1 py-3 rounded-lg border border-custom bg-custom-input text-xs font-black uppercase tracking-widest">T2</button>
                                <button data-tier="3" class="tier-btn flex-1 py-3 rounded-lg border border-custom bg-custom-input text-xs font-black uppercase tracking-widest">T3</button>
                            </div>
                        </div>
                        <div class="space-y-4">
                            <label class="block text-xs font-black text-custom-dim uppercase tracking-widest text-indigo-400">Curated Filters</label>
                            <div class="flex gap-3">
                                <button id="interestToggle" class="interest-toggle zest-btn flex-1 py-3 rounded-lg text-xs font-black uppercase tracking-widest">
                                    <i class="fas fa-star mr-2"></i> INTEREST
                                </button>
                                <button id="coordsToggle" class="coords-toggle zest-btn flex-1 py-3 rounded-lg text-xs font-black uppercase tracking-widest">
                                    <i class="fas fa-crosshairs mr-2"></i> COORDS
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 pt-4 border-t border-custom border-opacity-30">
                        <div class="space-y-4">
                            <label class="block text-xs font-black text-custom-dim uppercase tracking-widest">Professions</label>
                            <div id="professionFilters" class="flex flex-wrap gap-2 max-h-32 overflow-y-auto pr-2 custom-scrollbar"></div>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="space-y-4">
                                <label class="block text-xs font-black text-emerald-500 uppercase tracking-widest">Positive Stats</label>
                                <select id="posStat1" class="w-full bg-custom-input border border-custom rounded-lg py-3 px-4 text-xs font-black text-emerald-500 outline-none"><option value="">Stat 1</option></select>
                            </div>
                            <div class="space-y-4">
                                <label class="block text-xs font-black text-rose-500 uppercase tracking-widest">Negative Stats</label>
                                <select id="negStat1" class="w-full bg-custom-input border border-custom rounded-lg py-3 px-4 text-xs font-black text-rose-500 outline-none"><option value="">Stat 1</option></select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <main class="max-w-[1700px] mx-auto p-6 lg:p-10">
        <div id="activeTags" class="flex flex-wrap gap-2 mb-10 min-h-[30px]"></div>
        <div id="ingredientGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6"></div>

        <div id="emptyState" class="hidden flex flex-col items-center justify-center py-48 text-custom-dim">
            <div class="w-24 h-24 bg-custom-input rounded-3xl flex items-center justify-center mb-6 shadow-xl border border-custom">
                <i class="fas fa-search text-4xl opacity-30"></i>
            </div>
            <p class="text-xl font-black uppercase tracking-widest mb-2">No Records Found</p>
            <button onclick="clearAllFilters()" class="text-indigo-500 hover:text-indigo-400 text-xs font-black uppercase tracking-[0.3em] underline">Reset Inventory</button>
        </div>
    </main>

    <script>
        /**
         * ITEMS OF INTEREST - EDIT THIS LIST MANUALLY
         */
        const MANUAL_INTEREST_LIST = [
            "Adamastor's Faceplate", "Ancient Heart", "Archaic Medallion", "Bat Heart", "Borange Fluff",
            "Cat Food", "Cataratite", "Coalescence", "Colossus' Shard", "Contraband Absinthe",
            "Contraband Hibiscus", "Creepvine Cluster", "Cursed Wings", "Cyclone Blue Leaves",
            "Death Whistle Leaf", "Decaying Heart", "Defiled Luxroot", "Defishious", "Dernic Parasite",
            "Doom Stone", "Draconic Bone Marrow", "Earthly Aura", "Elephelk Trunk", "Enhanced Behaviour Microchip",
            "Enhanced Potential Microchip", "Evolving Spores", "Eye of The Beast", "Fairy Powder",
            "Farcor's Trust", "Fiery Aura", "Flow of Fate", "Gilded Bark", "Glacial Anomaly",
            "Glowing Tree Sap", "Haleva Plant", "Haphazard Serum", "Ice Cream Sandwich", "Kerasot Sporehead",
            "Large Titanium Chunk", "Lashing Hellfire", "Lithoflesh", "Letvus Delight", "Lunar Charm",
            "Luxrooot Cuttings", "Mangrove Root", "Mellow Mango", "Myconid Spores", "Myocardial Leg",
            "Naval Stone", "Nightmare Fuel", "Nivlan Honey", "Obelisk Core", "Plane of Nonexistence",
            "Pride of the Heights", "Prismatic Spores", "Red Mercury", "Remedial Paste", "Ritual Catalyst",
            "Rock-Hard Beak", "Sentient Leukocyte", "Serpent Tongue", "Shattered Dawnlight", "Shrieker's Head",
            "Smokebomb", "Soulbound Cinders", "Tentacle", "Throbbing Avos Heart", "Unicorn Horn",
            "Watery Aura", "Windy Aura", "World Illuminator"
        ];

        const INTEREST_NAMES = new Set(MANUAL_INTEREST_LIST.map(n => n.trim().toLowerCase()));

        let RAW_DATA = [];

        const STATE = {
            search: "", minLv: 0, maxLv: 115, tiers: new Set(), profs: new Set(),
            posStat1: "", negStat1: "", interestOnly: false, coordsOnly: false, theme: "dark",
            allProfs: [], allPosStats: [], allNegStats: []
        };

        async function loadShopData() {
            try {
                const [ingredientsRes, dropsRes] = await Promise.all([
                    fetch('ingredients.json'),
                    fetch('drops.json')
                ]);
                if (!ingredientsRes.ok || !dropsRes.ok) throw new Error("Fetch failed");
                const ingredientsJson = await ingredientsRes.json();
                const dropsJson = await dropsRes.json();
                processJsonData(ingredientsJson, dropsJson);
            } catch (error) {
                console.error(error);
                showToast("System Load Failure");
            }
        }

        /**
         * Normalizes data merging to handle whitespace and casing issues in JSON keys
         * and implements coordinate sharing between mobs.
         */
        function processJsonData(ingredients, dropsMap) {
            const processed = [];
            
            // 1. Create normalized maps for reliable lookup
            const normIngredients = {};
            Object.keys(ingredients).forEach(k => normIngredients[k.trim().toLowerCase()] = { ...ingredients[k], originalName: k });
            
            const normDrops = {};
            Object.keys(dropsMap).forEach(k => normDrops[k.trim().toLowerCase()] = dropsMap[k]);

            // 2. Build a Global Telemetry Database (Shared Coords across all items by Mob Name)
            const sharedTelemetry = {}; // Map of mobName -> Array of coordinate objects

            Object.values(dropsMap).forEach(dropArray => {
                if (!Array.isArray(dropArray)) return;
                dropArray.forEach(d => {
                    if (!d.name) return;
                    const mobKey = d.name.trim().toLowerCase();
                    if (!sharedTelemetry[mobKey]) sharedTelemetry[mobKey] = [];
                    
                    if (d.details && d.details.coords) {
                        const rawCoords = d.details.coords;
                        const checkNonZero = (c) => Number(c.x) !== 0 || Number(c.y) !== 0 || Number(c.z) !== 0;

                        const addCoord = (c) => {
                            if (checkNonZero(c)) {
                                const coordStr = `${Number(c.x)},${Number(c.y)},${Number(c.z)}`;
                                // Check for existing to avoid duplicates
                                if (!sharedTelemetry[mobKey].find(existing => `${existing.x},${existing.y},${existing.z}` === coordStr)) {
                                    sharedTelemetry[mobKey].push({ x: Number(c.x), y: Number(c.y), z: Number(c.z) });
                                }
                            }
                        };

                        if (Array.isArray(rawCoords)) rawCoords.forEach(addCoord);
                        else addCoord(rawCoords);
                    }
                });
            });

            // 3. Unified key set from both files
            const allKeys = new Set([
                ...Object.keys(normIngredients),
                ...Object.keys(normDrops)
            ]);

            for (const key of allKeys) {
                const ingData = normIngredients[key] || {};
                const dropEntries = normDrops[key] || [];

                const item = {
                    name: ingData.originalName || Object.keys(dropsMap).find(orig => orig.trim().toLowerCase() === key) || key,
                    tier: ingData.tier !== undefined ? ingData.tier : -1,
                    level: ingData.lvl || 0,
                    professions: ingData.profs || [],
                    stats: ingData.stats || [],
                    drops: []
                };

                if (Array.isArray(dropEntries)) {
                    item.drops = dropEntries.map(d => {
                        let loc = d.details ? (d.details.location || "") : "";
                        let screenshots = d.details ? (d.details.screenshots || "") : "";
                        
                        // Handshake Logic: Pull coordinates from the shared telemetry database
                        const mobKey = (d.name || "").trim().toLowerCase();
                        let validCoords = sharedTelemetry[mobKey] || [];

                        return { 
                            name: d.name || "Unknown Source", 
                            location: loc, 
                            allCoords: validCoords,
                            screenshots: screenshots 
                        };
                    });
                }
                processed.push(item);
            }

            RAW_DATA = processed;
            computeDynamicState();
            initDynamicUI();
            render();
        }

        function computeDynamicState() {
            STATE.allProfs = [...new Set(RAW_DATA.flatMap(i => i.professions))].sort();
            STATE.allPosStats = [...new Set(RAW_DATA.flatMap(i => i.stats.filter(s => s.pos).map(s => s.label)))].sort();
            STATE.allNegStats = [...new Set(RAW_DATA.flatMap(i => i.stats.filter(s => !s.pos).map(s => s.label)))].sort();
        }

        function initDynamicUI() {
            const profContainer = document.getElementById('professionFilters');
            profContainer.innerHTML = STATE.allProfs.map(p => `<button data-prof="${p}" class="prof-chip zest-btn px-3 py-2 rounded-lg text-[10px] font-black uppercase tracking-widest whitespace-nowrap">${p}</button>`).join('');
            
            const ps = document.getElementById('posStat1');
            const ns = document.getElementById('negStat1');
            ps.innerHTML = '<option value="">Stat 1</option>';
            ns.innerHTML = '<option value="">Stat 1</option>';
            STATE.allPosStats.forEach(s => ps.innerHTML += `<option value="${s}">${s}</option>`);
            STATE.allNegStats.forEach(s => ns.innerHTML += `<option value="${s}">${s}</option>`);
        }

        function filterData() {
            const query = STATE.search.toLowerCase().trim();
            const filtered = RAW_DATA.filter(item => {
                const matchesSearch = !query || 
                    item.name.toLowerCase().includes(query) || 
                    item.professions.some(p => p.toLowerCase().includes(query)) || 
                    item.stats.some(s => s.label.toLowerCase().includes(query)) ||
                    item.drops.some(d => d.name.toLowerCase().includes(query) || d.location.toLowerCase().includes(query));

                const matchesLevel = item.level >= STATE.minLv && item.level <= STATE.maxLv;
                const matchesTier = STATE.tiers.size === 0 || STATE.tiers.has(item.tier.toString());
                const matchesProf = STATE.profs.size === 0 || item.professions.some(p => STATE.profs.has(p));
                const matchesStatP = !STATE.posStat1 || item.stats.some(s => s.label === STATE.posStat1 && s.pos);
                const matchesStatN = !STATE.negStat1 || item.stats.some(s => s.label === STATE.negStat1 && !s.pos);
                const matchesInterest = !STATE.interestOnly || INTEREST_NAMES.has(item.name.trim().toLowerCase());
                const matchesCoords = !STATE.coordsOnly || item.drops.some(d => d.allCoords.length > 0);
                
                return matchesSearch && matchesLevel && matchesTier && matchesProf && matchesStatP && matchesStatN && matchesInterest && matchesCoords;
            });

            const anyFilterActive = STATE.search !== "" || 
                                   STATE.tiers.size > 0 || 
                                   STATE.profs.size > 0 || 
                                   STATE.interestOnly || 
                                   STATE.coordsOnly || 
                                   STATE.minLv !== 0 || 
                                   STATE.maxLv !== 115 || 
                                   STATE.posStat1 !== "" || 
                                   STATE.negStat1 !== "";

            if (!anyFilterActive) {
                return filtered.sort(() => 0.5 - Math.random()).slice(0, 50);
            }

            return filtered.sort((a, b) => a.name.localeCompare(b.name));
        }

        function render() {
            const grid = document.getElementById('ingredientGrid');
            const data = filterData();
            if (data.length === 0) {
                grid.innerHTML = "";
                document.getElementById('emptyState').classList.remove('hidden');
            } else {
                document.getElementById('emptyState').classList.add('hidden');
                grid.innerHTML = data.map((item, idx) => `
                    <div class="zest-card rounded-[1.5rem] p-4 flex flex-col gap-4 shadow-sm">
                        <div class="flex justify-between items-start">
                            <div class="overflow-hidden">
                                <h3 class="text-sm font-black text-custom-main leading-tight uppercase tracking-tight mb-1 truncate">${item.name}</h3>
                                <div class="flex items-center gap-2">
                                    <span class="text-[9px] font-black text-indigo-400 bg-indigo-500/10 px-1.5 py-0.5 rounded leading-none">LV ${item.level}</span>
                                    <div class="flex gap-0.5 text-amber-500">
                                        ${item.tier >= 0 ? Array(item.tier).fill(0).map(() => `<i class="fas fa-star text-[8px]"></i>`).join('') : '<span class="text-[7px] text-zinc-600 font-bold tracking-tighter">UNRANKED</span>'}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="space-y-3">
                            <div class="space-y-1">
                                <p class="text-[8px] font-black text-custom-dim uppercase tracking-widest border-b border-custom pb-1 mb-1">Properties</p>
                                ${item.stats.length === 0 ? '<p class="text-[10px] italic text-zinc-700">No telemetry.</p>' : item.stats.map(s => `
                                    <div class="flex justify-between text-[12px] font-bold py-0.5 border-b border-custom border-opacity-20 last:border-0">
                                        <span class="text-custom-dim">${s.label}</span>
                                        <span class="${s.pos ? 'stat-pos' : 'stat-neg'}">${s.value}</span>
                                    </div>
                                `).join('')}
                            </div>

                            <div class="space-y-1.5">
                                <p class="text-[8px] font-black text-custom-dim uppercase tracking-widest border-b border-custom pb-1 mb-1">Telemetry Sources</p>
                                ${item.drops.length === 0 ? `<p class="text-[10px] italic text-custom-dim opacity-40">No sources found.</p>` : item.drops.map(drop => {
                                    const mainScreenshot = drop.screenshots ? drop.screenshots.split(',')[0].trim() : null;
                                    return `
                                    <div class="space-y-2 bg-custom-main bg-opacity-30 p-3 rounded-lg border border-custom border-opacity-30">
                                        <div class="flex justify-between items-start gap-2">
                                            <div class="overflow-hidden">
                                                <p class="text-custom-main font-bold text-xs truncate leading-tight">${drop.name}</p>
                                                <p class="text-custom-dim text-[8px] font-bold uppercase tracking-tight truncate">${drop.location || 'Deep Space'}</p>
                                            </div>
                                            ${mainScreenshot ? `
                                                <a href="${mainScreenshot}" target="_blank" class="zest-btn p-2 rounded-lg !bg-pink-500 !text-white !border-pink-400 text-[10px] shadow-sm hover:scale-110 transition-transform" title="Intel View">
                                                    <i class="fas fa-image"></i>
                                                </a>
                                            ` : ''}
                                        </div>
                                        ${drop.allCoords.map(c => `
                                            <div 
                                                onclick="copyToClipboard('${c.x}', '${c.y}', '${c.z}')"
                                                class="zest-btn flex items-center justify-center gap-2 bg-indigo-600 !border-indigo-400 !text-white hover:bg-indigo-500 px-3 py-2 rounded-lg cursor-pointer shadow-md group mt-1"
                                            >
                                                <i class="fas fa-crosshairs text-base group-hover:rotate-90 transition-transform"></i>
                                                <span class="font-black text-[12px] font-mono tracking-widest truncate">${c.x}, ${c.y}, ${c.z}</span>
                                            </div>
                                        `).join('')}
                                    </div>
                                `;}).join('')}
                            </div>
                        </div>

                        <div class="mt-auto pt-2 border-t border-custom border-opacity-50 flex flex-wrap gap-1">
                            ${item.professions.length === 0 ? '<span class="text-[7px] text-zinc-800 font-bold uppercase">Generic</span>' : item.professions.map(p => `
                                <span class="text-[7px] text-custom-dim font-black px-1.5 py-0.5 rounded-md bg-custom-input border border-custom uppercase tracking-tighter">${p}</span>
                            `).join('')}
                        </div>
                    </div>
                `).join('');
            }
            renderTags();
        }

        function renderTags() {
            const container = document.getElementById('activeTags');
            const tags = [];
            if (STATE.search) tags.push({ id: 'search', label: `SEARCH: ${STATE.search}` });
            if (STATE.interestOnly) tags.push({ id: 'interest', label: `★ INTEREST` });
            if (STATE.coordsOnly) tags.push({ id: 'coords', label: `⌖ COORDS` });
            if (STATE.minLv > 0 || STATE.maxLv < 115) tags.push({ id: 'lv', label: `L${STATE.minLv}-${STATE.maxLv}` });
            STATE.tiers.forEach(t => tags.push({ id: `tier-${t}`, label: `T${t}` }));
            STATE.profs.forEach(p => tags.push({ id: `prof-${p}`, label: p }));

            container.innerHTML = tags.map(t => `
                <div class="flex items-center gap-2 px-3 py-1.5 bg-custom-card border border-custom text-custom-main rounded-lg text-[10px] font-black uppercase tracking-widest shadow-md">
                    ${t.label}
                    <button onclick="removeFilter('${t.id}')" class="hover:text-indigo-400 transition-colors"><i class="fas fa-times"></i></button>
                </div>
            `).join('');
        }

        function copyToClipboard(x, y, z) {
            const command = `/compass ${x}, ${y}, ${z}`;
            const ta = document.createElement("textarea");
            ta.value = command; ta.style.position = "fixed"; ta.style.left = "-9999px";
            document.body.appendChild(ta); ta.select();
            try { document.execCommand('copy'); showToast(`COPIED: ${command}`); } catch (err) {}
            document.body.removeChild(ta);
        }

        function showToast(msg) {
            const t = document.getElementById("toast");
            t.textContent = msg; t.classList.add("show");
            setTimeout(() => t.classList.remove("show"), 2500);
        }

        function toggleTheme() {
            const body = document.body;
            const icon = document.getElementById('themeIcon');
            if (STATE.theme === "dark") {
                STATE.theme = "light";
                body.classList.add('light');
                icon.classList.remove('fa-moon');
                icon.classList.add('fa-sun');
            } else {
                STATE.theme = "dark";
                body.classList.remove('light');
                icon.classList.remove('fa-sun');
                icon.classList.add('fa-moon');
            }
        }

        function handleScroll() {
            const header = document.getElementById('mainHeader');
            const content = document.getElementById('headerContent');
            const drawer = document.getElementById('filterDrawer');
            const chevron = document.getElementById('chevron');

            if (window.scrollY > 50) {
                header.classList.add('compact');
                content.classList.remove('py-6');
                content.classList.add('py-2');
                if (drawer.classList.contains('open')) {
                    drawer.classList.remove('open');
                    chevron.style.transform = 'rotate(0deg)';
                }
            } else {
                header.classList.remove('compact');
                content.classList.remove('py-2');
                content.classList.add('py-6');
            }
        }

        function removeFilter(id) {
            if (id === 'search') { STATE.search = ""; document.getElementById('globalSearch').value = ""; }
            else if (id === 'interest') { STATE.interestOnly = false; document.getElementById('interestToggle').classList.remove('active'); }
            else if (id === 'coords') { STATE.coordsOnly = false; document.getElementById('coordsToggle').classList.remove('active'); }
            else if (id === 'lv') { STATE.minLv = 0; STATE.maxLv = 115; document.getElementById('minLevel').value = 0; document.getElementById('maxLevel').value = 115; }
            else if (id.startsWith('tier-')) { 
                const t = id.split('-')[1]; 
                STATE.tiers.delete(t); 
                const btn = document.querySelector(`.tier-btn[data-tier="${t}"]`);
                if (btn) btn.classList.remove('bg-indigo-600', 'text-white');
            }
            else if (id.startsWith('prof-')) { 
                const p = id.split('-')[1]; 
                STATE.profs.delete(p); 
                const chip = document.querySelector(`.prof-chip[data-prof="${p}"]`); 
                if (chip) chip.classList.remove('bg-indigo-600', 'text-white'); 
            }
            render();
        }

        function clearAllFilters() {
            STATE.search = ""; STATE.minLv = 0; STATE.maxLv = 115; STATE.interestOnly = false; STATE.coordsOnly = false;
            STATE.tiers.clear(); STATE.profs.clear(); STATE.posStat1 = ""; STATE.negStat1 = "";
            document.getElementById('globalSearch').value = "";
            document.getElementById('interestToggle').classList.remove('active');
            document.getElementById('coordsToggle').classList.remove('active');
            document.getElementById('minLevel').value = 0;
            document.getElementById('maxLevel').value = 115;
            document.querySelectorAll('.tier-btn, .prof-chip').forEach(el => el.classList.remove('bg-indigo-600', 'text-white'));
            document.querySelectorAll('select').forEach(s => s.value = "");
            render();
        }

        window.addEventListener('DOMContentLoaded', () => {
            loadShopData();
            window.addEventListener('scroll', handleScroll);
            document.getElementById('themeToggle').addEventListener('click', toggleTheme);
            document.getElementById('toggleFilters').addEventListener('click', () => {
                const isOpen = document.getElementById('filterDrawer').classList.toggle('open');
                document.getElementById('chevron').style.transform = isOpen ? 'rotate(180deg)' : 'rotate(0deg)';
                if (isOpen && window.scrollY < 50) {
                    document.getElementById('mainHeader').classList.remove('compact');
                }
            });
            document.getElementById('globalSearch').addEventListener('input', e => { STATE.search = e.target.value; render(); });
            document.getElementById('minLevel').addEventListener('input', e => { STATE.minLv = parseInt(e.target.value || 0); render(); });
            document.getElementById('maxLevel').addEventListener('input', e => { STATE.maxLv = parseInt(e.target.value || 115); render(); });
            document.getElementById('posStat1').addEventListener('change', e => { STATE.posStat1 = e.target.value; render(); });
            document.getElementById('negStat1').addEventListener('change', e => { STATE.negStat1 = e.target.value; render(); });
            
            document.getElementById('interestToggle').addEventListener('click', e => {
                STATE.interestOnly = !STATE.interestOnly;
                e.target.classList.toggle('active', STATE.interestOnly);
                render();
            });

            document.getElementById('coordsToggle').addEventListener('click', e => {
                STATE.coordsOnly = !STATE.coordsOnly;
                e.target.classList.toggle('active', STATE.coordsOnly);
                render();
            });

            document.querySelectorAll('.tier-btn').forEach(b => b.addEventListener('click', () => {
                const t = b.dataset.tier; if (STATE.tiers.has(t)) STATE.tiers.delete(t); else STATE.tiers.add(t);
                b.classList.toggle('bg-indigo-600'); b.classList.toggle('text-white'); render();
            }));
            document.getElementById('professionFilters').addEventListener('click', e => {
                const b = e.target.closest('.prof-chip'); if (!b) return;
                const p = b.dataset.prof; if (STATE.profs.has(p)) STATE.profs.delete(p); else STATE.profs.add(p);
                b.classList.toggle('bg-indigo-600'); b.classList.toggle('text-white'); render();
            });
        });
    </script>
</body>
</html>
