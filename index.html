<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Library of Imperial</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap');

        :root {
            --bg-main: #0c0c0e; 
            --bg-card: #16161a; 
            --bg-input: #050506;
            --text-main: #f0f0f2;
            --text-dim: #636370;
            --border-main: #242429;
            
            --zest-indigo: rgba(99, 102, 241, 0.5);
            --zest-purple: rgba(168, 85, 247, 0.5);
            --zest-cyan: rgba(34, 211, 238, 0.5);
        }

        body.light {
            --bg-main: #f8f8fa; 
            --bg-card: #ffffff; 
            --bg-input: #f0f0f3;
            --text-main: #121214;
            --text-dim: #9494a3;
            --border-main: #e2e2e9;
            
            --zest-indigo: rgba(99, 102, 241, 0.2);
            --zest-purple: rgba(168, 85, 247, 0.2);
            --zest-cyan: rgba(34, 211, 238, 0.2);
        }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: var(--bg-main);
            color: var(--text-main);
            transition: background-color 0.4s ease;
        }

        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: var(--bg-main); }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: var(--border-main); border-radius: 10px; }

        .stat-pos { color: #10b981; }
        .stat-neg { color: #fb7185; }

        @keyframes glowCycle {
            0% { box-shadow: 0 15px 35px -10px var(--zest-indigo); border-color: #6366f1; }
            33% { box-shadow: 0 15px 35px -10px var(--zest-purple); border-color: #a855f7; }
            66% { box-shadow: 0 15px 35px -10px var(--zest-cyan); border-color: #22d3ee; }
            100% { box-shadow: 0 15px 35px -10px var(--zest-indigo); border-color: #6366f1; }
        }

        @keyframes titleCycle {
            0% { color: #ef4444; text-shadow: 0 0 10px rgba(239, 68, 68, 0.3); } 
            25% { color: #f97316; text-shadow: 0 0 15px rgba(249, 115, 22, 0.4); } 
            50% { color: #facc15; text-shadow: 0 0 10px rgba(250, 204, 21, 0.3); } 
            75% { color: #f97316; text-shadow: 0 0 15px rgba(249, 115, 22, 0.4); }
            100% { color: #ef4444; text-shadow: 0 0 10px rgba(239, 68, 68, 0.3); } 
        }

        @keyframes fireBreath {
            0%, 100% { transform: translate(-50%, -50%) scale(1); opacity: 0.5; filter: blur(25px); }
            50% { transform: translate(-50%, -50%) scale(1.15); opacity: 0.8; filter: blur(35px); }
        }

        @keyframes fireFlicker {
            0%, 100% { opacity: 0.8; transform: translate(-50%, -50%) scale(1); }
            50% { opacity: 1; transform: translate(-50%, -52%) scale(1.05); }
        }

        .zest-card {
            background: var(--bg-card);
            border: 1px solid var(--border-main);
            transition: all 0.3s cubic-bezier(0.23, 1, 0.32, 1);
            position: relative;
        }

        .zest-card:hover {
            transform: translateY(-8px);
            animation: glowCycle 4s infinite linear;
            z-index: 10;
        }

        .fiery-text {
            animation: titleCycle 6s infinite ease-in-out;
        }

        .logo-fire-aura {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 140px;
            height: 140px;
            background: radial-gradient(circle, #ef4444 0%, #f97316 40%, transparent 70%);
            border-radius: 50%;
            z-index: 0;
            animation: fireBreath 4s infinite ease-in-out;
        }

        .logo-fire-flicker {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 90px;
            height: 90px;
            background: radial-gradient(circle, #facc15 0%, #f97316 50%, transparent 80%);
            border-radius: 50%;
            z-index: 1;
            filter: blur(10px);
            animation: fireFlicker 0.2s infinite alternate;
        }

        #filterSidebar {
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            background: var(--bg-card);
        }

        #filterSidebar.open { transform: translateX(0); }

        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none; margin: 0;
        }

        select {
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%2371717a'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 1rem;
        }

        #toast {
            visibility: hidden;
            min-width: 280px;
            background: var(--bg-card);
            color: var(--text-main);
            text-align: center;
            border-radius: 12px;
            padding: 16px;
            position: fixed;
            z-index: 1000;
            left: 50%;
            transform: translateX(-50%);
            bottom: 40px;
            font-size: 14px;
            font-weight: 800;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4);
            border: 1px solid #ef4444;
            opacity: 0;
            transition: opacity 0.3s, bottom 0.3s;
        }

        #toast.show {
            visibility: visible;
            opacity: 1;
            bottom: 50px;
        }

        .zest-btn {
            background-color: var(--bg-input);
            border: 1px solid var(--border-main);
            color: var(--text-main);
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .zest-btn:hover {
            filter: brightness(1.1);
            transform: scale(1.02);
            border-color: #ef4444;
        }

        .interest-toggle.active, .coords-toggle.active {
            background-color: #ef4444;
            border-color: #f97316;
            color: white;
        }

        .bg-custom-main { background-color: var(--bg-main); }
        .bg-custom-card { background-color: var(--bg-card); }
        .bg-custom-input { background-color: var(--bg-input); }
        .border-custom { border-color: var(--border-main); }
        .text-custom-main { color: var(--text-main); }
        .text-custom-dim { color: var(--text-dim); }
    </style>
</head>
<body class="min-h-screen custom-scrollbar pb-32">

    <div id="toast">Copied Tactical Coordinates!</div>

    <!-- Sidebar Overlay -->
    <div id="sidebarOverlay" class="fixed inset-0 bg-black/60 z-40 opacity-0 pointer-events-none"></div>

    <!-- Slide-out Sidebar Dashboard -->
    <aside id="filterSidebar" class="fixed inset-y-0 left-0 w-80 md:w-96 z-50 transform -translate-x-full border-r border-custom shadow-2xl flex flex-col">
        <div class="p-6 border-b border-custom flex justify-between items-center bg-custom-input/20">
            <h2 class="text-xs font-black uppercase tracking-[0.3em] text-red-500">Command Console</h2>
            <button id="closeSidebar" class="p-2 hover:text-red-500"><i class="fas fa-times"></i></button>
        </div>
        <div class="flex-1 overflow-y-auto p-6 space-y-10 custom-scrollbar">
            <div class="space-y-4">
                <label class="block text-[11px] font-black text-custom-dim uppercase tracking-[0.2em]">Quality Tiering</label>
                <div class="flex gap-2" id="tierFilters">
                    <button data-tier="0" class="tier-btn flex-1 py-3 rounded-xl border border-custom bg-custom-input text-xs font-black">T0</button>
                    <button data-tier="1" class="tier-btn flex-1 py-3 rounded-xl border border-custom bg-custom-input text-xs font-black">T1</button>
                    <button data-tier="2" class="tier-btn flex-1 py-3 rounded-xl border border-custom bg-custom-input text-xs font-black">T2</button>
                    <button data-tier="3" class="tier-btn flex-1 py-3 rounded-xl border border-custom bg-custom-input text-xs font-black">T3</button>
                </div>
            </div>

            <div class="space-y-4">
                <label class="block text-[11px] font-black text-red-500 uppercase tracking-[0.2em]">Priority Protocols</label>
                <div class="flex flex-col gap-3">
                    <button id="interestToggle" class="interest-toggle zest-btn w-full py-4 rounded-xl text-[10px] font-black uppercase tracking-widest text-center">
                        <i class="fas fa-star mr-2"></i> Targeted Interest
                    </button>
                    <button id="coordsToggle" class="coords-toggle zest-btn w-full py-4 rounded-xl text-[10px] font-black uppercase tracking-widest text-center">
                        <i class="fas fa-crosshairs mr-2"></i> Geolocation Only
                    </button>
                </div>
            </div>

            <div class="space-y-4">
                <label class="block text-[11px] font-black text-custom-dim uppercase tracking-[0.2em]">Level Range Parameters</label>
                <div class="flex items-center gap-4">
                    <input type="number" id="minLevel" value="0" class="w-full bg-custom-input border border-custom rounded-xl py-3 px-4 text-sm font-bold outline-none focus:border-red-500">
                    <span class="text-custom-dim font-bold text-lg opacity-30">/</span>
                    <input type="number" id="maxLevel" value="115" class="w-full bg-custom-input border border-custom rounded-xl py-3 px-4 text-sm font-bold outline-none focus:border-red-500">
                </div>
            </div>

            <div class="space-y-6">
                <div class="space-y-4">
                    <label class="block text-[11px] font-black text-emerald-500 uppercase tracking-[0.2em]">Buff Affinity</label>
                    <select id="posStat1" class="w-full bg-custom-input border border-custom rounded-xl py-3 px-4 text-xs font-black text-emerald-500 outline-none"><option value="">Select Protocol</option></select>
                </div>
                <div class="space-y-4">
                    <label class="block text-[11px] font-black text-rose-500 uppercase tracking-[0.2em]">De-Buff Affinity</label>
                    <select id="negStat1" class="w-full bg-custom-input border border-custom rounded-xl py-3 px-4 text-xs font-black text-rose-500 outline-none"><option value="">Select Protocol</option></select>
                </div>
            </div>

            <div class="space-y-4 pb-10">
                <label class="block text-[11px] font-black text-custom-dim uppercase tracking-[0.2em]">Authorized Professions</label>
                <div id="professionFilters" class="flex flex-wrap gap-2"></div>
            </div>
        </div>
        <div class="p-6 border-t border-custom bg-custom-input/20">
            <button onclick="clearAllFilters()" class="w-full py-3 rounded-xl border border-rose-500/30 text-rose-500 text-[10px] font-black uppercase tracking-[0.3em] hover:bg-rose-500/10 transition-all">Flush Settings</button>
        </div>
    </aside>

    <!-- Main Content (Static at top) -->
    <header class="max-w-[1700px] mx-auto px-6 pt-12 pb-8">
        <div class="flex justify-between items-center mb-10 px-4">
            <div class="text-[10px] font-black uppercase tracking-[0.3em] text-zinc-600">
                <span class="fiery-text">Slopcoded</span> for your sake by <span class="fiery-text">Sbacix</span>
            </div>
            <button id="themeToggle" class="zest-btn flex items-center justify-center w-10 h-10 rounded-full text-red-500 shadow-sm" title="Toggle Theme">
                <i class="fas fa-moon" id="themeIcon"></i>
            </button>
        </div>

        <div class="flex flex-col items-center text-center mb-16 relative">
            <div class="relative w-40 h-40 flex items-center justify-center mb-4">
                <div class="logo-fire-aura"></div>
                <div class="logo-fire-flicker"></div>
                <i class="fas fa-dragon text-white text-7xl relative z-10 drop-shadow-[0_0_20px_rgba(239,68,68,1)]"></i>
            </div>
            <h1 class="text-4xl lg:text-7xl font-black tracking-tighter leading-tight text-custom-main uppercase">
                Library of <span class="fiery-text">Imperial</span>
            </h1>
            <p class="text-[14px] font-black text-zinc-500 uppercase tracking-[0.6em] mt-3">Work In Progress</p>
        </div>

        <div class="max-w-4xl mx-auto grid grid-cols-1 md:grid-cols-4 gap-4">
            <button id="toggleFilters" class="zest-btn flex items-center justify-center gap-4 py-4 rounded-2xl font-black text-xs uppercase tracking-widest order-2 md:order-1">
                <i class="fas fa-sliders-h text-red-500"></i>
                <span>Filters</span>
            </button>
            <div class="md:col-span-3 relative order-1 md:order-2">
                <i class="fas fa-search absolute left-5 top-1/2 -translate-y-1/2 text-zinc-500 text-lg"></i>
                <input 
                    type="text" 
                    id="globalSearch"
                    placeholder="Search database records..."
                    class="w-full bg-custom-input border border-custom rounded-2xl py-4 pl-14 pr-6 focus:outline-none focus:ring-4 focus:ring-red-500/10 transition-all text-sm text-custom-main placeholder:text-zinc-600 font-medium"
                >
            </div>
        </div>
    </header>

    <!-- Content Feed -->
    <main class="max-w-[1700px] mx-auto px-6">
        <div id="activeTags" class="flex flex-wrap gap-3 mb-8 min-h-[30px] px-2 justify-center"></div>
        <div id="resultsInfo" class="mb-8 px-6 text-[11px] font-black uppercase tracking-[0.3em] text-red-500 hidden border-l-4 border-red-500 bg-red-500/5 py-3"></div>

        <div id="ingredientGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-8"></div>

        <div id="emptyState" class="hidden flex flex-col items-center justify-center py-64 text-custom-dim">
            <div class="w-24 h-24 bg-custom-input rounded-[2.5rem] flex items-center justify-center mb-8 shadow-2xl border border-custom">
                <i class="fas fa-search-minus text-4xl opacity-20"></i>
            </div>
            <p class="text-2xl font-black uppercase tracking-[0.3em] mb-4">Null Records Found</p>
            <button onclick="clearAllFilters()" class="text-red-500 hover:text-red-400 text-[11px] font-black uppercase tracking-[0.5em] underline">Re-Initialize Inventory</button>
        </div>
    </main>

    <script>
        const MANUAL_INTEREST_LIST = [
            "Adamastor's Faceplate", "Ancient Heart", "Archaic Medallion", "Bat Heart", "Borange Fluff",
            "Cat Food", "Cataratite", "Coalescence", "Colossus' Shard", "Contraband Absinthe",
            "Contraband Hibiscus", "Creepvine Cluster", "Cursed Wings", "Cyclone Blue Leaves",
            "Death Whistle Leaf", "Decaying Heart", "Defiled Luxroot", "Defishious", "Dernic Parasite",
            "Doom Stone", "Draconic Bone Marrow", "Earthly Aura", "Elephelk Trunk", "Enhanced Behaviour Microchip",
            "Enhanced Potential Microchip", "Evolving Spores", "Eye of The Beast", "Fairy Powder",
            "Farcor's Trust", "Fiery Aura", "Flow of Fate", "Gilded Bark", "Glacial Anomaly",
            "Glowing Tree Sap", "Haleva Plant", "Haphazard Serum", "Ice Cream Sandwich", "Kerasot Sporehead",
            "Large Titanium Chunk", "Lashing Hellfire", "Lithoflesh", "Letvus Delight", "Lunar Charm",
            "Luxrooot Cuttings", "Mangrove Root", "Mellow Mango", "Myconid Spores", "Myocardial Leg",
            "Naval Stone", "Nightmare Fuel", "Nivlan Honey", "Obelisk Core", "Plane of Nonexistence",
            "Pride of the Heights", "Prismatic Spores", "Red Mercury", "Remedial Paste", "Ritual Catalyst",
            "Rock-Hard Beak", "Sentient Leukocyte", "Serpent Tongue", "Shattered Dawnlight", "Shrieker's Head",
            "Smokebomb", "Soulbound Cinders", "Tentacle", "Throbbing Avos Heart", "Unicorn Horn",
            "Watery Aura", "Windy Aura", "World Illuminator"
        ];

        const INTEREST_NAMES = new Set(MANUAL_INTEREST_LIST.map(n => n.trim().toLowerCase()));
        let RAW_DATA = [];
        const STATE = {
            search: "", minLv: 0, maxLv: 115, tiers: new Set(), profs: new Set(),
            posStat1: "", negStat1: "", interestOnly: false, coordsOnly: false, theme: "dark",
            allProfs: [], allPosStats: [], allNegStats: []
        };

        const isNum = (v) => v !== null && v !== undefined && v !== "" && isFinite(Number(v));
        function debounce(func, wait) {
            let timeout; return function(...args) { clearTimeout(timeout); timeout = setTimeout(() => func.apply(this, args), wait); };
        }

        async function loadShopData() {
            try {
                const [ingredientsRes, dropsRes, htoiRes] = await Promise.all([
                    fetch('ingredients.json'), 
                    fetch('drops.json'),
                    fetch('htoi.json')
                ]);
                if (!ingredientsRes.ok || !dropsRes.ok || !htoiRes.ok) throw new Error("Connection unstable");
                processJsonData(await ingredientsRes.json(), await dropsRes.json(), await htoiRes.json());
            } catch (error) { console.error(error); showToast("Link to Mainframe Severed"); }
        }

        function processJsonData(ingredients, dropsMap, htoiArray) {
            const processed = [];
            const normIngredients = {};
            Object.keys(ingredients).forEach(k => normIngredients[k.trim().toLowerCase()] = { ...ingredients[k], originalName: k });
            const normDrops = {};
            Object.keys(dropsMap).forEach(k => normDrops[k.trim().toLowerCase()] = dropsMap[k]);
            
            const normHtoi = {};
            if (Array.isArray(htoiArray)) {
                htoiArray.forEach(item => {
                    if (item.name) normHtoi[item.name.trim().toLowerCase()] = item;
                });
            }

            const sharedTelemetry = {}; 
            Object.values(dropsMap).forEach(dropArray => {
                if (!Array.isArray(dropArray)) return;
                dropArray.forEach(d => {
                    if (!d.name) return;
                    const mobKey = d.name.trim().toLowerCase();
                    if (!sharedTelemetry[mobKey]) sharedTelemetry[mobKey] = [];
                    if (d.details && d.details.coords) {
                        const rawCoords = d.details.coords;
                        const isLegit = (c) => isNum(c.x) && isNum(c.z) && (Number(c.x) !== 0 || Number(c.z) !== 0);
                        const addCoord = (c) => {
                            if (isLegit(c)) {
                                const coordObj = { x: Number(c.x), y: isNum(c.y) ? Number(c.y) : null, z: Number(c.z) };
                                const coordStr = `${coordObj.x},${coordObj.y},${coordObj.z}`;
                                if (!sharedTelemetry[mobKey].find(ex => `${ex.x},${ex.y},${ex.z}` === coordStr)) sharedTelemetry[mobKey].push(coordObj);
                            }
                        };
                        if (Array.isArray(rawCoords)) rawCoords.forEach(addCoord); else addCoord(rawCoords);
                    }
                });
            });

            const allKeys = new Set([...Object.keys(normIngredients), ...Object.keys(normDrops), ...Object.keys(normHtoi)]);
            for (const key of allKeys) {
                const ingData = normIngredients[key] || {};
                const dropEntries = normDrops[key] || [];
                const hData = normHtoi[key] || {};

                const item = {
                    name: ingData.originalName || hData.name || Object.keys(dropsMap).find(orig => orig.trim().toLowerCase() === key) || key,
                    tier: ingData.tier !== undefined ? Number(ingData.tier) : -1,
                    level: Number(ingData.lvl || hData.level) || 0,
                    professions: ingData.profs || [],
                    stats: ingData.stats || [],
                    drops: [], searchStr: "" 
                };

                const combinedSources = new Map();

                if (Array.isArray(dropEntries)) {
                    dropEntries.forEach(d => {
                        const sName = (d.name || "Unknown Source").trim();
                        const sLoc = (d.details ? d.details.location || "" : "").trim();
                        const sKey = `${sName}|${sLoc}`;
                        if (!combinedSources.has(sKey)) {
                            combinedSources.set(sKey, {
                                name: sName, location: sLoc,
                                mobKey: sName.toLowerCase(),
                                screenshots: d.details ? (d.details.screenshots || "") : ""
                            });
                        }
                    });
                }

                const metaFields = ['id', 'name', 'level'];
                Object.keys(hData).forEach(field => {
                    if (!metaFields.includes(field) && hData[field]) {
                        try {
                            const entries = JSON.parse(hData[field]);
                            if (Array.isArray(entries)) {
                                entries.forEach(entry => {
                                    const sName = (entry.name || entry.description || field.toUpperCase()).trim();
                                    const sLoc = (entry.location || "").trim();
                                    const sKey = `${sName}|${sLoc}`;
                                    if (!combinedSources.has(sKey)) {
                                        combinedSources.set(sKey, {
                                            name: sName, location: sLoc,
                                            mobKey: sName.toLowerCase(),
                                            screenshots: ""
                                        });
                                    }
                                });
                            }
                        } catch (e) {}
                    }
                });

                item.drops = Array.from(combinedSources.values()).map(source => ({
                    ...source,
                    allCoords: sharedTelemetry[source.mobKey] || []
                }));

                item.searchStr = [item.name, ...item.professions, ...item.stats.map(s => s.label), ...item.drops.map(d => d.name + ' ' + d.location)].join(' ').toLowerCase();
                processed.push(item);
            }
            RAW_DATA = processed;
            computeDynamicState();
            initDynamicUI();
            render();
        }

        function computeDynamicState() {
            STATE.allProfs = [...new Set(RAW_DATA.flatMap(i => i.professions))].sort();
            STATE.allPosStats = [...new Set(RAW_DATA.flatMap(i => i.stats.filter(s => s.pos).map(s => s.label)))].sort();
            STATE.allNegStats = [...new Set(RAW_DATA.flatMap(i => i.stats.filter(s => !s.pos).map(s => s.label)))].sort();
        }

        function initDynamicUI() {
            const pc = document.getElementById('professionFilters');
            pc.innerHTML = STATE.allProfs.map(p => `<button data-prof="${p}" class="prof-chip zest-btn px-3 py-2 rounded-lg text-[10px] font-black uppercase tracking-widest whitespace-nowrap">${p}</button>`).join('');
            const ps = document.getElementById('posStat1'), ns = document.getElementById('negStat1');
            ps.innerHTML = '<option value="">Select Protocol</option>'; ns.innerHTML = '<option value="">Select Protocol</option>';
            STATE.allPosStats.forEach(s => ps.innerHTML += `<option value="${s}">${s}</option>`);
            STATE.allNegStats.forEach(s => ns.innerHTML += `<option value="${s}">${s}</option>`);
        }

        function filterData() {
            const query = STATE.search.toLowerCase().trim();
            const filtered = RAW_DATA.filter(item => {
                if (query && !item.searchStr.includes(query)) return false;
                if (item.level < STATE.minLv || item.level > STATE.maxLv) return false;
                if (STATE.tiers.size > 0 && !STATE.tiers.has(item.tier.toString())) return false;
                if (STATE.profs.size > 0 && !item.professions.some(p => STATE.profs.has(p))) return false;
                if (STATE.posStat1 && !item.stats.some(s => s.label === STATE.posStat1 && s.pos)) return false;
                if (STATE.negStat1 && !item.stats.some(s => s.label === STATE.negStat1 && !s.pos)) return false;
                if (STATE.interestOnly && !INTEREST_NAMES.has(item.name.trim().toLowerCase())) return false;
                if (STATE.coordsOnly && !item.drops.some(d => d.allCoords.length > 0)) return false;
                return true;
            });
            const anyActive = query || STATE.tiers.size || STATE.profs.size || STATE.interestOnly || STATE.coordsOnly || STATE.minLv !== 0 || STATE.maxLv !== 115 || STATE.posStat1 || STATE.negStat1;
            return !anyActive ? filtered.sort(() => 0.5 - Math.random()).slice(0, 50) : filtered.sort((a, b) => a.name.localeCompare(b.name));
        }

        function render() {
            const grid = document.getElementById('ingredientGrid'), info = document.getElementById('resultsInfo'), rawResults = filterData();
            const renderLimit = 160; const data = rawResults.slice(0, renderLimit);
            if (rawResults.length > 0) {
                info.classList.remove('hidden');
                info.textContent = rawResults.length > renderLimit ? `Showing top ${renderLimit} of ${rawResults.length} records` : `${rawResults.length} records retrieved`;
            } else info.classList.add('hidden');

            if (data.length === 0) { grid.innerHTML = ""; document.getElementById('emptyState').classList.remove('hidden'); }
            else {
                document.getElementById('emptyState').classList.add('hidden');
                grid.innerHTML = data.map((item, idx) => `
                    <div class="zest-card rounded-[2.5rem] p-6 flex flex-col gap-6 shadow-xl">
                        <div class="flex justify-between items-start">
                            <div class="overflow-hidden">
                                <h3 class="text-base font-black text-custom-main leading-tight uppercase tracking-tight mb-2 truncate">${item.name}</h3>
                                <div class="flex items-center gap-2">
                                    <span class="text-[10px] font-black text-red-500 bg-red-500/10 px-2 py-1 rounded-lg leading-none">LV ${item.level}</span>
                                    <div class="flex gap-1 text-amber-500">
                                        ${item.tier >= 0 ? Array(item.tier).fill(0).map(() => `<i class="fas fa-star text-[9px]"></i>`).join('') : '<span class="text-[8px] text-zinc-600 font-bold tracking-tighter">UNRANKED</span>'}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="space-y-5">
                            <div class="space-y-1.5">
                                <p class="text-[9px] font-black text-custom-dim uppercase tracking-[0.2em] border-b border-custom pb-2 mb-2">Properties</p>
                                ${item.stats.length === 0 ? '<p class="text-[11px] italic text-zinc-700 opacity-50">Passive Record.</p>' : item.stats.map(s => `
                                    <div class="flex justify-between text-[13px] font-bold py-1 border-b border-custom border-opacity-10 last:border-0">
                                        <span class="text-custom-dim">${s.label}</span>
                                        <span class="${s.pos ? 'stat-pos' : 'stat-neg'}">${s.value}</span>
                                    </div>
                                `).join('')}
                            </div>

                            <div class="space-y-3">
                                <p class="text-[9px] font-black text-custom-dim uppercase tracking-[0.2em] border-b border-custom pb-2 mb-2">Last Seen</p>
                                ${item.drops.length === 0 ? `<p class="text-[11px] italic text-custom-dim opacity-40">No telemetry logs.</p>` : item.drops.map(drop => {
                                    const mainScreenshot = drop.screenshots ? drop.screenshots.split(',')[0].trim() : null;
                                    return `
                                    <div class="space-y-4 bg-custom-main bg-opacity-40 p-5 rounded-2xl border border-custom border-opacity-30">
                                        <div class="flex justify-between items-start gap-2">
                                            <div class="flex-1 min-w-0">
                                                <p class="text-custom-main font-black text-sm leading-tight break-words">${drop.name}</p>
                                                <div class="flex items-start gap-1.5 text-custom-dim text-[10px] font-bold mt-1.5">
                                                    <i class="fas fa-map-marker-alt text-red-500/50 mt-0.5"></i>
                                                    <span class="break-words">${drop.location || 'Undisclosed Area'}</span>
                                                </div>
                                            </div>
                                            ${mainScreenshot ? `<a href="${mainScreenshot}" target="_blank" class="zest-btn p-2.5 rounded-xl !bg-red-500/10 !text-red-500 !border-red-500/30 hover:!bg-red-500 hover:!text-white transition-all shadow-sm shrink-0" title="Intel Feed"><i class="fas fa-image"></i></a>` : ''}
                                        </div>
                                        <div class="grid grid-cols-1 gap-3 px-1">
                                            ${drop.allCoords.map(c => {
                                                const hasY = isNum(c.y);
                                                const label = hasY ? `${c.x}, ${c.y}, ${c.z}` : `${c.x}, ${c.z}`;
                                                return `<button onclick="copyToClipboard('${c.x}', ${hasY ? c.y : 'null'}, '${c.z}')" class="zest-btn flex items-center justify-center gap-3 bg-red-600 !border-red-400 !text-white hover:bg-red-500 py-3.5 rounded-xl cursor-pointer shadow-lg group mx-0.5"><i class="fas fa-crosshairs text-base group-hover:rotate-90 transition-transform"></i><span class="font-black text-[11px] font-mono tracking-widest">${label}</span></button>`;
                                            }).join('')}
                                        </div>
                                    </div>
                                `;}).join('')}
                            </div>
                        </div>

                        <div class="mt-auto pt-4 border-t border-custom border-opacity-50 flex flex-wrap gap-2">
                            ${item.professions.length === 0 ? '<span class="text-[8px] text-zinc-800 font-bold uppercase tracking-widest">Generic Entry</span>' : item.professions.map(p => `
                                <span class="text-[7px] text-custom-dim font-black px-2.5 py-1.5 rounded-lg bg-custom-input border border-custom uppercase tracking-tighter">${p}</span>
                            `).join('')}
                        </div>
                    </div>
                `).join('');
            }
            renderTags();
        }

        function renderTags() {
            const container = document.getElementById('activeTags'), tags = [];
            if (STATE.search) tags.push({ id: 'search', label: `QUERY: ${STATE.search}` });
            if (STATE.interestOnly) tags.push({ id: 'interest', label: `★ TARGETED` });
            if (STATE.coordsOnly) tags.push({ id: 'coords', label: `⌖ GEOLOCATED` });
            if (STATE.minLv > 0 || STATE.maxLv < 115) tags.push({ id: 'lv', label: `LV RANGE ${STATE.minLv}-${STATE.maxLv}` });
            STATE.tiers.forEach(t => tags.push({ id: `tier-${t}`, label: `TIER ${t}` }));
            STATE.profs.forEach(p => tags.push({ id: `prof-${p}`, label: p }));
            container.innerHTML = tags.map(t => `<div class="flex items-center gap-3 px-4 py-2 bg-custom-card border border-custom text-custom-main rounded-xl text-[10px] font-black uppercase tracking-widest shadow-lg">${t.label}<button onclick="removeFilter('${t.id}')" class="hover:text-red-400 transition-colors"><i class="fas fa-times"></i></button></div>`).join('');
        }

        function copyToClipboard(x, y, z) {
            const command = (isNum(y)) ? `/compass ${x}, ${y}, ${z}` : `/compass ${x}, ${z}`;
            const ta = document.createElement("textarea"); ta.value = command; ta.style.position = "fixed"; ta.style.left = "-9999px";
            document.body.appendChild(ta); ta.select();
            try { document.execCommand('copy'); showToast(`COPIED: ${command}`); } catch (err) {}
            document.body.removeChild(ta);
        }

        function showToast(msg) {
            const t = document.getElementById("toast"); t.textContent = msg; t.classList.add("show");
            setTimeout(() => t.classList.remove("show"), 2500);
        }

        function toggleTheme() {
            const icon = document.getElementById('themeIcon');
            if (STATE.theme === "dark") { STATE.theme = "light"; document.body.classList.add('light'); icon.classList.replace('fa-moon', 'fa-sun'); }
            else { STATE.theme = "dark"; document.body.classList.remove('light'); icon.classList.replace('fa-sun', 'fa-moon'); }
        }

        function toggleSidebar(open) {
            const sidebar = document.getElementById('filterSidebar');
            const overlay = document.getElementById('sidebarOverlay');
            if (sidebar && overlay) {
                if (open) {
                    sidebar.classList.add('open');
                    overlay.classList.add('opacity-100');
                    overlay.classList.remove('pointer-events-none');
                } else {
                    sidebar.classList.remove('open');
                    overlay.classList.remove('opacity-100');
                    overlay.classList.add('pointer-events-none');
                }
            }
        }

        function removeFilter(id) {
            if (id === 'search') { STATE.search = ""; document.getElementById('globalSearch').value = ""; }
            else if (id === 'interest') { STATE.interestOnly = false; document.getElementById('interestToggle').classList.remove('active'); }
            else if (id === 'coords') { STATE.coordsOnly = false; document.getElementById('coordsToggle').classList.remove('active'); }
            else if (id === 'lv') { STATE.minLv = 0; STATE.maxLv = 115; document.getElementById('minLevel').value = 0; document.getElementById('maxLevel').value = 115; }
            else if (id.startsWith('tier-')) { const t = id.split('-')[1]; STATE.tiers.delete(t); const btn = document.querySelector(`.tier-btn[data-tier="${t}"]`); if (btn) btn.classList.remove('bg-red-600', 'text-white'); }
            else if (id.startsWith('prof-')) { const p = id.split('-')[1]; STATE.profs.delete(p); const chip = document.querySelector(`.prof-chip[data-prof="${p}"]`); if (chip) chip.classList.remove('bg-red-600', 'text-white'); }
            render();
        }

        function clearAllFilters() {
            STATE.search = ""; STATE.minLv = 0; STATE.maxLv = 115; STATE.interestOnly = false; STATE.coordsOnly = false;
            STATE.tiers.clear(); STATE.profs.clear(); STATE.posStat1 = ""; STATE.negStat1 = "";
            document.getElementById('globalSearch').value = "";
            document.getElementById('interestToggle').classList.remove('active'); document.getElementById('coordsToggle').classList.remove('active');
            document.querySelectorAll('.tier-btn, .prof-chip').forEach(el => el.classList.remove('bg-red-600', 'text-white'));
            document.querySelectorAll('select').forEach(s => s.value = "");
            render();
        }

        window.addEventListener('DOMContentLoaded', () => {
            loadShopData();
            document.getElementById('themeToggle').addEventListener('click', toggleTheme);
            document.querySelectorAll('#toggleFilters').forEach(btn => btn.addEventListener('click', () => toggleSidebar(true)));
            document.getElementById('closeSidebar').addEventListener('click', () => toggleSidebar(false));
            document.getElementById('sidebarOverlay').addEventListener('click', () => toggleSidebar(false));

            const performSearch = debounce((val) => { STATE.search = val; render(); }, 250);
            document.getElementById('globalSearch').addEventListener('input', e => performSearch(e.target.value));
            document.getElementById('minLevel').addEventListener('input', e => { STATE.minLv = parseInt(e.target.value || 0); render(); });
            document.getElementById('maxLevel').addEventListener('input', e => { STATE.maxLv = parseInt(e.target.value || 115); render(); });
            document.getElementById('posStat1').addEventListener('change', e => { STATE.posStat1 = e.target.value; render(); });
            document.getElementById('negStat1').addEventListener('change', e => { STATE.negStat1 = e.target.value; render(); });
            
            document.getElementById('interestToggle').addEventListener('click', e => {
                STATE.interestOnly = !STATE.interestOnly;
                e.target.classList.toggle('active', STATE.interestOnly);
                render();
            });
            document.getElementById('coordsToggle').addEventListener('click', e => {
                STATE.coordsOnly = !STATE.coordsOnly;
                e.target.classList.toggle('active', STATE.coordsOnly);
                render();
            });
            document.querySelectorAll('.tier-btn').forEach(b => b.addEventListener('click', () => {
                const t = b.dataset.tier; if (STATE.tiers.has(t)) STATE.tiers.delete(t); else STATE.tiers.add(t);
                b.classList.toggle('bg-red-600'); b.classList.toggle('text-white'); render();
            }));
            document.getElementById('professionFilters').addEventListener('click', e => {
                const b = e.target.closest('.prof-chip'); if (!b) return;
                const p = b.dataset.prof; if (STATE.profs.has(p)) STATE.profs.delete(p); else STATE.profs.add(p);
                b.classList.toggle('bg-red-600'); b.classList.toggle('text-white'); render();
            });
        });
    </script>
</body>
</html>
