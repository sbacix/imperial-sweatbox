<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Library of Imperial</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;700&display=swap');

        :root {
            --bg-body: #f5f2ed;
            --bg-card: #ffffff;
            --bg-surface: #faf8f5;
            --text-primary: #4a4641;
            --text-secondary: #8a847c;
            --accent: #a3b18a;
            --accent-hover: #588157;
            --border: rgba(0, 0, 0, 0.08);
            --shadow: 0 10px 30px rgba(0, 0, 0, 0.05);
            
            --status-red: #e07a5f;
            --status-orange: #f2cc8f;
            --status-green: #81b29a;
        }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: var(--bg-body);
            color: var(--text-primary);
            transition: all 0.6s cubic-bezier(0.4, 0, 0.2, 1);
            overflow-x: hidden;
        }

        .mono { font-family: 'JetBrains Mono', monospace; }

        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-body); }
        ::-webkit-scrollbar-thumb { background: var(--text-secondary); opacity: 0.2; border-radius: 10px; }

        .archive-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 28px;
            box-shadow: var(--shadow);
            transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275), border-color 0.3s, background 0.4s;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .archive-card:hover {
            transform: translateY(-8px);
            border-color: var(--accent);
        }

        .input-base {
            background: var(--bg-surface);
            border: 1px solid var(--border);
            color: var(--text-primary);
            border-radius: 16px;
            transition: all 0.2s;
        }

        .btn-primary {
            background: var(--accent);
            color: white;
            border-radius: 16px;
            transition: all 0.3s;
        }

        .coord-btn {
            background: var(--bg-surface);
            color: var(--text-primary);
            border: 1px solid var(--border);
            transition: all 0.2s;
            font-size: 10px;
            font-weight: 800;
            padding: 8px 14px;
            border-radius: 12px;
        }
        
        .coord-btn:hover {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }

        #filterSidebar {
            background: var(--bg-card);
            border-left: 1px solid var(--border);
            transition: transform 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        #filterSidebar.open { transform: translateX(0); }

        .loot-pill {
            background: var(--bg-surface);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 16px;
            margin-bottom: 12px;
        }

        .stat-badge {
            font-size: 10px;
            font-weight: 800;
            padding: 4px 10px;
            border-radius: 10px;
            background: var(--bg-card);
            border: 1px solid var(--border);
        }

        .toggle-btn.active {
            background: var(--accent);
            color: white !important;
            border-color: var(--accent);
        }

        #toast {
            position: fixed;
            bottom: 2.5rem;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--bg-card);
            color: var(--text-primary);
            padding: 1.2rem 2.5rem;
            border-radius: 20px;
            font-weight: 800;
            font-size: 15px;
            z-index: 1000;
            transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            border: 2px solid var(--accent);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.2);
        }
        #toast.show { transform: translateX(-50%) translateY(0); }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        .status-loading { background-color: var(--status-orange); box-shadow: 0 0 10px var(--status-orange); }
        .status-success { background-color: var(--status-green); box-shadow: 0 0 10px var(--status-green); }
        .status-error { background-color: var(--status-red); box-shadow: 0 0 10px var(--status-red); }

        .preset-dot {
            width: 32px;
            height: 32px;
            border-radius: 12px;
            cursor: pointer;
            border: 3px solid transparent;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .preset-dot.active { border-color: var(--accent); transform: scale(1.1); }
        
        .brightness-dot {
            width: 32px;
            height: 32px;
            border-radius: 12px;
            cursor: pointer;
            border: 2px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 800;
        }
        .brightness-dot.active { background: var(--accent); color: white; border-color: var(--accent); }
    </style>
</head>
<body class="min-h-screen">

    <div id="toast">Archive Synchronized</div>

    <header class="sticky top-0 z-40 w-full bg-[var(--bg-body)]/80 backdrop-blur-2xl border-b border-[var(--border)]">
        <div class="max-w-[1500px] mx-auto px-8 h-28 flex items-center justify-between">
            <div class="flex items-center gap-5">
                <div class="w-14 h-14 bg-[var(--accent)] rounded-2xl flex items-center justify-center text-white shadow-xl shadow-[var(--accent)]/30 transition-all duration-500">
                    <i class="fas fa-dragon text-2xl"></i>
                </div>
                <div>
                    <h1 class="text-xl font-black tracking-tighter uppercase">Library of <span style="color: var(--accent-hover)">Imperial</span></h1>
                    <div class="flex items-center mt-1">
                        <span id="apiStatusDot" class="status-dot status-loading"></span>
                        <p id="apiStatusText" class="text-[10px] text-[var(--text-secondary)] font-black tracking-[0.15em] uppercase">Syncing Live Matrix...</p>
                    </div>
                </div>
            </div>

            <div class="hidden lg:flex flex-1 max-w-2xl mx-12 relative">
                <i class="fas fa-search absolute left-6 top-1/2 -translate-y-1/2 text-[var(--text-secondary)] opacity-40"></i>
                <input 
                    type="text" id="globalSearch" 
                    placeholder="Enter entity or item signature..."
                    class="w-full input-base py-4 pl-14 pr-8 text-sm font-medium tracking-tight outline-none"
                >
            </div>

            <div class="flex items-center gap-5">
                <button id="toggleFilters" class="btn-primary px-8 py-4 text-xs font-black uppercase tracking-widest flex items-center gap-3 shadow-xl shadow-[var(--accent)]/20">
                    <i class="fas fa-layer-group"></i> <span>Matrix</span>
                </button>
            </div>
        </div>
    </header>

    <main class="max-w-[1500px] mx-auto px-8 py-12">
        <div id="activeTags" class="flex flex-wrap gap-3 mb-12 min-h-[32px]"></div>

        <div class="flex items-center justify-between mb-12 border-l-4 border-[var(--accent)] pl-6 py-2">
            <h2 id="resultsInfo" class="text-xs font-black text-[var(--text-secondary)] uppercase tracking-[0.3em]">
                Acquiring Database Streams...
            </h2>
        </div>

        <div id="sourceGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-12"></div>

        <div id="emptyState" class="hidden py-64 flex flex-col items-center text-center">
            <div class="w-24 h-24 bg-[var(--bg-surface)] rounded-[2.5rem] flex items-center justify-center mb-8 opacity-20">
                <i class="fas fa-shield-virus text-4xl"></i>
            </div>
            <h3 class="text-2xl font-black tracking-tight opacity-50">Null Archive Signal</h3>
            <p class="text-[var(--text-secondary)] font-medium max-w-sm mt-4 mb-10">No unique entities match the parameters in the Imperial Database.</p>
            <button onclick="clearAllFilters()" class="text-[var(--accent-hover)] font-black uppercase text-xs tracking-[0.2em] border-b-2 border-[var(--accent)] pb-1">Full System Reset</button>
        </div>
    </main>

    <div id="sidebarOverlay" class="fixed inset-0 bg-black/40 z-[50] opacity-0 pointer-events-none transition-opacity duration-500"></div>
    <aside id="filterSidebar" class="fixed top-0 right-0 h-full w-[420px] z-[60] transform translate-x-full shadow-2xl flex flex-col">
        <div class="p-10 border-b border-[var(--border)] flex items-center justify-between bg-[var(--bg-surface)]">
            <h2 class="font-black text-sm uppercase tracking-[0.2em]">Interface Config</h2>
            <button id="closeSidebar" class="w-10 h-10 flex items-center justify-center rounded-xl hover:bg-black/5"><i class="fas fa-times"></i></button>
        </div>

        <div class="flex-1 overflow-y-auto p-10 space-y-12 custom-scrollbar">
            <section class="space-y-8 bg-[var(--bg-surface)] p-6 rounded-3xl border border-[var(--border)]">
                <div>
                    <label class="text-[10px] font-black text-[var(--text-secondary)] uppercase tracking-widest mb-5 block">Visual Luminance</label>
                    <div class="flex justify-between items-center px-1" id="brightnessPresets">
                        <button data-level="1" class="brightness-dot">1</button>
                        <button data-level="2" class="brightness-dot">2</button>
                        <button data-level="3" class="brightness-dot">3</button>
                        <button data-level="4" class="brightness-dot">4</button>
                        <button data-level="5" class="brightness-dot">5</button>
                    </div>
                </div>

                <div>
                    <label class="text-[10px] font-black text-[var(--text-secondary)] uppercase tracking-widest mb-5 block">Atmospheric Palette</label>
                    <div class="flex justify-between items-center px-1" id="palettePresets">
                        <button data-palette="sage" class="preset-dot bg-[#a3b18a]" title="Sage"></button>
                        <button data-palette="ocean" class="preset-dot bg-[#72a1b1]" title="Ocean"></button>
                        <button data-palette="crimson" class="preset-dot bg-[#b17272]" title="Crimson"></button>
                        <button data-palette="amber" class="preset-dot bg-[#b19672]" title="Amber"></button>
                        <button data-palette="lavender" class="preset-dot bg-[#8c72b1]" title="Lavender"></button>
                    </div>
                </div>
            </section>

            <section class="space-y-6">
                <label class="text-[10px] font-black text-[var(--text-secondary)] uppercase tracking-widest">Quality Tier</label>
                <div class="grid grid-cols-4 gap-3" id="tierFilters">
                    <button data-tier="0" class="tier-btn input-base py-4 text-xs font-black">T0</button>
                    <button data-tier="1" class="tier-btn input-base py-4 text-xs font-black">T1</button>
                    <button data-tier="2" class="tier-btn input-base py-4 text-xs font-black">T2</button>
                    <button data-tier="3" class="tier-btn input-base py-4 text-xs font-black">T3</button>
                </div>
            </section>

            <section class="space-y-4">
                <label class="text-[10px] font-black text-[var(--text-secondary)] uppercase tracking-widest">Active Protocols</label>
                <button id="interestToggle" class="toggle-btn input-base w-full py-5 text-[11px] font-black uppercase tracking-[0.2em] flex items-center justify-center gap-3">
                    <i class="fas fa-crown text-amber-500"></i> High Priority
                </button>
                <button id="coordsToggle" class="toggle-btn input-base w-full py-5 text-[11px] font-black uppercase tracking-[0.2em] flex items-center justify-center gap-3">
                    <i class="fas fa-crosshairs"></i> Geolocated
                </button>
            </section>

            <section class="space-y-6">
                <label class="text-[10px] font-black text-[var(--text-secondary)] uppercase tracking-widest">Loot Level</label>
                <div class="flex items-center gap-5">
                    <input type="number" id="minLevel" placeholder="0" class="w-full input-base px-5 py-4 text-sm font-black outline-none">
                    <span class="text-[var(--text-secondary)] font-black opacity-30">/</span>
                    <input type="number" id="maxLevel" placeholder="115" class="w-full input-base px-5 py-4 text-sm font-black outline-none">
                </div>
            </section>

            <section class="space-y-10">
                <div>
                    <label class="block text-[10px] font-black uppercase tracking-widest mb-5 text-[var(--status-green)]">Primary Buff</label>
                    <select id="posStat1" class="w-full input-base px-5 py-4 text-xs font-black outline-none cursor-pointer"></select>
                </div>
                <div>
                    <label class="block text-[10px] font-black uppercase tracking-widest mb-5 text-[var(--status-red)]">Primary Debuff</label>
                    <select id="negStat1" class="w-full input-base px-5 py-4 text-xs font-black outline-none cursor-pointer"></select>
                </div>
            </section>

            <section class="space-y-6 pb-20">
                <label class="text-[10px] font-black text-[var(--text-secondary)] uppercase tracking-widest">Authorized Professions</label>
                <div id="professionFilters" class="flex flex-wrap gap-3"></div>
            </section>
        </div>

        <div class="p-10 border-t border-[var(--border)] bg-[var(--bg-surface)]">
            <button onclick="clearAllFilters()" class="w-full py-5 rounded-3xl text-[11px] font-black uppercase tracking-widest bg-rose-500/10 text-rose-500 hover:bg-rose-500 hover:text-white transition-all">Emergency Flush</button>
        </div>
    </aside>

    <script>
        const MANUAL_INTEREST_LIST = [
            "Adamastor's Faceplate", "Ancient Heart", "Archaic Medallion", "Bat Heart", "Borange Fluff",
            "Cat Food", "Cataratite", "Coalescence", "Colossus' Shard", "Contraband Absinthe",
            "Contraband Hibiscus", "Creepvine Cluster", "Cursed Wings", "Cyclone Blue Leaves",
            "Death Whistle Leaf", "Decaying Heart", "Defiled Luxroot", "Defishious", "Dernic Parasite",
            "Doom Stone", "Draconic Bone Marrow", "Earthly Aura", "Elephelk Trunk", "Enhanced Behaviour Microchip",
            "Enhanced Potential Microchip", "Evolving Spores", "Eye of The Beast", "Fairy Powder",
            "Farcor's Trust", "Fiery Aura", "Flow of Fate", "Gilded Bark", "Glacial Anomaly",
            "Glowing Tree Sap", "Haleva Plant", "Haphazard Serum", "Ice Cream Sandwich", "Kerasot Sporehead",
            "Large Titanium Chunk", "Lashing Hellfire", "Lithoflesh", "Letvus Delight", "Lunar Charm",
            "Luxrooot Cuttings", "Mangrove Root", "Mellow Mango", "Myconid Spores", "Myocardial Leg",
            "Naval Stone", "Nightmare Fuel", "Nivlan Honey", "Obelisk Core", "Plane of Nonexistence",
            "Pride of the Heights", "Prismatic Spores", "Red Mercury", "Remedial Paste", "Ritual Catalyst",
            "Rock-Hard Beak", "Sentient Leukocyte", "Serpent Tongue", "Shattered Dawnlight", "Shrieker's Head",
            "Smokebomb", "Soulbound Cinders", "Tentacle", "Throbbing Avos Heart", "Unicorn Horn",
            "Watery Aura", "Windy Aura", "World Illuminator"
        ];
        const INTEREST_NAMES = new Set(MANUAL_INTEREST_LIST.map(n => n.trim().toLowerCase()));
        
        let SOURCE_DATA = [];
        let GLOBAL_ITEM_LOOKUP = {};
        const STATE = {
            search: "", minLv: 0, maxLv: 115, tiers: new Set(), profs: new Set(),
            posStat1: "", negStat1: "", interestOnly: false, coordsOnly: false,
            brightness: 3, palette: 'sage',
            allProfs: [], allPosStats: [], allNegStats: []
        };

        const isNum = (v) => v !== null && v !== undefined && v !== "" && isFinite(Number(v));
        function debounce(func, wait) {
            let timeout; return function(...args) { clearTimeout(timeout); timeout = setTimeout(() => func.apply(this, args), wait); };
        }

        function setApiStatus(state) {
            const dot = document.getElementById('apiStatusDot');
            const text = document.getElementById('apiStatusText');
            dot.className = "status-dot";
            if (state === 'loading') { dot.classList.add('status-loading'); text.textContent = "Linking Matrix..."; }
            else if (state === 'success') { dot.classList.add('status-success'); text.textContent = "Live Stream Verified"; }
            else if (state === 'error') { dot.classList.add('status-error'); text.textContent = "Offline (Archive Mode)"; }
        }

        async function loadShopData() {
            setApiStatus('loading');
            
            // Phase 1: Local Load (Immediate)
            try {
                const [resI, resD, resH] = await Promise.all([
                    fetch('ingredients.json').then(r => r.ok ? r.json() : {}),
                    fetch('drops.json').then(r => r.ok ? r.json() : {}),
                    fetch('htoi.json').then(r => r.ok ? r.json() : [])
                ]);
                processJsonData(resI, resD, resH, {}); // Render local instantly
            } catch (e) { console.error("Archive Failed", e); }

            // Phase 2: API Load (Background)
            try {
                const wynnRes = await fetch('https://api.allorigins.win/raw?url=' + encodeURIComponent('https://api.wynncraft.com/v3/item/database?fullResult'));
                if (wynnRes.ok) {
                    const wynnItems = await wynnRes.json();
                    // Re-run processing with API data included
                    const [resI, resD, resH] = await Promise.all([
                        fetch('ingredients.json').then(r => r.json()),
                        fetch('drops.json').then(r => r.json()),
                        fetch('htoi.json').then(r => r.json())
                    ]);
                    processJsonData(resI, resD, resH, wynnItems);
                    setApiStatus('success');
                } else { setApiStatus('error'); }
            } catch(apiErr) { setApiStatus('error'); }
        }

        function processJsonData(ingredients, dropsMap, htoiArray, wynnItems) {
            GLOBAL_ITEM_LOOKUP = {};
            Object.keys(ingredients).forEach(k => {
                const lower = k.trim().toLowerCase();
                GLOBAL_ITEM_LOOKUP[lower] = { ...ingredients[k], originalName: k };
            });
            if (wynnItems) {
                Object.keys(wynnItems).forEach(k => {
                    const lower = k.trim().toLowerCase();
                    if (!GLOBAL_ITEM_LOOKUP[lower]) {
                        const item = wynnItems[k];
                        GLOBAL_ITEM_LOOKUP[lower] = { originalName: item.name || k, lvl: item.level || 0, tier: item.tier || 0, profs: item.professions || [], stats: [] };
                    }
                });
            }

            const entityRegistry = {};

            const getSanitizedName = (name) => {
                // Persistent fix for "Dead Miner, ..." duplicate types
                return name.split(',')[0].trim();
            };

            const addCoordUnique = (entityKey, c) => {
                if (!isNum(c.x) || !isNum(c.z)) return;
                const nx = Number(c.x), ny = isNum(c.y) ? Number(c.y) : 0, nz = Number(c.z);
                if (Math.abs(nx) + Math.abs(ny) + Math.abs(nz) === 0) return; // Ignore 0,0,0
                
                const coordObj = { x: nx, y: isNum(c.y) ? ny : null, z: nz };
                const coordKey = `${coordObj.x}|${coordObj.z}`; // Key by XZ to merge similar spawn spots
                
                if (!entityRegistry[entityKey].uniqueCoords.has(coordKey)) {
                    entityRegistry[entityKey].uniqueCoords.add(coordKey);
                    entityRegistry[entityKey].coords.push(coordObj);
                }
            };

            const ensureEntity = (name) => {
                const cleanName = getSanitizedName(name);
                const key = cleanName.toLowerCase();
                if (!entityRegistry[key]) {
                    entityRegistry[key] = {
                        name: cleanName,
                        locations: new Set(),
                        screenshots: new Set(),
                        loot: new Set(),
                        coords: [],
                        uniqueCoords: new Set()
                    };
                }
                return key;
            };

            // Ingest drops.json
            Object.keys(dropsMap).forEach(itemName => {
                const drops = dropsMap[itemName];
                if (!Array.isArray(drops)) return;
                drops.forEach(d => {
                    if (!d.name) return;
                    const key = ensureEntity(d.name);
                    if (d.details?.location) entityRegistry[key].locations.add(d.details.location.trim());
                    if (d.details?.screenshots) entityRegistry[key].screenshots.add(d.details.screenshots);
                    entityRegistry[key].loot.add(itemName.trim().toLowerCase());
                    if (d.details?.coords) {
                        const cs = Array.isArray(d.details.coords) ? d.details.coords : [d.details.coords];
                        cs.forEach(c => addCoordUnique(key, c));
                    }
                });
            });

            // Ingest htoi.json
            htoiArray.forEach(h => {
                const itemName = h.name;
                Object.keys(h).forEach(prop => {
                    if (['name', 'id', 'level'].includes(prop)) return;
                    try {
                        const parsed = JSON.parse(h[prop]);
                        if (Array.isArray(parsed)) {
                            parsed.forEach(e => {
                                const name = e.name || e.description || prop.toUpperCase();
                                const key = ensureEntity(name);
                                if (e.location) entityRegistry[key].locations.add(e.location.trim());
                                if (itemName) entityRegistry[key].loot.add(itemName.trim().toLowerCase());
                                const cs = e.location_coords || e.coords;
                                if (cs) {
                                    const csArr = Array.isArray(cs) ? cs : [cs];
                                    csArr.forEach(c => addCoordUnique(key, c));
                                }
                            });
                        }
                    } catch(e) {}
                });
            });

            // Global Stitching Pass: Merge entities that share coordinates OR sanitized names
            let flattened = Object.values(entityRegistry);
            let merged = true;
            while(merged) {
                merged = false;
                for(let i = 0; i < flattened.length; i++) {
                    for(let j = i + 1; j < flattened.length; j++) {
                        const nameOverlap = flattened[i].name.toLowerCase() === flattened[j].name.toLowerCase();
                        const coordOverlap = [...flattened[i].uniqueCoords].some(c => flattened[j].uniqueCoords.has(c));
                        
                        if(nameOverlap || coordOverlap) {
                            flattened[i].locations = new Set([...flattened[i].locations, ...flattened[j].locations]);
                            flattened[i].loot = new Set([...flattened[i].loot, ...flattened[j].loot]);
                            flattened[i].screenshots = new Set([...flattened[i].screenshots, ...flattened[j].screenshots]);
                            // Merge coords
                            flattened[j].coords.forEach(c => {
                                const ck = `${c.x}|${c.z}`;
                                if (!flattened[i].uniqueCoords.has(ck)) {
                                    flattened[i].uniqueCoords.add(ck);
                                    flattened[i].coords.push(c);
                                }
                            });
                            flattened.splice(j, 1);
                            merged = true;
                            break;
                        }
                    }
                    if(merged) break;
                }
            }

            SOURCE_DATA = flattened.map(ent => {
                const lootDetails = Array.from(ent.loot).map(lootName => {
                    const info = GLOBAL_ITEM_LOOKUP[lootName] || { originalName: lootName, stats: [], lvl: 0, tier: -1, profs: [] };
                    return { name: info.originalName, level: Number(info.lvl) || 0, tier: info.tier !== undefined ? Number(info.tier) : -1, professions: info.profs || [], stats: info.stats || [] };
                });
                lootDetails.sort((a,b) => b.level - a.level);
                const locArr = Array.from(ent.locations);
                return {
                    name: ent.name,
                    location: locArr.length > 0 ? locArr.join(' | ') : "Undisclosed Sector",
                    screenshots: Array.from(ent.screenshots).flatMap(s => s.split(',')).map(s => s.trim()),
                    loot: lootDetails,
                    coords: ent.coords,
                    searchStr: [ent.name, ...lootDetails.map(l => l.name)].join(' ').toLowerCase()
                };
            });

            computeState();
            render();
        }

        function computeState() {
            const allItems = Object.values(GLOBAL_ITEM_LOOKUP);
            STATE.allProfs = [...new Set(allItems.flatMap(i => i.profs || []))].sort();
            STATE.allPosStats = [...new Set(allItems.flatMap(i => (i.stats || []).filter(s => s.pos).map(s => s.label)))].sort();
            STATE.allNegStats = [...new Set(allItems.flatMap(i => (i.stats || []).filter(s => !s.pos).map(s => s.label)))].sort();
            document.getElementById('posStat1').innerHTML = '<option value="">All Attributes</option>' + STATE.allPosStats.map(s => `<option value="${s}">${s}</option>`).join('');
            document.getElementById('negStat1').innerHTML = '<option value="">All Attributes</option>' + STATE.allNegStats.map(s => `<option value="${s}">${s}</option>`).join('');
            document.getElementById('professionFilters').innerHTML = STATE.allProfs.map(p => `<button data-prof="${p}" class="prof-chip input-base px-4 py-3 rounded-xl text-[10px] font-black uppercase tracking-wider">${p}</button>`).join('');
        }

        function filterData() {
            return SOURCE_DATA.filter(src => {
                if (STATE.search && !src.searchStr.includes(STATE.search.toLowerCase())) return false;
                if (STATE.coordsOnly && src.coords.length === 0) return false;
                if (STATE.interestOnly && !src.loot.some(l => INTEREST_NAMES.has(l.name.toLowerCase()))) return false;
                const hasMatchingLoot = src.loot.some(l => {
                    if (l.level < STATE.minLv || l.level > STATE.maxLv) return false;
                    if (STATE.tiers.size > 0 && !STATE.tiers.has(l.tier.toString())) return false;
                    if (STATE.profs.size > 0 && !l.professions.some(p => STATE.profs.has(p))) return false;
                    if (STATE.posStat1 && !l.stats.some(s => s.label === STATE.posStat1 && s.pos)) return false;
                    if (STATE.negStat1 && !l.stats.some(s => s.label === STATE.negStat1 && !s.pos)) return false;
                    return true;
                });
                const anyLootFilters = STATE.minLv > 0 || STATE.maxLv < 115 || STATE.tiers.size > 0 || STATE.profs.size > 0 || STATE.posStat1 || STATE.negStat1;
                if (anyLootFilters && !hasMatchingLoot) return false;
                return true;
            }).sort((a,b) => a.name.localeCompare(b.name));
        }

        function render() {
            const grid = document.getElementById('sourceGrid'), info = document.getElementById('resultsInfo');
            const data = filterData();
            const view = data.slice(0, 60);
            info.textContent = data.length > 0 ? `${data.length} Strategic Sources Synced` : "Matrix Idle...";
            if (view.length === 0) { grid.innerHTML = ""; document.getElementById('emptyState').classList.remove('hidden'); }
            else {
                document.getElementById('emptyState').classList.add('hidden');
                grid.innerHTML = view.map(src => {
                    const coordsHtml = src.coords.map(c => {
                        const hasY = isNum(c.y);
                        const label = hasY ? `${c.x}, ${c.y}, ${c.z}` : `${c.x}, ${c.z}`;
                        return `<button onclick="copyToClipboard('${c.x}','${c.y}','${c.z}')" class="coord-btn mono">${label}</button>`;
                    }).join('');
                    const lootHtml = src.loot.map(l => `
                        <div class="loot-pill">
                            <div class="flex justify-between items-start mb-4">
                                <div class="overflow-hidden">
                                    <h4 class="text-[12px] font-black uppercase truncate text-[var(--text-primary)]">${l.name}</h4>
                                    <div class="flex items-center gap-3 mt-1.5">
                                        <span class="mono text-[9px] font-black" style="color: var(--accent-hover)">LV.${l.level}</span>
                                        <div class="flex gap-1 text-amber-500 text-[9px]">${l.tier >= 0 ? Array(l.tier).fill('â˜…').join('') : ''}</div>
                                    </div>
                                </div>
                            </div>
                            <div class="flex flex-wrap gap-2">
                                ${l.stats.slice(0, 4).map(s => `<span class="stat-badge ${s.pos ? 'text-[var(--status-green)]' : 'text-[var(--status-red)]'}">${s.label}: ${s.value}</span>`).join('')}
                            </div>
                        </div>
                    `).join('');
                    return `
                    <div class="archive-card p-10">
                        <div class="flex justify-between items-start mb-8">
                            <div class="flex-1 overflow-hidden">
                                <h3 class="text-lg font-black tracking-tighter truncate uppercase pr-4">${src.name}</h3>
                                <div class="flex items-center gap-2 mt-2 opacity-60">
                                    <i class="fas fa-compass text-[10px]"></i>
                                    <p class="text-[10px] font-black truncate uppercase tracking-widest leading-none">${src.location}</p>
                                </div>
                            </div>
                            ${src.screenshots.length > 0 ? `<a href="${src.screenshots[0]}" target="_blank" class="w-12 h-12 flex items-center justify-center rounded-2xl bg-[var(--accent)] text-white hover:scale-110 transition-all shadow-lg"><i class="fas fa-camera text-sm"></i></a>` : ''}
                        </div>
                        <div class="mb-10">
                            <p class="text-[9px] font-black uppercase tracking-[0.25em] text-[var(--text-secondary)] mb-5 opacity-40">Tactical Geolocation</p>
                            <div class="flex flex-wrap gap-3">${coordsHtml || '<span class="text-[10px] font-black opacity-10 uppercase italic tracking-widest">Signal Missing</span>'}</div>
                        </div>
                        <div class="flex-1 overflow-y-auto max-h-[380px] custom-scrollbar pr-3">
                            <p class="text-[9px] font-black uppercase tracking-[0.25em] text-[var(--text-secondary)] mb-5 opacity-40">Inventory Link (${src.loot.length})</p>
                            ${lootHtml}
                        </div>
                    </div>
                `}).join('');
            }
            renderActiveTags();
        }

        function updateTheme() {
            const root = document.documentElement;
            const palettes = {
                sage: { hue: 80, sat: 20, acc: '#a3b18a', hov: '#588157' },
                ocean: { hue: 200, sat: 25, acc: '#72a1b1', hov: '#457b9d' },
                crimson: { hue: 0, sat: 25, acc: '#b17272', hov: '#8a4a4a' },
                amber: { hue: 35, sat: 25, acc: '#b19672', hov: '#8a704a' },
                lavender: { hue: 260, sat: 20, acc: '#8c72b1', hov: '#5b4a8a' }
            };
            const p = palettes[STATE.palette];
            
            let b, c, s, t, sec, brd;
            switch(STATE.brightness) {
                case 1: 
                    b = `hsl(${p.hue}, ${p.sat}%, 6%)`; c = `hsl(${p.hue}, ${p.sat}%, 10%)`; s = `hsl(${p.hue}, ${p.sat}%, 14%)`;
                    t = '#ffffff'; sec = '#888888'; brd = 'rgba(255,255,255,0.1)'; break;
                case 2:
                    b = `hsl(${p.hue}, ${p.sat}%, 18%)`; c = `hsl(${p.hue}, ${p.sat}%, 22%)`; s = `hsl(${p.hue}, ${p.sat}%, 26%)`;
                    t = '#e2e8f0'; sec = '#94a3b8'; brd = 'rgba(255,255,255,0.06)'; break;
                case 3: 
                    b = `hsl(${p.hue}, ${p.sat}%, 38%)`; c = `hsl(${p.hue}, ${p.sat}%, 44%)`; s = `hsl(${p.hue}, ${p.sat}%, 48%)`;
                    t = '#ffffff'; sec = '#cbd5e1'; brd = 'rgba(255,255,255,0.15)'; break;
                case 4:
                    b = `hsl(${p.hue}, ${p.sat}%, 68%)`; c = `hsl(${p.hue}, ${p.sat}%, 96%)`; s = `hsl(${p.hue}, ${p.sat}%, 82%)`;
                    t = '#4a4641'; sec = '#8a847c'; brd = 'rgba(0,0,0,0.1)'; break;
                case 5:
                    b = `hsl(${p.hue}, ${p.sat}%, 86%)`; c = '#ffffff'; s = '#fcfcfc';
                    t = '#1e293b'; sec = '#64748b'; brd = 'rgba(0,0,0,0.06)'; break;
            }

            root.style.setProperty('--bg-body', b);
            root.style.setProperty('--bg-card', c);
            root.style.setProperty('--bg-surface', s);
            root.style.setProperty('--text-primary', t);
            root.style.setProperty('--text-secondary', sec);
            root.style.setProperty('--border', brd);
            root.style.setProperty('--accent', p.acc);
            root.style.setProperty('--accent-hover', p.hov);

            document.querySelectorAll('#brightnessPresets button').forEach(b => b.classList.toggle('active', parseInt(b.dataset.level) === STATE.brightness));
            document.querySelectorAll('#palettePresets button').forEach(b => b.classList.toggle('active', b.dataset.palette === STATE.palette));
        }

        function renderActiveTags() {
            const container = document.getElementById('activeTags');
            const tags = [];
            if (STATE.search) tags.push({ id: 'search', val: STATE.search });
            if (STATE.interestOnly) tags.push({ id: 'interest', val: 'Featured' });
            if (STATE.coordsOnly) tags.push({ id: 'coords', val: 'Geolocated' });
            STATE.tiers.forEach(t => tags.push({ id: 'tier-'+t, val: `Tier ${t}` }));
            STATE.profs.forEach(p => tags.push({ id: 'prof-'+p, val: p }));
            container.innerHTML = tags.map(t => `
                <div class="flex items-center gap-3 px-5 py-2.5 bg-[var(--accent)]/10 text-[var(--accent-hover)] border border-[var(--accent)]/20 rounded-2xl text-[10px] font-black uppercase tracking-widest shadow-sm">
                    ${t.val}
                    <button onclick="removeFilter('${t.id}')" class="hover:opacity-50 transition-opacity"><i class="fas fa-times"></i></button>
                </div>
            `).join('');
        }

        function copyToClipboard(x, y, z) {
            const hasY = isNum(y) && y !== 'null' && y !== 'undefined';
            const cmd = hasY ? `/compass ${x}, ${y}, ${z}` : `/compass ${x}, ${z}`;
            const el = document.createElement('textarea'); 
            el.value = cmd; el.style.position = "fixed"; el.style.left = "-9999px"; 
            document.body.appendChild(el); el.select();
            try {
                document.execCommand('copy'); 
                const t = document.getElementById('toast'); 
                t.textContent = "COPIED: " + cmd; 
                t.classList.add('show');
                setTimeout(() => t.classList.remove('show'), 2500);
            } catch(e) {}
            document.body.removeChild(el);
        }

        function removeFilter(id) {
            if (id === 'search') { STATE.search = ""; document.getElementById('globalSearch').value = ""; }
            else if (id === 'interest') { STATE.interestOnly = false; document.getElementById('interestToggle').classList.remove('active'); }
            else if (id === 'coords') { STATE.coordsOnly = false; document.getElementById('coordsToggle').classList.remove('active'); }
            else if (id.startsWith('tier-')) { STATE.tiers.delete(id.split('-')[1]); document.querySelectorAll('.tier-btn').forEach(b => { if(b.dataset.tier == id.split('-')[1]) b.classList.remove('active'); }); }
            else if (id.startsWith('prof-')) { STATE.profs.delete(id.split('-')[1]); document.querySelectorAll('.prof-chip').forEach(b => { if(b.dataset.prof == id.split('-')[1]) b.classList.remove('active'); }); }
            render();
        }

        function clearAllFilters() {
            STATE.search = ""; STATE.tiers.clear(); STATE.profs.clear(); STATE.interestOnly = false; STATE.coordsOnly = false; STATE.minLv = 0; STATE.maxLv = 115;
            document.getElementById('globalSearch').value = "";
            document.querySelectorAll('.active').forEach(e => { if(!e.classList.contains('preset-dot') && !e.classList.contains('brightness-dot')) e.classList.remove('active'); });
            document.querySelectorAll('input[type="number"]').forEach(i => i.value = "");
            render();
        }

        document.getElementById('toggleFilters').addEventListener('click', () => { document.getElementById('filterSidebar').classList.add('open'); document.getElementById('sidebarOverlay').classList.replace('opacity-0', 'opacity-100'); document.getElementById('sidebarOverlay').classList.remove('pointer-events-none'); });
        document.getElementById('closeSidebar').addEventListener('click', () => { document.getElementById('filterSidebar').classList.remove('open'); document.getElementById('sidebarOverlay').classList.replace('opacity-100', 'opacity-0'); document.getElementById('sidebarOverlay').classList.add('pointer-events-none'); });
        document.getElementById('sidebarOverlay').addEventListener('click', () => { document.getElementById('filterSidebar').classList.remove('open'); document.getElementById('sidebarOverlay').classList.replace('opacity-100', 'opacity-0'); document.getElementById('sidebarOverlay').classList.add('pointer-events-none'); });
        document.getElementById('brightnessPresets').addEventListener('click', e => { const btn = e.target.closest('button'); if(!btn) return; STATE.brightness = parseInt(btn.dataset.level); updateTheme(); });
        document.getElementById('palettePresets').addEventListener('click', e => { const btn = e.target.closest('button'); if(!btn) return; STATE.palette = btn.dataset.palette; updateTheme(); });
        document.getElementById('globalSearch').addEventListener('input', debounce(e => { STATE.search = e.target.value; render(); }, 250));
        document.getElementById('minLevel').addEventListener('input', e => { STATE.minLv = Number(e.target.value) || 0; render(); });
        document.getElementById('maxLevel').addEventListener('input', e => { STATE.maxLv = Number(e.target.value) || 115; render(); });
        document.getElementById('posStat1').addEventListener('change', e => { STATE.posStat1 = e.target.value; render(); });
        document.getElementById('negStat1').addEventListener('change', e => { STATE.negStat1 = e.target.value; render(); });
        document.querySelectorAll('.tier-btn').forEach(b => b.addEventListener('click', () => { const t = b.dataset.tier; if (STATE.tiers.has(t)) STATE.tiers.delete(t); else STATE.tiers.add(t); b.classList.toggle('active'); render(); }));
        document.getElementById('professionFilters').addEventListener('click', e => { const b = e.target.closest('.prof-chip'); if (!b) return; const p = b.dataset.prof; if (STATE.profs.has(p)) STATE.profs.delete(p); else STATE.profs.add(p); b.classList.toggle('active'); render(); });
        document.getElementById('interestToggle').addEventListener('click', e => { STATE.interestOnly = !STATE.interestOnly; e.currentTarget.classList.toggle('active'); render(); });
        document.getElementById('coordsToggle').addEventListener('click', e => { STATE.coordsOnly = !STATE.coordsOnly; e.currentTarget.classList.toggle('active'); render(); });

        window.onload = () => { loadShopData(); updateTheme(); };
    </script>
</body>
</html>
