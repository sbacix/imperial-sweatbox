<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Imperial Archives | Library</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;700&display=swap');

        :root {
            --bg-body: #0a0a0c;
            --bg-card: #121216;
            --bg-surface: #1a1a20;
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
            --accent: #6366f1;
            --accent-glow: rgba(99, 102, 241, 0.15);
            --border: rgba(255, 255, 255, 0.06);
        }

        body.light {
            --bg-body: #f8fafc;
            --bg-card: #ffffff;
            --bg-surface: #f1f5f9;
            --text-primary: #0f172a;
            --text-secondary: #64748b;
            --accent: #4f46e5;
            --accent-glow: rgba(79, 70, 229, 0.1);
            --border: rgba(0, 0, 0, 0.08);
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-body);
            color: var(--text-primary);
            transition: all 0.3s ease;
            overflow-x: hidden;
        }

        .mono { font-family: 'JetBrains Mono', monospace; }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-body); }
        ::-webkit-scrollbar-thumb { background: var(--bg-surface); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--accent); }

        /* Card Stylings */
        .archive-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .archive-card:hover {
            transform: translateY(-4px);
            border-color: var(--accent);
            box-shadow: 0 12px 30px -10px var(--accent-glow);
        }

        .archive-card::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; height: 2px;
            background: linear-gradient(90deg, transparent, var(--accent), transparent);
            opacity: 0;
            transition: opacity 0.3s;
        }

        .archive-card:hover::before { opacity: 1; }

        /* Inputs & Buttons */
        .input-base {
            background: var(--bg-surface);
            border: 1px solid var(--border);
            color: var(--text-primary);
            transition: all 0.2s;
        }

        .input-base:focus {
            border-color: var(--accent);
            outline: none;
            box-shadow: 0 0 0 3px var(--accent-glow);
        }

        .btn-primary {
            background: var(--accent);
            color: white;
            transition: all 0.2s;
        }

        .btn-primary:hover {
            filter: brightness(1.1);
            transform: scale(1.02);
        }

        .btn-secondary {
            background: var(--bg-surface);
            border: 1px solid var(--border);
            color: var(--text-secondary);
        }

        .btn-secondary:hover {
            background: var(--bg-card);
            color: var(--text-primary);
            border-color: var(--accent);
        }

        /* Sidebar Logic */
        #filterSidebar {
            background: var(--bg-card);
            border-left: 1px solid var(--border);
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        #filterSidebar.open { transform: translateX(0); }

        /* Stats Coloring */
        .stat-positive { color: #10b981; }
        .stat-negative { color: #ef4444; }

        /* Tooltips/Toast */
        #toast {
            position: fixed;
            bottom: 2rem;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--accent);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 9999px;
            font-weight: 600;
            font-size: 0.875rem;
            z-index: 1000;
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 10px 25px -5px rgba(0,0,0,0.3);
        }
        #toast.show { transform: translateX(-50%) translateY(0); }

        /* Toggle States */
        .toggle-btn.active {
            background: var(--accent);
            border-color: var(--accent);
            color: white !important;
        }
    </style>
</head>
<body class="min-h-screen">

    <div id="toast">Coordinates Copied to Clipboard</div>

    <!-- Header -->
    <header class="sticky top-0 z-40 w-full bg-[var(--bg-body)]/80 backdrop-blur-md border-b border-[var(--border)]">
        <div class="max-w-[1600px] mx-auto px-6 h-20 flex items-center justify-between">
            <div class="flex items-center gap-4">
                <div class="w-10 h-10 bg-indigo-600 rounded-lg flex items-center justify-center text-white shadow-lg shadow-indigo-500/20">
                    <i class="fas fa-book-atlas text-xl"></i>
                </div>
                <div>
                    <h1 class="text-lg font-extrabold tracking-tight uppercase">Library of <span class="text-indigo-500">Imperial</span></h1>
                    <p class="text-[10px] text-[var(--text-secondary)] font-bold tracking-[0.2em] uppercase opacity-60">Global Inventory Database</p>
                </div>
            </div>

            <div class="hidden md:flex flex-1 max-w-xl mx-12 relative">
                <i class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-[var(--text-secondary)] opacity-50"></i>
                <input 
                    type="text" id="globalSearch" 
                    placeholder="Search artifacts, drops, or properties..."
                    class="w-full input-base rounded-full py-2.5 pl-11 pr-6 text-sm"
                >
            </div>

            <div class="flex items-center gap-3">
                <button id="themeToggle" class="btn-secondary w-10 h-10 rounded-full flex items-center justify-center">
                    <i class="fas fa-moon" id="themeIcon"></i>
                </button>
                <button id="toggleFilters" class="btn-primary px-5 py-2.5 rounded-full text-xs font-bold uppercase tracking-wider flex items-center gap-2">
                    <i class="fas fa-sliders-h"></i>
                    <span>Controls</span>
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-[1600px] mx-auto px-6 py-10">
        <!-- Breadcrumbs / Active Tags -->
        <div id="activeTags" class="flex flex-wrap gap-2 mb-8 min-h-[32px]"></div>

        <!-- Meta Info -->
        <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-8">
            <div id="resultsInfo" class="text-xs font-bold text-[var(--text-secondary)] uppercase tracking-widest bg-[var(--bg-surface)] px-4 py-2 rounded-lg inline-block border border-[var(--border)]">
                Initializing Archive...
            </div>
            <div class="flex items-center gap-4">
                <span class="text-[10px] font-bold text-[var(--text-secondary)] uppercase">Sort By:</span>
                <select id="sortBy" class="input-base text-[10px] font-bold uppercase px-3 py-1.5 rounded-lg outline-none cursor-pointer">
                    <option value="name">Alphanumeric</option>
                    <option value="level">Level (Descending)</option>
                    <option value="tier">Quality Tier</option>
                </select>
            </div>
        </div>

        <!-- Grid -->
        <div id="ingredientGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6"></div>

        <!-- Empty State -->
        <div id="emptyState" class="hidden py-32 flex flex-col items-center text-center">
            <div class="w-20 h-20 bg-[var(--bg-surface)] rounded-3xl flex items-center justify-center mb-6 border border-[var(--border)]">
                <i class="fas fa-folder-open text-3xl opacity-20"></i>
            </div>
            <h3 class="text-xl font-bold mb-2">No Matches Found</h3>
            <p class="text-[var(--text-secondary)] text-sm mb-6">Your query did not return any records from the imperial database.</p>
            <button onclick="clearAllFilters()" class="text-indigo-500 font-bold uppercase text-xs tracking-widest hover:underline">Reset Archives</button>
        </div>
    </main>

    <!-- Sidebar Filter -->
    <div id="sidebarOverlay" class="fixed inset-0 bg-black/40 z-[50] opacity-0 pointer-events-none transition-opacity duration-300"></div>
    <aside id="filterSidebar" class="fixed top-0 right-0 h-full w-[350px] z-[60] transform translate-x-full shadow-2xl flex flex-col">
        <div class="p-6 border-b border-[var(--border)] flex items-center justify-between">
            <h2 class="font-black text-sm uppercase tracking-widest">Filter Matrix</h2>
            <button id="closeSidebar" class="text-[var(--text-secondary)] hover:text-[var(--text-primary)]"><i class="fas fa-times"></i></button>
        </div>

        <div class="flex-1 overflow-y-auto p-6 space-y-8 custom-scrollbar">
            <!-- Tiers -->
            <section class="space-y-4">
                <label class="text-[10px] font-bold text-[var(--text-secondary)] uppercase tracking-[0.2em]">Quality Tier</label>
                <div class="grid grid-cols-4 gap-2" id="tierFilters">
                    <button data-tier="0" class="tier-btn input-base py-2 rounded-lg text-xs font-bold">T0</button>
                    <button data-tier="1" class="tier-btn input-base py-2 rounded-lg text-xs font-bold">T1</button>
                    <button data-tier="2" class="tier-btn input-base py-2 rounded-lg text-xs font-bold">T2</button>
                    <button data-tier="3" class="tier-btn input-base py-2 rounded-lg text-xs font-bold">T3</button>
                </div>
            </section>

            <!-- Shortcuts -->
            <section class="space-y-4">
                <label class="text-[10px] font-bold text-[var(--text-secondary)] uppercase tracking-[0.2em]">Priority Toggles</label>
                <div class="space-y-2">
                    <button id="interestToggle" class="toggle-btn btn-secondary w-full py-3 rounded-xl text-[10px] font-bold uppercase tracking-wider flex items-center justify-center gap-2">
                        <i class="fas fa-bookmark text-amber-500"></i> High Interest
                    </button>
                    <button id="coordsToggle" class="toggle-btn btn-secondary w-full py-3 rounded-xl text-[10px] font-bold uppercase tracking-wider flex items-center justify-center gap-2">
                        <i class="fas fa-location-crosshairs text-indigo-500"></i> Has Coordinates
                    </button>
                </div>
            </section>

            <!-- Level Range -->
            <section class="space-y-4">
                <label class="text-[10px] font-bold text-[var(--text-secondary)] uppercase tracking-[0.2em]">Level Parameters</label>
                <div class="flex items-center gap-3">
                    <input type="number" id="minLevel" placeholder="MIN" class="w-full input-base rounded-lg px-3 py-2 text-sm font-bold">
                    <div class="h-[1px] w-4 bg-[var(--border)]"></div>
                    <input type="number" id="maxLevel" placeholder="MAX" class="w-full input-base rounded-lg px-3 py-2 text-sm font-bold">
                </div>
            </section>

            <!-- Stat Selects -->
            <section class="space-y-6">
                <div>
                    <label class="block text-[10px] font-bold text-emerald-500 uppercase tracking-widest mb-3">Positive Affinity</label>
                    <select id="posStat1" class="w-full input-base rounded-lg px-3 py-2 text-xs font-bold outline-none"></select>
                </div>
                <div>
                    <label class="block text-[10px] font-bold text-rose-500 uppercase tracking-widest mb-3">Negative Affinity</label>
                    <select id="negStat1" class="w-full input-base rounded-lg px-3 py-2 text-xs font-bold outline-none"></select>
                </div>
            </section>

            <!-- Professions -->
            <section class="space-y-4 pb-12">
                <label class="text-[10px] font-bold text-[var(--text-secondary)] uppercase tracking-widest">Authorized Professions</label>
                <div id="professionFilters" class="flex flex-wrap gap-2"></div>
            </section>
        </div>

        <div class="p-6 border-t border-[var(--border)]">
            <button onclick="clearAllFilters()" class="w-full py-3 rounded-xl text-xs font-bold uppercase tracking-widest bg-rose-500/10 text-rose-500 border border-rose-500/20 hover:bg-rose-500 hover:text-white transition-all">
                Clear Matrix
            </button>
        </div>
    </aside>

    <script>
        // DATA & STATE
        const MANUAL_INTEREST_LIST = [
            "Adamastor's Faceplate", "Ancient Heart", "Archaic Medallion", "Bat Heart", "Borange Fluff",
            "Cat Food", "Cataratite", "Coalescence", "Colossus' Shard", "Contraband Absinthe",
            "Contraband Hibiscus", "Creepvine Cluster", "Cursed Wings", "Cyclone Blue Leaves",
            "Death Whistle Leaf", "Decaying Heart", "Defiled Luxroot", "Defishious", "Dernic Parasite",
            "Doom Stone", "Draconic Bone Marrow", "Earthly Aura", "Elephelk Trunk", "Enhanced Behaviour Microchip",
            "Enhanced Potential Microchip", "Evolving Spores", "Eye of The Beast", "Fairy Powder",
            "Farcor's Trust", "Fiery Aura", "Flow of Fate", "Gilded Bark", "Glacial Anomaly",
            "Glowing Tree Sap", "Haleva Plant", "Haphazard Serum", "Ice Cream Sandwich", "Kerasot Sporehead",
            "Large Titanium Chunk", "Lashing Hellfire", "Lithoflesh", "Letvus Delight", "Lunar Charm",
            "Luxrooot Cuttings", "Mangrove Root", "Mellow Mango", "Myconid Spores", "Myocardial Leg",
            "Naval Stone", "Nightmare Fuel", "Nivlan Honey", "Obelisk Core", "Plane of Nonexistence",
            "Pride of the Heights", "Prismatic Spores", "Red Mercury", "Remedial Paste", "Ritual Catalyst",
            "Rock-Hard Beak", "Sentient Leukocyte", "Serpent Tongue", "Shattered Dawnlight", "Shrieker's Head",
            "Smokebomb", "Soulbound Cinders", "Tentacle", "Throbbing Avos Heart", "Unicorn Horn",
            "Watery Aura", "Windy Aura", "World Illuminator"
        ];
        const INTEREST_NAMES = new Set(MANUAL_INTEREST_LIST.map(n => n.trim().toLowerCase()));
        
        let RAW_DATA = [];
        const STATE = {
            search: "", minLv: 0, maxLv: 115, tiers: new Set(), profs: new Set(),
            posStat1: "", negStat1: "", interestOnly: false, coordsOnly: false, theme: "dark",
            sortBy: "name", allProfs: [], allPosStats: [], allNegStats: []
        };

        const isNum = (v) => v !== null && v !== undefined && v !== "" && isFinite(Number(v));
        function debounce(func, wait) {
            let timeout; return function(...args) { clearTimeout(timeout); timeout = setTimeout(() => func.apply(this, args), wait); };
        }

        async function loadShopData() {
            let ingredients = {}, drops = {}, htoi = [], wynnItems = {};
            try {
                const [resI, resD, resH] = await Promise.all([
                    fetch('ingredients.json').then(r => r.ok ? r.json() : {}),
                    fetch('drops.json').then(r => r.ok ? r.json() : {}),
                    fetch('htoi.json').then(r => r.ok ? r.json() : [])
                ]);
                ingredients = resI; drops = resD; htoi = resH;
                const wynnRes = await fetch('https://api.wynncraft.com/v3/item/database?fullResult');
                if (wynnRes.ok) wynnItems = await wynnRes.json();
            } catch (e) { console.error("Data Fetch Error", e); }
            processJsonData(ingredients, drops, htoi, wynnItems);
        }

        function processJsonData(ingredients, dropsMap, htoiArray, wynnItems) {
            const processed = [];
            const normIngredients = {};
            Object.keys(ingredients).forEach(k => normIngredients[k.trim().toLowerCase()] = { ...ingredients[k], originalName: k });
            
            const sharedTelemetry = {};
            Object.values(dropsMap).forEach(dropArray => {
                if (!Array.isArray(dropArray)) return;
                dropArray.forEach(d => {
                    const mobKey = d.name?.toLowerCase();
                    if (!mobKey) return;
                    if (!sharedTelemetry[mobKey]) sharedTelemetry[mobKey] = [];
                    const coords = Array.isArray(d.details?.coords) ? d.details.coords : [d.details?.coords].filter(x => x);
                    coords.forEach(c => {
                        if (isNum(c.x) && isNum(c.z)) {
                            const coordObj = { x: Number(c.x), y: isNum(c.y) ? Number(c.y) : null, z: Number(c.z) };
                            if (!sharedTelemetry[mobKey].some(ex => ex.x === coordObj.x && ex.z === coordObj.z)) sharedTelemetry[mobKey].push(coordObj);
                        }
                    });
                });
            });

            const allKeys = new Set([...Object.keys(normIngredients), ...Object.keys(dropsMap).map(k => k.toLowerCase())]);
            for (const key of allKeys) {
                const ing = normIngredients[key] || {};
                const drps = (dropsMap[key] || []).concat((htoiArray.find(h => h.name?.toLowerCase() === key)?.drops || []));
                const item = {
                    name: ing.originalName || key.toUpperCase(),
                    level: Number(ing.lvl) || 0,
                    tier: ing.tier !== undefined ? Number(ing.tier) : -1,
                    professions: ing.profs || [],
                    stats: ing.stats || [],
                    drops: drps.map(d => ({
                        name: d.name || "Unknown",
                        location: d.details?.location || "Unknown",
                        coords: sharedTelemetry[d.name?.toLowerCase()] || []
                    })),
                    searchStr: key
                };
                item.searchStr = [item.name, ...item.professions, ...item.stats.map(s => s.label)].join(' ').toLowerCase();
                processed.push(item);
            }
            RAW_DATA = processed;
            computeState();
            render();
        }

        function computeState() {
            STATE.allProfs = [...new Set(RAW_DATA.flatMap(i => i.professions))].sort();
            STATE.allPosStats = [...new Set(RAW_DATA.flatMap(i => i.stats.filter(s => s.pos).map(s => s.label)))].sort();
            STATE.allNegStats = [...new Set(RAW_DATA.flatMap(i => i.stats.filter(s => !s.pos).map(s => s.label)))].sort();
            
            const ps = document.getElementById('posStat1'), ns = document.getElementById('negStat1'), pf = document.getElementById('professionFilters');
            ps.innerHTML = '<option value="">All Attributes</option>' + STATE.allPosStats.map(s => `<option value="${s}">${s}</option>`).join('');
            ns.innerHTML = '<option value="">All Attributes</option>' + STATE.allNegStats.map(s => `<option value="${s}">${s}</option>`).join('');
            pf.innerHTML = STATE.allProfs.map(p => `<button data-prof="${p}" class="prof-chip input-base px-3 py-1.5 rounded-lg text-[10px] font-bold uppercase tracking-wider">${p}</button>`).join('');
        }

        function filterData() {
            let data = RAW_DATA.filter(i => {
                if (STATE.search && !i.searchStr.includes(STATE.search.toLowerCase())) return false;
                if (i.level < STATE.minLv || i.level > STATE.maxLv) return false;
                if (STATE.tiers.size && !STATE.tiers.has(i.tier.toString())) return false;
                if (STATE.profs.size && !i.professions.some(p => STATE.profs.has(p))) return false;
                if (STATE.interestOnly && !INTEREST_NAMES.has(i.name.toLowerCase())) return false;
                if (STATE.coordsOnly && !i.drops.some(d => d.coords.length > 0)) return false;
                if (STATE.posStat1 && !i.stats.some(s => s.label === STATE.posStat1 && s.pos)) return false;
                if (STATE.negStat1 && !i.stats.some(s => s.label === STATE.negStat1 && !s.pos)) return false;
                return true;
            });

            if (STATE.sortBy === "level") data.sort((a,b) => b.level - a.level);
            else if (STATE.sortBy === "tier") data.sort((a,b) => b.tier - a.tier);
            else data.sort((a,b) => a.name.localeCompare(b.name));

            return data;
        }

        function render() {
            const grid = document.getElementById('ingredientGrid'), info = document.getElementById('resultsInfo');
            const data = filterData();
            const view = data.slice(0, 100);
            
            info.textContent = data.length > 0 ? `${data.length} Archive Records Retrieved` : "No Records Match Current Matrix";
            
            if (view.length === 0) {
                grid.innerHTML = "";
                document.getElementById('emptyState').classList.remove('hidden');
            } else {
                document.getElementById('emptyState').classList.add('hidden');
                grid.innerHTML = view.map(item => `
                    <div class="archive-card rounded-2xl p-5 flex flex-col gap-5">
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <h3 class="text-sm font-bold tracking-tight mb-1 truncate pr-2 uppercase">${item.name}</h3>
                                <div class="flex items-center gap-2">
                                    <span class="mono text-[9px] font-bold bg-indigo-500/10 text-indigo-500 px-1.5 py-0.5 rounded">LV.${item.level}</span>
                                    <div class="flex gap-0.5 text-amber-500 text-[8px]">
                                        ${item.tier > 0 ? Array(item.tier).fill('<i class="fas fa-star"></i>').join('') : '<span class="opacity-30 uppercase font-black">Common</span>'}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="space-y-4">
                            <div class="space-y-1.5">
                                ${item.stats.length === 0 ? '<div class="h-12 flex items-center text-[10px] text-[var(--text-secondary)] opacity-40 italic">No statistical deviations.</div>' : 
                                    item.stats.slice(0, 4).map(s => `
                                    <div class="flex justify-between text-[11px] font-medium border-b border-[var(--border)] pb-1">
                                        <span class="text-[var(--text-secondary)] truncate pr-4">${s.label}</span>
                                        <span class="${s.pos ? 'stat-positive' : 'stat-negative'} mono font-bold">${s.value}</span>
                                    </div>
                                `).join('')}
                            </div>

                            <div class="space-y-3">
                                <p class="text-[9px] font-black uppercase tracking-widest text-[var(--text-secondary)] opacity-60">Field Reports</p>
                                ${item.drops.length === 0 ? '<p class="text-[10px] text-[var(--text-secondary)] opacity-30 italic">No sighting logs.</p>' : 
                                    item.drops.slice(0, 1).map(d => `
                                    <div class="bg-[var(--bg-surface)] p-3 rounded-xl border border-[var(--border)]">
                                        <p class="text-[11px] font-bold mb-1 truncate">${d.name}</p>
                                        <p class="text-[9px] text-[var(--text-secondary)] mb-2"><i class="fas fa-map-marker-alt mr-1"></i> ${d.location}</p>
                                        <div class="flex flex-wrap gap-1">
                                            ${d.coords.slice(0, 3).map(c => `
                                                <button onclick="copyToClipboard('${c.x}','${c.y}','${c.z}')" class="btn-secondary px-2 py-1 rounded-md text-[8px] mono font-bold hover:!bg-indigo-500 hover:!text-white">
                                                    ${c.x}, ${c.z}
                                                </button>
                                            `).join('')}
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>

                        <div class="mt-auto flex flex-wrap gap-1.5 pt-4 border-t border-[var(--border)]">
                            ${item.professions.map(p => `<span class="text-[8px] font-bold uppercase tracking-tighter bg-[var(--bg-surface)] text-[var(--text-secondary)] px-2 py-1 rounded border border-[var(--border)]">${p}</span>`).join('')}
                        </div>
                    </div>
                `).join('');
            }
            renderActiveTags();
        }

        function renderActiveTags() {
            const container = document.getElementById('activeTags');
            const tags = [];
            if (STATE.search) tags.push({ id: 'search', val: `Query: ${STATE.search}` });
            if (STATE.interestOnly) tags.push({ id: 'interest', val: 'Featured' });
            if (STATE.coordsOnly) tags.push({ id: 'coords', val: 'Localized' });
            STATE.tiers.forEach(t => tags.push({ id: 'tier-'+t, val: `Tier ${t}` }));
            STATE.profs.forEach(p => tags.push({ id: 'prof-'+p, val: p }));

            container.innerHTML = tags.map(t => `
                <div class="flex items-center gap-2 px-3 py-1 bg-indigo-500/10 text-indigo-500 border border-indigo-500/20 rounded-full text-[10px] font-bold uppercase">
                    ${t.val}
                    <button onclick="removeFilter('${t.id}')" class="hover:text-white transition-colors"><i class="fas fa-times"></i></button>
                </div>
            `).join('');
        }

        function removeFilter(id) {
            if (id === 'search') { STATE.search = ""; document.getElementById('globalSearch').value = ""; }
            else if (id === 'interest') { STATE.interestOnly = false; document.getElementById('interestToggle').classList.remove('active'); }
            else if (id === 'coords') { STATE.coordsOnly = false; document.getElementById('coordsToggle').classList.remove('active'); }
            else if (id.startsWith('tier-')) { STATE.tiers.delete(id.split('-')[1]); document.querySelectorAll('.tier-btn').forEach(b => { if(b.dataset.tier == id.split('-')[1]) b.classList.remove('active'); }); }
            else if (id.startsWith('prof-')) { STATE.profs.delete(id.split('-')[1]); document.querySelectorAll('.prof-chip').forEach(b => { if(b.dataset.prof == id.split('-')[1]) b.classList.remove('active'); }); }
            render();
        }

        function copyToClipboard(x, y, z) {
            const cmd = y !== 'null' ? `/compass ${x} ${y} ${z}` : `/compass ${x} ${z}`;
            const el = document.createElement('textarea'); el.value = cmd; document.body.appendChild(el); el.select();
            document.execCommand('copy'); document.body.removeChild(el);
            const t = document.getElementById('toast'); t.textContent = "COPIED: " + cmd; t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 2000);
        }

        function clearAllFilters() {
            STATE.search = ""; STATE.tiers.clear(); STATE.profs.clear(); 
            STATE.interestOnly = false; STATE.coordsOnly = false;
            STATE.minLv = 0; STATE.maxLv = 115;
            document.getElementById('globalSearch').value = "";
            document.querySelectorAll('.active').forEach(e => e.classList.remove('active'));
            document.querySelectorAll('input[type="number"]').forEach(i => i.value = "");
            render();
        }

        // EVENT LISTENERS
        document.getElementById('toggleFilters').addEventListener('click', () => {
            document.getElementById('filterSidebar').classList.add('open');
            document.getElementById('sidebarOverlay').classList.replace('opacity-0', 'opacity-100');
            document.getElementById('sidebarOverlay').classList.remove('pointer-events-none');
        });
        document.getElementById('closeSidebar').addEventListener('click', () => {
            document.getElementById('filterSidebar').classList.remove('open');
            document.getElementById('sidebarOverlay').classList.replace('opacity-100', 'opacity-0');
            document.getElementById('sidebarOverlay').classList.add('pointer-events-none');
        });
        document.getElementById('sidebarOverlay').addEventListener('click', () => document.getElementById('closeSidebar').click());

        document.getElementById('globalSearch').addEventListener('input', debounce(e => { STATE.search = e.target.value; render(); }, 250));
        document.getElementById('sortBy').addEventListener('change', e => { STATE.sortBy = e.target.value; render(); });
        document.getElementById('minLevel').addEventListener('input', e => { STATE.minLv = Number(e.target.value) || 0; render(); });
        document.getElementById('maxLevel').addEventListener('input', e => { STATE.maxLv = Number(e.target.value) || 115; render(); });
        document.getElementById('posStat1').addEventListener('change', e => { STATE.posStat1 = e.target.value; render(); });
        document.getElementById('negStat1').addEventListener('change', e => { STATE.negStat1 = e.target.value; render(); });
        
        document.querySelectorAll('.tier-btn').forEach(b => b.addEventListener('click', () => {
            const t = b.dataset.tier; if (STATE.tiers.has(t)) STATE.tiers.delete(t); else STATE.tiers.add(t);
            b.classList.toggle('active'); render();
        }));

        document.getElementById('professionFilters').addEventListener('click', e => {
            const b = e.target.closest('.prof-chip'); if (!b) return;
            const p = b.dataset.prof; if (STATE.profs.has(p)) STATE.profs.delete(p); else STATE.profs.add(p);
            b.classList.toggle('active'); render();
        });

        document.getElementById('interestToggle').addEventListener('click', e => {
            STATE.interestOnly = !STATE.interestOnly; e.currentTarget.classList.toggle('active'); render();
        });
        document.getElementById('coordsToggle').addEventListener('click', e => {
            STATE.coordsOnly = !STATE.coordsOnly; e.currentTarget.classList.toggle('active'); render();
        });

        document.getElementById('themeToggle').addEventListener('click', () => {
            const body = document.body; const icon = document.getElementById('themeIcon');
            if (body.classList.contains('light')) {
                body.classList.remove('light'); icon.classList.replace('fa-sun', 'fa-moon');
            } else {
                body.classList.add('light'); icon.classList.replace('fa-moon', 'fa-sun');
            }
        });

        window.onload = loadShopData;
    </script>
</body>
</html>
