<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Library of Imperial</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;700&display=swap');

        /* Default (Level 3: Parchment / Palette 1: Sage) */
        :root {
            --bg-body: #f5f2ed;
            --bg-card: #ffffff;
            --bg-surface: #faf8f5;
            --text-primary: #4a4641;
            --text-secondary: #8a847c;
            --accent: #a3b18a;
            --accent-hover: #588157;
            --border: rgba(0, 0, 0, 0.06);
            --shadow: 0 8px 30px rgba(0, 0, 0, 0.04);
            
            --status-red: #e07a5f;
            --status-orange: #f2cc8f;
            --status-green: #81b29a;
        }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: var(--bg-body);
            color: var(--text-primary);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            overflow-x: hidden;
        }

        .mono { font-family: 'JetBrains Mono', monospace; }

        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-body); }
        ::-webkit-scrollbar-thumb { background: #dcd7cf; border-radius: 10px; }

        .archive-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 24px;
            box-shadow: var(--shadow);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1), border-color 0.3s, background 0.3s;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .archive-card:hover {
            transform: translateY(-6px);
            border-color: var(--accent);
        }

        .input-base {
            background: var(--bg-card);
            border: 1px solid var(--border);
            color: var(--text-primary);
            border-radius: 14px;
            transition: all 0.2s;
        }

        .input-base:focus {
            border-color: var(--accent);
            outline: none;
            box-shadow: 0 0 0 4px rgba(var(--accent-rgb, 163, 177, 138), 0.15);
        }

        .btn-primary {
            background: var(--accent);
            color: white;
            border-radius: 14px;
            transition: background 0.2s, transform 0.2s;
        }

        .btn-primary:hover {
            background: var(--accent-hover);
            transform: scale(1.02);
        }

        .coord-btn {
            background: var(--bg-surface);
            color: var(--text-primary);
            border: 1px solid var(--border);
            transition: all 0.2s;
            font-size: 10px;
            font-weight: 700;
            padding: 6px 12px;
            border-radius: 10px;
        }
        
        .coord-btn:hover {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }

        #filterSidebar {
            background: var(--bg-card);
            border-left: 1px solid var(--border);
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        #filterSidebar.open { transform: translateX(0); }

        .loot-pill {
            background: var(--bg-surface);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 14px;
            margin-bottom: 12px;
        }

        .stat-badge {
            font-size: 10px;
            font-weight: 700;
            padding: 3px 8px;
            border-radius: 8px;
            background: var(--bg-card);
            border: 1px solid var(--border);
        }

        .toggle-btn.active {
            background: var(--accent);
            color: white !important;
            border-color: var(--accent);
        }

        #toast {
            position: fixed;
            bottom: 2.5rem;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--bg-card);
            color: var(--text-primary);
            padding: 1rem 2rem;
            border-radius: 18px;
            font-weight: 700;
            font-size: 14px;
            z-index: 1000;
            transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            border: 1px solid var(--accent);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.08);
        }
        #toast.show { transform: translateX(-50%) translateY(0); }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 6px;
        }
        .status-loading { background-color: var(--status-orange); box-shadow: 0 0 8px var(--status-orange); }
        .status-success { background-color: var(--status-green); box-shadow: 0 0 8px var(--status-green); }
        .status-error { background-color: var(--status-red); box-shadow: 0 0 8px var(--status-red); }

        .preset-dot {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid transparent;
            transition: border-color 0.2s;
        }
        .preset-dot.active { border-color: var(--text-primary); }
    </style>
</head>
<body class="min-h-screen">

    <div id="toast">Database Ready</div>

    <!-- Soft Header -->
    <header class="sticky top-0 z-40 w-full bg-[var(--bg-body)]/80 backdrop-blur-xl border-b border-[var(--border)]">
        <div class="max-w-[1400px] mx-auto px-6 h-24 flex items-center justify-between">
            <div class="flex items-center gap-4">
                <div class="w-12 h-12 bg-[var(--accent)] rounded-2xl flex items-center justify-center text-white shadow-lg shadow-[var(--accent)]/20 transition-colors">
                    <i class="fas fa-dragon text-xl"></i>
                </div>
                <div>
                    <h1 class="text-lg font-extrabold tracking-tight">Library of <span style="color: var(--accent-hover)">Imperial</span></h1>
                    <div class="flex items-center mt-0.5">
                        <span id="apiStatusDot" class="status-dot status-loading"></span>
                        <p id="apiStatusText" class="text-[9px] text-[var(--text-secondary)] font-bold tracking-[0.1em] uppercase">Connecting Matrix...</p>
                    </div>
                </div>
            </div>

            <div class="hidden md:flex flex-1 max-w-xl mx-10 relative">
                <i class="fas fa-search absolute left-5 top-1/2 -translate-y-1/2 text-[var(--text-secondary)] opacity-40"></i>
                <input 
                    type="text" id="globalSearch" 
                    placeholder="Search for unique records..."
                    class="w-full input-base py-3 pl-12 pr-6 text-sm placeholder:opacity-50"
                >
            </div>

            <div class="flex items-center gap-4">
                <button id="toggleFilters" class="btn-primary px-6 py-3 text-xs font-black uppercase tracking-widest flex items-center gap-2 shadow-lg shadow-[var(--accent)]/20">
                    <i class="fas fa-sliders-h"></i> Matrix
                </button>
            </div>
        </div>
    </header>

    <main class="max-w-[1400px] mx-auto px-6 py-10">
        <div id="activeTags" class="flex flex-wrap gap-2 mb-10 min-h-[32px]"></div>

        <div class="flex items-center justify-between mb-10">
            <h2 id="resultsInfo" class="text-xs font-black text-[var(--text-secondary)] uppercase tracking-[0.2em] opacity-60">
                Calibrating Imperial Records...
            </h2>
        </div>

        <div id="sourceGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-10"></div>

        <div id="emptyState" class="hidden py-48 flex flex-col items-center text-center">
            <div class="w-20 h-20 bg-[var(--bg-surface)] rounded-3xl flex items-center justify-center mb-6 opacity-30">
                <i class="fas fa-fingerprint text-3xl"></i>
            </div>
            <h3 class="text-xl font-bold opacity-70">Artifact Unregistered</h3>
            <p class="text-[var(--text-secondary)] text-sm mb-8">Zero unique signatures found in this sector.</p>
            <button onclick="clearAllFilters()" class="text-[var(--accent-hover)] font-black uppercase text-xs tracking-widest hover:underline">Flush Matrix</button>
        </div>
    </main>

    <!-- Side Sidebar -->
    <div id="sidebarOverlay" class="fixed inset-0 bg-black/30 z-[50] opacity-0 pointer-events-none transition-opacity duration-300"></div>
    <aside id="filterSidebar" class="fixed top-0 right-0 h-full w-[380px] z-[60] transform translate-x-full shadow-2xl flex flex-col">
        <div class="p-8 border-b border-[var(--border)] flex items-center justify-between">
            <h2 class="font-black text-sm uppercase tracking-widest">Protocol Matrix</h2>
            <button id="closeSidebar" class="text-[var(--text-secondary)] hover:text-[var(--text-primary)]"><i class="fas fa-times"></i></button>
        </div>

        <div class="flex-1 overflow-y-auto p-8 space-y-10 custom-scrollbar">
            <!-- New Preset Customization -->
            <section class="space-y-6">
                <label class="text-[10px] font-black text-[var(--text-secondary)] uppercase tracking-widest opacity-60">Visual Luminance (1-5)</label>
                <div class="flex justify-between items-center px-2" id="brightnessPresets">
                    <button data-level="1" class="preset-dot bg-[#0a0a0a]" title="Void (Super Dark)"></button>
                    <button data-level="2" class="preset-dot bg-[#1a1c23]" title="Midnight"></button>
                    <button data-level="3" class="preset-dot bg-[#f5f2ed]" title="Parchment (Neutral)"></button>
                    <button data-level="4" class="preset-dot bg-[#ffffff]" title="Daylight"></button>
                    <button data-level="5" class="preset-dot bg-[#fdfdfd] border-gray-200" title="Ivory (Pure Light)"></button>
                </div>

                <label class="text-[10px] font-black text-[var(--text-secondary)] uppercase tracking-widest opacity-60">Color Palette</label>
                <div class="flex justify-between items-center px-2" id="palettePresets">
                    <button data-palette="sage" class="preset-dot bg-[#a3b18a]" title="Sage (Imperial)"></button>
                    <button data-palette="ocean" class="preset-dot bg-[#72a1b1]" title="Oceanic"></button>
                    <button data-palette="crimson" class="preset-dot bg-[#b17272]" title="Crimson"></button>
                    <button data-palette="amber" class="preset-dot bg-[#b19672]" title="Amber"></button>
                    <button data-palette="lavender" class="preset-dot bg-[#8c72b1]" title="Lavender"></button>
                </div>
            </section>

            <section class="space-y-5">
                <label class="text-[10px] font-black text-[var(--text-secondary)] uppercase tracking-widest opacity-60">Tier Classification</label>
                <div class="grid grid-cols-4 gap-2" id="tierFilters">
                    <button data-tier="0" class="tier-btn input-base py-3 text-xs font-bold">T0</button>
                    <button data-tier="1" class="tier-btn input-base py-3 text-xs font-bold">T1</button>
                    <button data-tier="2" class="tier-btn input-base py-3 text-xs font-bold">T2</button>
                    <button data-tier="3" class="tier-btn input-base py-3 text-xs font-bold">T3</button>
                </div>
            </section>

            <section class="space-y-4">
                <label class="text-[10px] font-black text-[var(--text-secondary)] uppercase tracking-widest opacity-60">Active Toggles</label>
                <button id="interestToggle" class="toggle-btn input-base w-full py-4 text-[11px] font-black uppercase tracking-widest flex items-center justify-center gap-2">
                    <i class="fas fa-star text-amber-500"></i> High Interest
                </button>
                <button id="coordsToggle" class="toggle-btn input-base w-full py-4 text-[11px] font-black uppercase tracking-widest flex items-center justify-center gap-2">
                    <i class="fas fa-location-arrow"></i> Geolocated Only
                </button>
            </section>

            <section class="space-y-5">
                <label class="text-[10px] font-black text-[var(--text-secondary)] uppercase tracking-widest opacity-60">Loot Range</label>
                <div class="flex items-center gap-4">
                    <input type="number" id="minLevel" placeholder="0" class="w-full input-base px-4 py-3 text-sm font-bold">
                    <span class="text-[var(--text-secondary)] font-bold opacity-30">-</span>
                    <input type="number" id="maxLevel" placeholder="115" class="w-full input-base px-4 py-3 text-sm font-bold">
                </div>
            </section>

            <section class="space-y-8">
                <div>
                    <label class="block text-[10px] font-black uppercase tracking-widest mb-4 opacity-70">Buff Protocol</label>
                    <select id="posStat1" class="w-full input-base px-4 py-3 text-xs font-bold outline-none cursor-pointer"></select>
                </div>
                <div>
                    <label class="block text-[10px] font-black uppercase tracking-widest mb-4 opacity-70">Debuff Protocol</label>
                    <select id="negStat1" class="w-full input-base px-4 py-3 text-xs font-bold outline-none cursor-pointer"></select>
                </div>
            </section>

            <section class="space-y-5 pb-16">
                <label class="text-[10px] font-black text-[var(--text-secondary)] uppercase tracking-widest opacity-60">Professions</label>
                <div id="professionFilters" class="flex flex-wrap gap-2"></div>
            </section>
        </div>

        <div class="p-8 border-t border-[var(--border)]">
            <button onclick="clearAllFilters()" class="w-full py-4 rounded-2xl text-[11px] font-black uppercase tracking-widest bg-rose-500/10 text-rose-500 hover:bg-rose-500 hover:text-white transition-all">Emergency Reset</button>
        </div>
    </aside>

    <script>
        const MANUAL_INTEREST_LIST = [
            "Adamastor's Faceplate", "Ancient Heart", "Archaic Medallion", "Bat Heart", "Borange Fluff",
            "Cat Food", "Cataratite", "Coalescence", "Colossus' Shard", "Contraband Absinthe",
            "Contraband Hibiscus", "Creepvine Cluster", "Cursed Wings", "Cyclone Blue Leaves",
            "Death Whistle Leaf", "Decaying Heart", "Defiled Luxroot", "Defishious", "Dernic Parasite",
            "Doom Stone", "Draconic Bone Marrow", "Earthly Aura", "Elephelk Trunk", "Enhanced Behaviour Microchip",
            "Enhanced Potential Microchip", "Evolving Spores", "Eye of The Beast", "Fairy Powder",
            "Farcor's Trust", "Fiery Aura", "Flow of Fate", "Gilded Bark", "Glacial Anomaly",
            "Glowing Tree Sap", "Haleva Plant", "Haphazard Serum", "Ice Cream Sandwich", "Kerasot Sporehead",
            "Large Titanium Chunk", "Lashing Hellfire", "Lithoflesh", "Letvus Delight", "Lunar Charm",
            "Luxrooot Cuttings", "Mangrove Root", "Mellow Mango", "Myconid Spores", "Myocardial Leg",
            "Naval Stone", "Nightmare Fuel", "Nivlan Honey", "Obelisk Core", "Plane of Nonexistence",
            "Pride of the Heights", "Prismatic Spores", "Red Mercury", "Remedial Paste", "Ritual Catalyst",
            "Rock-Hard Beak", "Sentient Leukocyte", "Serpent Tongue", "Shattered Dawnlight", "Shrieker's Head",
            "Smokebomb", "Soulbound Cinders", "Tentacle", "Throbbing Avos Heart", "Unicorn Horn",
            "Watery Aura", "Windy Aura", "World Illuminator"
        ];
        const INTEREST_NAMES = new Set(MANUAL_INTEREST_LIST.map(n => n.trim().toLowerCase()));
        
        let SOURCE_DATA = [];
        let GLOBAL_ITEM_LOOKUP = {};
        const STATE = {
            search: "", minLv: 0, maxLv: 115, tiers: new Set(), profs: new Set(),
            posStat1: "", negStat1: "", interestOnly: false, coordsOnly: false,
            brightness: 3, palette: 'sage',
            allProfs: [], allPosStats: [], allNegStats: []
        };

        const isNum = (v) => v !== null && v !== undefined && v !== "" && isFinite(Number(v));
        function debounce(func, wait) {
            let timeout; return function(...args) { clearTimeout(timeout); timeout = setTimeout(() => func.apply(this, args), wait); };
        }

        function setApiStatus(state) {
            const dot = document.getElementById('apiStatusDot');
            const text = document.getElementById('apiStatusText');
            dot.className = "status-dot";
            if (state === 'loading') { dot.classList.add('status-loading'); text.textContent = "Connecting Matrix..."; }
            else if (state === 'success') { dot.classList.add('status-success'); text.textContent = "Live Sync Active"; }
            else if (state === 'error') { dot.classList.add('status-error'); text.textContent = "Offline (Local Backup)"; }
        }

        async function loadShopData() {
            let ingredients = {}, drops = {}, htoi = [], wynnItems = {};
            setApiStatus('loading');
            try {
                const [resI, resD, resH] = await Promise.all([
                    fetch('ingredients.json').then(r => r.ok ? r.json() : {}),
                    fetch('drops.json').then(r => r.ok ? r.json() : {}),
                    fetch('htoi.json').then(r => r.ok ? r.json() : [])
                ]);
                ingredients = resI; drops = resD; htoi = resH;

                try {
                    // Using a CORS proxy to fix the "Offline" issue
                    const wynnRes = await fetch('https://corsproxy.io/?' + encodeURIComponent('https://api.wynncraft.com/v3/item/database?fullResult'));
                    if (wynnRes.ok) {
                        wynnItems = await wynnRes.json();
                        setApiStatus('success');
                    } else { setApiStatus('error'); }
                } catch(apiErr) { setApiStatus('error'); }
            } catch (e) { setApiStatus('error'); }
            processJsonData(ingredients, drops, htoi, wynnItems);
        }

        function processJsonData(ingredients, dropsMap, htoiArray, wynnItems) {
            GLOBAL_ITEM_LOOKUP = {};
            Object.keys(ingredients).forEach(k => {
                const lower = k.trim().toLowerCase();
                GLOBAL_ITEM_LOOKUP[lower] = { ...ingredients[k], originalName: k };
            });
            if (wynnItems) {
                Object.keys(wynnItems).forEach(k => {
                    const lower = k.trim().toLowerCase();
                    if (!GLOBAL_ITEM_LOOKUP[lower]) {
                        const item = wynnItems[k];
                        GLOBAL_ITEM_LOOKUP[lower] = { originalName: item.name || k, lvl: item.level || 0, tier: item.tier || 0, profs: item.professions || [], stats: [] };
                    }
                });
            }

            const globalMobCoords = {};
            const addMobCoords = (mobName, coords) => {
                if (!mobName) return;
                const key = mobName.trim().toLowerCase(); // TRIMMED
                if (!globalMobCoords[key]) globalMobCoords[key] = [];
                const arr = Array.isArray(coords) ? coords : [coords].filter(x => x);
                arr.forEach(c => {
                    if (isNum(c.x) && isNum(c.z)) {
                        const nx = Number(c.x), ny = isNum(c.y) ? Number(c.y) : 0, nz = Number(c.z);
                        if (Math.abs(nx) + Math.abs(ny) + Math.abs(nz) === 0) return; 
                        const obj = { x: nx, y: isNum(c.y) ? ny : null, z: nz };
                        if (!globalMobCoords[key].some(ex => ex.x === obj.x && ex.z === obj.z)) globalMobCoords[key].push(obj);
                    }
                });
            };

            Object.values(dropsMap).forEach(arr => {
                if (Array.isArray(arr)) arr.forEach(d => addMobCoords(d.name, d.details?.coords));
            });
            htoiArray.forEach(h => {
                Object.keys(h).forEach(prop => {
                    if (['name', 'id', 'level'].includes(prop)) return;
                    try {
                        const parsed = JSON.parse(h[prop]);
                        if (Array.isArray(parsed)) parsed.forEach(e => addMobCoords(e.name || e.description, e.location_coords || e.coords));
                    } catch(e) {}
                });
            });

            const sourceRegistry = {};
            const registerSource = (mobName, location, screenshot, itemName) => {
                if (!mobName) return;
                const sName = mobName.trim(); // TRIMMED
                const sLoc = location?.trim() || "Undisclosed Sector";
                const sourceKey = `${sName.toLowerCase()}|${sLoc.toLowerCase()}`;

                if (!sourceRegistry[sourceKey]) {
                    sourceRegistry[sourceKey] = {
                        name: sName,
                        location: sLoc,
                        screenshots: new Set(),
                        loot: new Set(),
                        coords: globalMobCoords[sName.toLowerCase()] || []
                    };
                }
                if (screenshot) sourceRegistry[sourceKey].screenshots.add(screenshot);
                if (itemName) sourceRegistry[sourceKey].loot.add(itemName.trim().toLowerCase());
            };

            Object.keys(dropsMap).forEach(itemName => {
                const arr = dropsMap[itemName];
                if (Array.isArray(arr)) arr.forEach(d => registerSource(d.name, d.details?.location, d.details?.screenshots, itemName));
            });
            htoiArray.forEach(h => {
                const itemName = h.name;
                Object.keys(h).forEach(prop => {
                    if (['name', 'id', 'level'].includes(prop)) return;
                    try {
                        const parsed = JSON.parse(h[prop]);
                        if (Array.isArray(parsed)) parsed.forEach(e => registerSource(e.name || e.description || prop.toUpperCase(), e.location, e.screenshots, itemName));
                    } catch(e) {}
                });
            });

            const finalSources = Object.values(sourceRegistry).map(src => {
                const lootDetails = Array.from(src.loot).map(lootName => {
                    const info = GLOBAL_ITEM_LOOKUP[lootName] || { originalName: lootName, stats: [], lvl: 0, tier: -1, profs: [] };
                    return { name: info.originalName, level: Number(info.lvl) || 0, tier: info.tier !== undefined ? Number(info.tier) : -1, professions: info.profs || [], stats: info.stats || [] };
                });
                lootDetails.sort((a,b) => b.level - a.level);
                const searchStr = [src.name, src.location, ...lootDetails.map(l => l.name)].join(' ').toLowerCase();
                return { ...src, loot: lootDetails, searchStr, screenshots: Array.from(src.screenshots) };
            });

            SOURCE_DATA = finalSources;
            computeState();
            render();
        }

        function computeState() {
            const allItems = Object.values(GLOBAL_ITEM_LOOKUP);
            STATE.allProfs = [...new Set(allItems.flatMap(i => i.profs || []))].sort();
            STATE.allPosStats = [...new Set(allItems.flatMap(i => (i.stats || []).filter(s => s.pos).map(s => s.label)))].sort();
            STATE.allNegStats = [...new Set(allItems.flatMap(i => (i.stats || []).filter(s => !s.pos).map(s => s.label)))].sort();
            document.getElementById('posStat1').innerHTML = '<option value="">All Attributes</option>' + STATE.allPosStats.map(s => `<option value="${s}">${s}</option>`).join('');
            document.getElementById('negStat1').innerHTML = '<option value="">All Attributes</option>' + STATE.allNegStats.map(s => `<option value="${s}">${s}</option>`).join('');
            document.getElementById('professionFilters').innerHTML = STATE.allProfs.map(p => `<button data-prof="${p}" class="prof-chip input-base px-3 py-2 rounded-lg text-[10px] font-bold uppercase tracking-wider">${p}</button>`).join('');
        }

        function filterData() {
            return SOURCE_DATA.filter(src => {
                if (STATE.search && !src.searchStr.includes(STATE.search.toLowerCase())) return false;
                if (STATE.coordsOnly && src.coords.length === 0) return false;
                if (STATE.interestOnly && !src.loot.some(l => INTEREST_NAMES.has(l.name.toLowerCase()))) return false;
                const hasMatchingLoot = src.loot.some(l => {
                    if (l.level < STATE.minLv || l.level > STATE.maxLv) return false;
                    if (STATE.tiers.size > 0 && !STATE.tiers.has(l.tier.toString())) return false;
                    if (STATE.profs.size > 0 && !l.professions.some(p => STATE.profs.has(p))) return false;
                    if (STATE.posStat1 && !l.stats.some(s => s.label === STATE.posStat1 && s.pos)) return false;
                    if (STATE.negStat1 && !l.stats.some(s => s.label === STATE.negStat1 && !s.pos)) return false;
                    return true;
                });
                const anyLootFilters = STATE.minLv > 0 || STATE.maxLv < 115 || STATE.tiers.size > 0 || STATE.profs.size > 0 || STATE.posStat1 || STATE.negStat1;
                if (anyLootFilters && !hasMatchingLoot) return false;
                return true;
            }).sort((a,b) => a.name.localeCompare(b.name));
        }

        function render() {
            const grid = document.getElementById('sourceGrid'), info = document.getElementById('resultsInfo');
            const data = filterData();
            const view = data.slice(0, 60);
            info.textContent = data.length > 0 ? `${data.length} Strategic Sources Synced` : "Matrix Idle: Waiting for Signature";
            if (view.length === 0) { grid.innerHTML = ""; document.getElementById('emptyState').classList.remove('hidden'); }
            else {
                document.getElementById('emptyState').classList.add('hidden');
                grid.innerHTML = view.map(src => {
                    const coordsHtml = src.coords.map(c => {
                        const hasY = isNum(c.y);
                        const label = hasY ? `${c.x}, ${c.y}, ${c.z}` : `${c.x}, ${c.z}`;
                        return `<button onclick="copyToClipboard('${c.x}','${c.y}','${c.z}')" class="coord-btn mono">${label}</button>`;
                    }).join('');
                    const lootHtml = src.loot.map(l => `
                        <div class="loot-pill">
                            <div class="flex justify-between items-start mb-3">
                                <div class="overflow-hidden">
                                    <h4 class="text-[11px] font-black uppercase truncate text-[var(--text-primary)] opacity-80">${l.name}</h4>
                                    <div class="flex items-center gap-2 mt-1">
                                        <span class="mono text-[8px] font-bold" style="color: var(--accent-hover)">Lv.${l.level}</span>
                                        <div class="flex gap-0.5 text-[#e9c46a] text-[8px]">${l.tier >= 0 ? Array(l.tier).fill('â˜…').join('') : ''}</div>
                                    </div>
                                </div>
                            </div>
                            <div class="flex flex-wrap gap-2">
                                ${l.stats.slice(0, 4).map(s => `<span class="stat-badge ${s.pos ? 'text-[var(--status-green)]' : 'text-[var(--status-red)]'}">${s.label}: ${s.value}</span>`).join('')}
                            </div>
                        </div>
                    `).join('');
                    return `
                    <div class="archive-card p-8">
                        <div class="flex justify-between items-start mb-6">
                            <div class="flex-1 overflow-hidden">
                                <h3 class="text-base font-black tracking-tight truncate uppercase pr-2">${src.name}</h3>
                                <div class="flex items-center gap-2 mt-1.5 opacity-60">
                                    <i class="fas fa-map-marker-alt text-[10px]"></i>
                                    <p class="text-[10px] font-bold truncate uppercase tracking-widest">${src.location}</p>
                                </div>
                            </div>
                            ${src.screenshots.length > 0 ? `<a href="${src.screenshots[0].split(',')[0]}" target="_blank" class="w-10 h-10 flex items-center justify-center rounded-2xl bg-[var(--accent)] text-white hover:opacity-80 transition-all shadow-sm"><i class="fas fa-camera text-xs"></i></a>` : ''}
                        </div>
                        <div class="mb-8">
                            <p class="text-[9px] font-black uppercase tracking-[0.2em] text-[var(--text-secondary)] mb-4 opacity-40">Tactical Geolocation</p>
                            <div class="flex flex-wrap gap-2.5">${coordsHtml || '<span class="text-[10px] font-bold opacity-10 uppercase italic">Coordinates Unlisted</span>'}</div>
                        </div>
                        <div class="flex-1 overflow-y-auto max-h-[340px] custom-scrollbar pr-2">
                            <p class="text-[9px] font-black uppercase tracking-[0.2em] text-[var(--text-secondary)] mb-4 opacity-40">Artifacts Detected (${src.loot.length})</p>
                            ${lootHtml}
                        </div>
                    </div>
                `}).join('');
            }
            renderActiveTags();
        }

        function updateTheme() {
            const root = document.documentElement;
            // Palette Definitions
            const palettes = {
                sage: { accent: '#a3b18a', hover: '#588157', rgb: '163, 177, 138' },
                ocean: { accent: '#72a1b1', hover: '#457b9d', rgb: '114, 161, 177' },
                crimson: { accent: '#b17272', hover: '#8a4a4a', rgb: '177, 114, 114' },
                amber: { accent: '#b19672', hover: '#8a704a', rgb: '177, 150, 114' },
                lavender: { accent: '#8c72b1', hover: '#5b4a8a', rgb: '140, 114, 177' }
            };
            const p = palettes[STATE.palette];
            root.style.setProperty('--accent', p.accent);
            root.style.setProperty('--accent-hover', p.hover);
            root.style.setProperty('--accent-rgb', p.rgb);

            // Luminance Levels
            const levels = [
                { body: '#0a0a0a', card: '#121212', surf: '#181818', text: '#e0e0e0', sec: '#717171', border: 'rgba(255,255,255,0.06)' }, // 1: Void
                { body: '#1a1c23', card: '#252932', surf: '#2d323d', text: '#d1d5db', sec: '#9ca3af', border: 'rgba(255,255,255,0.04)' }, // 2: Midnight
                { body: '#f5f2ed', card: '#ffffff', surf: '#faf8f5', text: '#4a4641', sec: '#8a847c', border: 'rgba(0,0,0,0.06)' },    // 3: Neutral
                { body: '#ffffff', card: '#f9f9f9', surf: '#f1f1f1', text: '#1f2937', sec: '#6b7280', border: 'rgba(0,0,0,0.04)' },    // 4: Daylight
                { body: '#fdfdfd', card: '#ffffff', surf: '#fcfcfc', text: '#000000', sec: '#4b5563', border: 'rgba(0,0,0,0.02)' }     // 5: Ivory
            ];
            const l = levels[STATE.brightness - 1];
            root.style.setProperty('--bg-body', l.body);
            root.style.setProperty('--bg-card', l.card);
            root.style.setProperty('--bg-surface', l.surf);
            root.style.setProperty('--text-primary', l.text);
            root.style.setProperty('--text-secondary', l.sec);
            root.style.setProperty('--border', l.border);

            // Update Preset Dots UI
            document.querySelectorAll('#brightnessPresets button').forEach(b => b.classList.toggle('active', parseInt(b.dataset.level) === STATE.brightness));
            document.querySelectorAll('#palettePresets button').forEach(b => b.classList.toggle('active', b.dataset.palette === STATE.palette));
        }

        function renderActiveTags() {
            const container = document.getElementById('activeTags');
            const tags = [];
            if (STATE.search) tags.push({ id: 'search', val: STATE.search });
            if (STATE.interestOnly) tags.push({ id: 'interest', val: 'Featured' });
            if (STATE.coordsOnly) tags.push({ id: 'coords', val: 'Geolocated' });
            STATE.tiers.forEach(t => tags.push({ id: 'tier-'+t, val: `Tier ${t}` }));
            STATE.profs.forEach(p => tags.push({ id: 'prof-'+p, val: p }));
            container.innerHTML = tags.map(t => `
                <div class="flex items-center gap-3 px-4 py-2 bg-[var(--accent)]/10 text-[var(--accent-hover)] border border-[var(--accent)]/20 rounded-xl text-[10px] font-black uppercase tracking-wider">
                    ${t.val}
                    <button onclick="removeFilter('${t.id}')" class="hover:opacity-60 transition-colors"><i class="fas fa-times"></i></button>
                </div>
            `).join('');
        }

        function copyToClipboard(x, y, z) {
            const hasY = isNum(y) && y !== 'null' && y !== 'undefined';
            const cmd = hasY ? `/compass ${x}, ${y}, ${z}` : `/compass ${x}, ${z}`;
            const el = document.createElement('textarea'); el.value = cmd; el.style.position = "fixed"; el.style.left = "-9999px"; 
            document.body.appendChild(el); el.select();
            try { document.execCommand('copy'); const t = document.getElementById('toast'); t.textContent = "COPIED: " + cmd; t.classList.add('show'); setTimeout(() => t.classList.remove('show'), 2500); } catch(e) {}
            document.body.removeChild(el);
        }

        function removeFilter(id) {
            if (id === 'search') { STATE.search = ""; document.getElementById('globalSearch').value = ""; }
            else if (id === 'interest') { STATE.interestOnly = false; document.getElementById('interestToggle').classList.remove('active'); }
            else if (id === 'coords') { STATE.coordsOnly = false; document.getElementById('coordsToggle').classList.remove('active'); }
            else if (id.startsWith('tier-')) { STATE.tiers.delete(id.split('-')[1]); document.querySelectorAll('.tier-btn').forEach(b => { if(b.dataset.tier == id.split('-')[1]) b.classList.remove('active'); }); }
            else if (id.startsWith('prof-')) { STATE.profs.delete(id.split('-')[1]); document.querySelectorAll('.prof-chip').forEach(b => { if(b.dataset.prof == id.split('-')[1]) b.classList.remove('active'); }); }
            render();
        }

        function clearAllFilters() {
            STATE.search = ""; STATE.tiers.clear(); STATE.profs.clear(); STATE.interestOnly = false; STATE.coordsOnly = false; STATE.minLv = 0; STATE.maxLv = 115;
            document.getElementById('globalSearch').value = "";
            document.querySelectorAll('.active').forEach(e => { if(!e.classList.contains('preset-dot')) e.classList.remove('active'); });
            document.querySelectorAll('input[type="number"]').forEach(i => i.value = "");
            render();
        }

        // UI Listeners
        document.getElementById('toggleFilters').addEventListener('click', () => { document.getElementById('filterSidebar').classList.add('open'); document.getElementById('sidebarOverlay').classList.replace('opacity-0', 'opacity-100'); document.getElementById('sidebarOverlay').classList.remove('pointer-events-none'); });
        document.getElementById('closeSidebar').addEventListener('click', () => { document.getElementById('filterSidebar').classList.remove('open'); document.getElementById('sidebarOverlay').classList.replace('opacity-100', 'opacity-0'); document.getElementById('sidebarOverlay').classList.add('pointer-events-none'); });
        document.getElementById('sidebarOverlay').addEventListener('click', () => { document.getElementById('filterSidebar').classList.remove('open'); document.getElementById('sidebarOverlay').classList.replace('opacity-100', 'opacity-0'); document.getElementById('sidebarOverlay').classList.add('pointer-events-none'); });

        document.getElementById('brightnessPresets').addEventListener('click', e => {
            const btn = e.target.closest('button'); if(!btn) return;
            STATE.brightness = parseInt(btn.dataset.level); updateTheme();
        });
        document.getElementById('palettePresets').addEventListener('click', e => {
            const btn = e.target.closest('button'); if(!btn) return;
            STATE.palette = btn.dataset.palette; updateTheme();
        });

        document.getElementById('globalSearch').addEventListener('input', debounce(e => { STATE.search = e.target.value; render(); }, 250));
        document.getElementById('minLevel').addEventListener('input', e => { STATE.minLv = Number(e.target.value) || 0; render(); });
        document.getElementById('maxLevel').addEventListener('input', e => { STATE.maxLv = Number(e.target.value) || 115; render(); });
        document.getElementById('posStat1').addEventListener('change', e => { STATE.posStat1 = e.target.value; render(); });
        document.getElementById('negStat1').addEventListener('change', e => { STATE.negStat1 = e.target.value; render(); });
        document.querySelectorAll('.tier-btn').forEach(b => b.addEventListener('click', () => { const t = b.dataset.tier; if (STATE.tiers.has(t)) STATE.tiers.delete(t); else STATE.tiers.add(t); b.classList.toggle('active'); render(); }));
        document.getElementById('professionFilters').addEventListener('click', e => { const b = e.target.closest('.prof-chip'); if (!b) return; const p = b.dataset.prof; if (STATE.profs.has(p)) STATE.profs.delete(p); else STATE.profs.add(p); b.classList.toggle('active'); render(); });
        document.getElementById('interestToggle').addEventListener('click', e => { STATE.interestOnly = !STATE.interestOnly; e.currentTarget.classList.toggle('active'); render(); });
        document.getElementById('coordsToggle').addEventListener('click', e => { STATE.coordsOnly = !STATE.coordsOnly; e.currentTarget.classList.toggle('active'); render(); });

        window.onload = () => { loadShopData(); updateTheme(); };
    </script>
</body>
</html>
