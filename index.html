<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Imperial Archives | Library</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;700&display=swap');

        :root {
            --bg-body: #0a0a0c;
            --bg-card: #121216;
            --bg-surface: #1a1a20;
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
            --accent: #6366f1;
            --accent-glow: rgba(99, 102, 241, 0.15);
            --border: rgba(255, 255, 255, 0.06);
        }

        body.light {
            --bg-body: #f8fafc;
            --bg-card: #ffffff;
            --bg-surface: #f1f5f9;
            --text-primary: #0f172a;
            --text-secondary: #64748b;
            --accent: #4f46e5;
            --accent-glow: rgba(79, 70, 229, 0.1);
            --border: rgba(0, 0, 0, 0.08);
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-body);
            color: var(--text-primary);
            transition: all 0.3s ease;
            overflow-x: hidden;
        }

        .mono { font-family: 'JetBrains Mono', monospace; }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-body); }
        ::-webkit-scrollbar-thumb { background: var(--bg-surface); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--accent); }

        /* Card Stylings */
        .archive-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .archive-card:hover {
            transform: translateY(-4px);
            border-color: var(--accent);
            box-shadow: 0 12px 30px -10px var(--accent-glow);
        }

        /* Inputs & Buttons */
        .input-base {
            background: var(--bg-surface);
            border: 1px solid var(--border);
            color: var(--text-primary);
            transition: all 0.2s;
        }

        .input-base:focus {
            border-color: var(--accent);
            outline: none;
            box-shadow: 0 0 0 3px var(--accent-glow);
        }

        .btn-primary {
            background: var(--accent);
            color: white;
            transition: all 0.2s;
        }

        .btn-primary:hover {
            filter: brightness(1.1);
            transform: scale(1.02);
        }

        .btn-secondary {
            background: var(--bg-surface);
            border: 1px solid var(--border);
            color: var(--text-secondary);
        }

        .btn-secondary:hover {
            background: var(--bg-card);
            color: var(--text-primary);
            border-color: var(--accent);
        }

        /* Tactical Coord Button */
        .tactical-coord-btn {
            background: #ef4444;
            color: white;
            border: 1px solid #f87171;
            transition: all 0.2s;
            display: inline-flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-width: 50px;
            padding: 4px;
        }
        .tactical-coord-btn:hover {
            background: #dc2626;
            transform: scale(1.05);
        }

        /* Sidebar Logic */
        #filterSidebar {
            background: var(--bg-card);
            border-left: 1px solid var(--border);
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        #filterSidebar.open { transform: translateX(0); }

        /* Stats Coloring */
        .stat-positive { color: #10b981; }
        .stat-negative { color: #ef4444; }

        /* Toast */
        #toast {
            position: fixed;
            bottom: 2rem;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: #1e293b;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 12px;
            font-weight: 700;
            font-size: 0.875rem;
            z-index: 1000;
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 10px 25px -5px rgba(0,0,0,0.5);
            border: 1px solid var(--accent);
        }
        #toast.show { transform: translateX(-50%) translateY(0); }

        .toggle-btn.active {
            background: var(--accent);
            border-color: var(--accent);
            color: white !important;
        }
    </style>
</head>
<body class="min-h-screen">

    <div id="toast">Initializing...</div>

    <!-- Header -->
    <header class="sticky top-0 z-40 w-full bg-[var(--bg-body)]/80 backdrop-blur-md border-b border-[var(--border)]">
        <div class="max-w-[1600px] mx-auto px-6 h-20 flex items-center justify-between">
            <div class="flex items-center gap-4">
                <div class="w-10 h-10 bg-indigo-600 rounded-lg flex items-center justify-center text-white shadow-lg shadow-indigo-500/20">
                    <i class="fas fa-dragon text-xl"></i>
                </div>
                <div>
                    <h1 class="text-lg font-extrabold tracking-tight uppercase">Library of <span class="text-indigo-500">Imperial</span></h1>
                    <p class="text-[10px] text-[var(--text-secondary)] font-bold tracking-[0.2em] uppercase opacity-60">Strategic Archive</p>
                </div>
            </div>

            <div class="hidden md:flex flex-1 max-w-xl mx-12 relative">
                <i class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-[var(--text-secondary)] opacity-50"></i>
                <input 
                    type="text" id="globalSearch" 
                    placeholder="Search database..."
                    class="w-full input-base rounded-full py-2.5 pl-11 pr-6 text-sm"
                >
            </div>

            <div class="flex items-center gap-3">
                <button id="themeToggle" class="btn-secondary w-10 h-10 rounded-full flex items-center justify-center">
                    <i class="fas fa-moon" id="themeIcon"></i>
                </button>
                <button id="toggleFilters" class="btn-primary px-5 py-2.5 rounded-full text-xs font-bold uppercase tracking-wider flex items-center gap-2">
                    <i class="fas fa-sliders-h"></i>
                    <span>Matrix</span>
                </button>
            </div>
        </div>
    </header>

    <main class="max-w-[1600px] mx-auto px-6 py-10">
        <div id="activeTags" class="flex flex-wrap gap-2 mb-8 min-h-[32px]"></div>

        <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-8">
            <div id="resultsInfo" class="text-xs font-bold text-[var(--text-secondary)] uppercase tracking-widest bg-[var(--bg-surface)] px-4 py-2 rounded-lg inline-block border border-[var(--border)]">
                Accessing Core Records...
            </div>
            <div class="flex items-center gap-4">
                <span class="text-[10px] font-bold text-[var(--text-secondary)] uppercase">Order:</span>
                <select id="sortBy" class="input-base text-[10px] font-bold uppercase px-3 py-1.5 rounded-lg cursor-pointer">
                    <option value="name">Alphanumeric</option>
                    <option value="level">Level</option>
                    <option value="tier">Tier</option>
                </select>
            </div>
        </div>

        <div id="ingredientGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6"></div>

        <div id="emptyState" class="hidden py-32 flex flex-col items-center text-center">
            <div class="w-20 h-20 bg-[var(--bg-surface)] rounded-3xl flex items-center justify-center mb-6 border border-[var(--border)]">
                <i class="fas fa-skull text-3xl opacity-20"></i>
            </div>
            <h3 class="text-xl font-bold mb-2">No Records Found</h3>
            <p class="text-[var(--text-secondary)] text-sm mb-6">Matrix initialization returned null results.</p>
            <button onclick="clearAllFilters()" class="text-indigo-500 font-bold uppercase text-xs tracking-widest hover:underline">Re-link Archives</button>
        </div>
    </main>

    <div id="sidebarOverlay" class="fixed inset-0 bg-black/40 z-[50] opacity-0 pointer-events-none transition-opacity duration-300"></div>
    <aside id="filterSidebar" class="fixed top-0 right-0 h-full w-[350px] z-[60] transform translate-x-full shadow-2xl flex flex-col">
        <div class="p-6 border-b border-[var(--border)] flex items-center justify-between">
            <h2 class="font-black text-sm uppercase tracking-widest">Filter Matrix</h2>
            <button id="closeSidebar" class="text-[var(--text-secondary)] hover:text-[var(--text-primary)]"><i class="fas fa-times"></i></button>
        </div>

        <div class="flex-1 overflow-y-auto p-6 space-y-8 custom-scrollbar">
            <section class="space-y-4">
                <label class="text-[10px] font-bold text-[var(--text-secondary)] uppercase tracking-widest">Tier Level</label>
                <div class="grid grid-cols-4 gap-2" id="tierFilters">
                    <button data-tier="0" class="tier-btn input-base py-2 rounded-lg text-xs font-bold">T0</button>
                    <button data-tier="1" class="tier-btn input-base py-2 rounded-lg text-xs font-bold">T1</button>
                    <button data-tier="2" class="tier-btn input-base py-2 rounded-lg text-xs font-bold">T2</button>
                    <button data-tier="3" class="tier-btn input-base py-2 rounded-lg text-xs font-bold">T3</button>
                </div>
            </section>

            <section class="space-y-4">
                <label class="text-[10px] font-bold text-[var(--text-secondary)] uppercase tracking-widest">Priority Protocols</label>
                <div class="space-y-2">
                    <button id="interestToggle" class="toggle-btn btn-secondary w-full py-3 rounded-xl text-[10px] font-bold uppercase tracking-wider flex items-center justify-center gap-2">
                        <i class="fas fa-star text-amber-500"></i> Targeted Interest
                    </button>
                    <button id="coordsToggle" class="toggle-btn btn-secondary w-full py-3 rounded-xl text-[10px] font-bold uppercase tracking-wider flex items-center justify-center gap-2">
                        <i class="fas fa-crosshairs text-red-500"></i> Geolocation Logs
                    </button>
                </div>
            </section>

            <section class="space-y-4">
                <label class="text-[10px] font-bold text-[var(--text-secondary)] uppercase tracking-widest">Range Parameters</label>
                <div class="flex items-center gap-3">
                    <input type="number" id="minLevel" placeholder="MIN" class="w-full input-base rounded-lg px-3 py-2 text-sm font-bold">
                    <span class="opacity-20">/</span>
                    <input type="number" id="maxLevel" placeholder="MAX" class="w-full input-base rounded-lg px-3 py-2 text-sm font-bold">
                </div>
            </section>

            <section class="space-y-6">
                <div>
                    <label class="block text-[10px] font-bold text-emerald-500 uppercase tracking-widest mb-3">Buff Affinity</label>
                    <select id="posStat1" class="w-full input-base rounded-lg px-3 py-2 text-xs font-bold outline-none"></select>
                </div>
                <div>
                    <label class="block text-[10px] font-bold text-rose-500 uppercase tracking-widest mb-3">Debuff Affinity</label>
                    <select id="negStat1" class="w-full input-base rounded-lg px-3 py-2 text-xs font-bold outline-none"></select>
                </div>
            </section>

            <section class="space-y-4 pb-12">
                <label class="text-[10px] font-bold text-[var(--text-secondary)] uppercase tracking-widest">Profession Authority</label>
                <div id="professionFilters" class="flex flex-wrap gap-2"></div>
            </section>
        </div>

        <div class="p-6 border-t border-[var(--border)]">
            <button onclick="clearAllFilters()" class="w-full py-3 rounded-xl text-xs font-bold uppercase tracking-widest bg-rose-500/10 text-rose-500 border border-rose-500/20 hover:bg-rose-500 hover:text-white transition-all">Flush Settings</button>
        </div>
    </aside>

    <script>
        const MANUAL_INTEREST_LIST = [
            "Adamastor's Faceplate", "Ancient Heart", "Archaic Medallion", "Bat Heart", "Borange Fluff",
            "Cat Food", "Cataratite", "Coalescence", "Colossus' Shard", "Contraband Absinthe",
            "Contraband Hibiscus", "Creepvine Cluster", "Cursed Wings", "Cyclone Blue Leaves",
            "Death Whistle Leaf", "Decaying Heart", "Defiled Luxroot", "Defishious", "Dernic Parasite",
            "Doom Stone", "Draconic Bone Marrow", "Earthly Aura", "Elephelk Trunk", "Enhanced Behaviour Microchip",
            "Enhanced Potential Microchip", "Evolving Spores", "Eye of The Beast", "Fairy Powder",
            "Farcor's Trust", "Fiery Aura", "Flow of Fate", "Gilded Bark", "Glacial Anomaly",
            "Glowing Tree Sap", "Haleva Plant", "Haphazard Serum", "Ice Cream Sandwich", "Kerasot Sporehead",
            "Large Titanium Chunk", "Lashing Hellfire", "Lithoflesh", "Letvus Delight", "Lunar Charm",
            "Luxrooot Cuttings", "Mangrove Root", "Mellow Mango", "Myconid Spores", "Myocardial Leg",
            "Naval Stone", "Nightmare Fuel", "Nivlan Honey", "Obelisk Core", "Plane of Nonexistence",
            "Pride of the Heights", "Prismatic Spores", "Red Mercury", "Remedial Paste", "Ritual Catalyst",
            "Rock-Hard Beak", "Sentient Leukocyte", "Serpent Tongue", "Shattered Dawnlight", "Shrieker's Head",
            "Smokebomb", "Soulbound Cinders", "Tentacle", "Throbbing Avos Heart", "Unicorn Horn",
            "Watery Aura", "Windy Aura", "World Illuminator"
        ];
        const INTEREST_NAMES = new Set(MANUAL_INTEREST_LIST.map(n => n.trim().toLowerCase()));
        
        let RAW_DATA = [];
        const STATE = {
            search: "", minLv: 0, maxLv: 115, tiers: new Set(), profs: new Set(),
            posStat1: "", negStat1: "", interestOnly: false, coordsOnly: false, theme: "dark",
            sortBy: "name", allProfs: [], allPosStats: [], allNegStats: []
        };

        const isNum = (v) => v !== null && v !== undefined && v !== "" && isFinite(Number(v));
        function debounce(func, wait) {
            let timeout; return function(...args) { clearTimeout(timeout); timeout = setTimeout(() => func.apply(this, args), wait); };
        }

        async function loadShopData() {
            let ingredients = {}, drops = {}, htoi = [];
            try {
                const [resI, resD, resH] = await Promise.all([
                    fetch('ingredients.json').then(r => r.ok ? r.json() : {}),
                    fetch('drops.json').then(r => r.ok ? r.json() : {}),
                    fetch('htoi.json').then(r => r.ok ? r.json() : [])
                ]);
                ingredients = resI; drops = resD; htoi = resH;
            } catch (e) { console.error("Data Fetch Error", e); }
            processJsonData(ingredients, drops, htoi);
        }

        function processJsonData(ingredients, dropsMap, htoiArray) {
            const processed = [];
            
            // Step 1: Global Telemetry Mapping (Shared Coords across all mobs with same name)
            const sharedTelemetry = {};
            const addTelemetry = (name, rawCoords) => {
                if (!name) return;
                const key = name.toLowerCase().trim();
                if (!sharedTelemetry[key]) sharedTelemetry[key] = [];
                
                const coordsArr = Array.isArray(rawCoords) ? rawCoords : [rawCoords].filter(x => x);
                coordsArr.forEach(c => {
                    if (isNum(c.x) && isNum(c.z)) {
                        const coordObj = { x: Number(c.x), y: isNum(c.y) ? Number(c.y) : null, z: Number(c.z) };
                        // Prevent duplicates
                        if (!sharedTelemetry[key].some(ex => ex.x === coordObj.x && ex.z === coordObj.z && ex.y === coordObj.y)) {
                            sharedTelemetry[key].push(coordObj);
                        }
                    }
                });
            };

            // Gather telemetry from drops.json
            Object.values(dropsMap).forEach(arr => {
                if (Array.isArray(arr)) arr.forEach(d => addTelemetry(d.name, d.details?.coords));
            });

            // Gather telemetry from htoi.json (iterating through all JSON fields)
            htoiArray.forEach(item => {
                Object.keys(item).forEach(prop => {
                    if (['name', 'id', 'level'].includes(prop)) return;
                    try {
                        const parsed = JSON.parse(item[prop]);
                        if (Array.isArray(parsed)) {
                            parsed.forEach(e => addTelemetry(e.name || e.description, e.location_coords || e.coords));
                        }
                    } catch(e) {}
                });
            });

            // Step 2: Build Combined Registry
            const normIngredients = {};
            Object.keys(ingredients).forEach(k => normIngredients[k.trim().toLowerCase()] = { ...ingredients[k], originalName: k });
            
            const allKeys = new Set([...Object.keys(normIngredients), ...Object.keys(dropsMap).map(k => k.toLowerCase())]);
            htoiArray.forEach(h => { if(h.name) allKeys.add(h.name.toLowerCase()); });

            for (const key of allKeys) {
                const ing = normIngredients[key] || {};
                const hData = htoiArray.find(h => h.name?.toLowerCase() === key) || {};
                
                const combinedDrops = new Map();
                const registerDrop = (name, loc, ss) => {
                    if (!name) return;
                    const dKey = `${name.toLowerCase()}|${loc?.toLowerCase()}`;
                    if (!combinedDrops.has(dKey)) {
                        combinedDrops.set(dKey, { 
                            name: name.trim(), 
                            location: loc?.trim() || "Undisclosed Area",
                            screenshots: ss || ""
                        });
                    }
                };

                // Add drops from drops.json
                (dropsMap[key] || []).forEach(d => registerDrop(d.name, d.details?.location, d.details?.screenshots));
                
                // Add drops from htoi.json fields
                Object.keys(hData).forEach(prop => {
                    if (['name', 'id', 'level'].includes(prop)) return;
                    try {
                        const parsed = JSON.parse(hData[prop]);
                        if (Array.isArray(parsed)) {
                            parsed.forEach(e => registerDrop(e.name || e.description || prop.toUpperCase(), e.location, e.screenshots));
                        }
                    } catch(e) {}
                });

                const item = {
                    name: ing.originalName || hData.name || key.toUpperCase(),
                    level: Number(ing.lvl || hData.level) || 0,
                    tier: ing.tier !== undefined ? Number(ing.tier) : -1,
                    professions: ing.profs || [],
                    stats: ing.stats || [],
                    drops: Array.from(combinedDrops.values()).map(d => ({
                        ...d,
                        coords: sharedTelemetry[d.name.toLowerCase()] || []
                    })),
                    searchStr: key
                };
                item.searchStr = [item.name, ...item.professions, ...item.stats.map(s => s.label)].join(' ').toLowerCase();
                processed.push(item);
            }
            RAW_DATA = processed;
            computeState();
            render();
        }

        function computeState() {
            STATE.allProfs = [...new Set(RAW_DATA.flatMap(i => i.professions))].sort();
            STATE.allPosStats = [...new Set(RAW_DATA.flatMap(i => i.stats.filter(s => s.pos).map(s => s.label)))].sort();
            STATE.allNegStats = [...new Set(RAW_DATA.flatMap(i => i.stats.filter(s => !s.pos).map(s => s.label)))].sort();
            
            document.getElementById('posStat1').innerHTML = '<option value="">All Attributes</option>' + STATE.allPosStats.map(s => `<option value="${s}">${s}</option>`).join('');
            document.getElementById('negStat1').innerHTML = '<option value="">All Attributes</option>' + STATE.allNegStats.map(s => `<option value="${s}">${s}</option>`).join('');
            document.getElementById('professionFilters').innerHTML = STATE.allProfs.map(p => `<button data-prof="${p}" class="prof-chip input-base px-3 py-1.5 rounded-lg text-[10px] font-bold uppercase tracking-wider">${p}</button>`).join('');
        }

        function filterData() {
            let data = RAW_DATA.filter(i => {
                if (STATE.search && !i.searchStr.includes(STATE.search.toLowerCase())) return false;
                if (i.level < STATE.minLv || i.level > STATE.maxLv) return false;
                if (STATE.tiers.size && !STATE.tiers.has(i.tier.toString())) return false;
                if (STATE.profs.size && !i.professions.some(p => STATE.profs.has(p))) return false;
                if (STATE.interestOnly && !INTEREST_NAMES.has(i.name.toLowerCase())) return false;
                if (STATE.coordsOnly && !i.drops.some(d => d.coords.length > 0)) return false;
                if (STATE.posStat1 && !i.stats.some(s => s.label === STATE.posStat1 && s.pos)) return false;
                if (STATE.negStat1 && !i.stats.some(s => s.label === STATE.negStat1 && !s.pos)) return false;
                return true;
            });

            if (STATE.sortBy === "level") data.sort((a,b) => b.level - a.level);
            else if (STATE.sortBy === "tier") data.sort((a,b) => b.tier - a.tier);
            else data.sort((a,b) => a.name.localeCompare(b.name));
            return data;
        }

        function render() {
            const grid = document.getElementById('ingredientGrid'), info = document.getElementById('resultsInfo');
            const data = filterData();
            const view = data.slice(0, 100);
            
            info.textContent = data.length > 0 ? `${data.length} Archive Records Retrieved` : "Database Sync Failed: Null Results";
            
            if (view.length === 0) {
                grid.innerHTML = "";
                document.getElementById('emptyState').classList.remove('hidden');
            } else {
                document.getElementById('emptyState').classList.add('hidden');
                grid.innerHTML = view.map(item => {
                    const cardCoordRegistry = new Set();
                    return `
                    <div class="archive-card rounded-2xl p-5 flex flex-col gap-5">
                        <div class="flex justify-between items-start">
                            <div class="flex-1 overflow-hidden">
                                <h3 class="text-sm font-bold tracking-tight mb-1 truncate pr-2 uppercase">${item.name}</h3>
                                <div class="flex items-center gap-2">
                                    <span class="mono text-[9px] font-bold bg-indigo-500/10 text-indigo-500 px-1.5 py-0.5 rounded">LV.${item.level}</span>
                                    <div class="flex gap-0.5 text-amber-500 text-[8px]">
                                        ${item.tier >= 0 ? Array(item.tier).fill('<i class="fas fa-star"></i>').join('') : '<span class="opacity-30 uppercase font-black text-[7px]">Unknown</span>'}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="space-y-4">
                            <div class="space-y-1.5">
                                ${item.stats.length === 0 ? '<div class="h-10 flex items-center text-[10px] text-[var(--text-secondary)] opacity-30 italic">Passive Entry.</div>' : 
                                    item.stats.slice(0, 6).map(s => `
                                    <div class="flex justify-between text-[11px] font-medium border-b border-[var(--border)] pb-1">
                                        <span class="text-[var(--text-secondary)] truncate pr-4">${s.label}</span>
                                        <span class="${s.pos ? 'stat-positive' : 'stat-negative'} mono font-bold">${s.value}</span>
                                    </div>
                                `).join('')}
                            </div>

                            <div class="space-y-3">
                                <p class="text-[9px] font-black uppercase tracking-[0.2em] text-[var(--text-secondary)] opacity-50">Intelligence Logs</p>
                                ${item.drops.length === 0 ? '<p class="text-[10px] text-[var(--text-secondary)] opacity-20 italic">No telemetry data.</p>' : 
                                    item.drops.map(d => {
                                        const coordsHtml = d.coords.map(c => {
                                            const key = `${c.x}|${c.y}|${c.z}`;
                                            if (cardCoordRegistry.has(key)) return '';
                                            cardCoordRegistry.add(key);
                                            const hasY = isNum(c.y);
                                            const label = hasY ? `${c.x}, ${c.y}, ${c.z}` : `${c.x}, ${c.z}`;
                                            return `
                                                <button onclick="copyToClipboard('${c.x}','${c.y}','${c.z}')" class="tactical-coord-btn rounded-md shadow-sm" title="Target: ${label}">
                                                    <i class="fas fa-crosshairs text-[10px]"></i>
                                                    <span class="text-[6px] font-black mt-0.5">${label}</span>
                                                </button>
                                            `;
                                        }).join('');

                                        return `
                                        <div class="bg-[var(--bg-surface)] p-3 rounded-xl border border-[var(--border)] space-y-2">
                                            <div class="flex justify-between items-start gap-2">
                                                <div class="flex-1 min-w-0">
                                                    <p class="text-[11px] font-bold truncate">${d.name}</p>
                                                    <p class="text-[9px] text-[var(--text-secondary)] opacity-70 italic truncate">${d.location}</p>
                                                </div>
                                                ${d.screenshots ? `<a href="${d.screenshots.split(',')[0]}" target="_blank" class="w-6 h-6 flex items-center justify-center rounded bg-indigo-500/20 text-indigo-500 hover:bg-indigo-500 hover:text-white transition-all"><i class="fas fa-image text-[10px]"></i></a>` : ''}
                                            </div>
                                            <div class="flex flex-wrap gap-1">
                                                ${coordsHtml}
                                            </div>
                                        </div>
                                    `;}).join('')}
                            </div>
                        </div>

                        <div class="mt-auto flex flex-wrap gap-1.5 pt-4 border-t border-[var(--border)]">
                            ${item.professions.map(p => `<span class="text-[8px] font-bold uppercase tracking-tighter bg-[var(--bg-surface)] text-[var(--text-secondary)] px-2 py-1 rounded border border-[var(--border)]">${p}</span>`).join('')}
                        </div>
                    </div>
                `}).join('');
            }
            renderActiveTags();
        }

        function renderActiveTags() {
            const container = document.getElementById('activeTags');
            const tags = [];
            if (STATE.search) tags.push({ id: 'search', val: `Query: ${STATE.search}` });
            if (STATE.interestOnly) tags.push({ id: 'interest', val: 'Targeted' });
            if (STATE.coordsOnly) tags.push({ id: 'coords', val: 'Geolocated' });
            STATE.tiers.forEach(t => tags.push({ id: 'tier-'+t, val: `Tier ${t}` }));
            STATE.profs.forEach(p => tags.push({ id: 'prof-'+p, val: p }));

            container.innerHTML = tags.map(t => `
                <div class="flex items-center gap-2 px-3 py-1 bg-indigo-500/10 text-indigo-500 border border-indigo-500/20 rounded-full text-[10px] font-bold uppercase">
                    ${t.val}
                    <button onclick="removeFilter('${t.id}')" class="hover:text-white transition-colors"><i class="fas fa-times"></i></button>
                </div>
            `).join('');
        }

        function copyToClipboard(x, y, z) {
            const hasY = isNum(y) && y !== 'null' && y !== 'undefined';
            const cmd = hasY ? `/compass ${x}, ${y}, ${z}` : `/compass ${x}, ${z}`;
            const el = document.createElement('textarea'); 
            el.value = cmd; 
            el.style.position = "fixed"; 
            el.style.left = "-9999px"; 
            document.body.appendChild(el); 
            el.select();
            try {
                document.execCommand('copy'); 
                const t = document.getElementById('toast'); 
                t.textContent = "COPIED: " + cmd; 
                t.classList.add('show');
                setTimeout(() => t.classList.remove('show'), 2500);
            } catch(e) {}
            document.body.removeChild(el);
        }

        function removeFilter(id) {
            if (id === 'search') { STATE.search = ""; document.getElementById('globalSearch').value = ""; }
            else if (id === 'interest') { STATE.interestOnly = false; document.getElementById('interestToggle').classList.remove('active'); }
            else if (id === 'coords') { STATE.coordsOnly = false; document.getElementById('coordsToggle').classList.remove('active'); }
            else if (id.startsWith('tier-')) { STATE.tiers.delete(id.split('-')[1]); document.querySelectorAll('.tier-btn').forEach(b => { if(b.dataset.tier == id.split('-')[1]) b.classList.remove('active'); }); }
            else if (id.startsWith('prof-')) { STATE.profs.delete(id.split('-')[1]); document.querySelectorAll('.prof-chip').forEach(b => { if(b.dataset.prof == id.split('-')[1]) b.classList.remove('active'); }); }
            render();
        }

        function clearAllFilters() {
            STATE.search = ""; STATE.tiers.clear(); STATE.profs.clear(); 
            STATE.interestOnly = false; STATE.coordsOnly = false;
            STATE.minLv = 0; STATE.maxLv = 115;
            document.getElementById('globalSearch').value = "";
            document.querySelectorAll('.active').forEach(e => e.classList.remove('active'));
            document.querySelectorAll('input[type="number"]').forEach(i => i.value = "");
            render();
        }

        document.getElementById('toggleFilters').addEventListener('click', () => {
            document.getElementById('filterSidebar').classList.add('open');
            document.getElementById('sidebarOverlay').classList.replace('opacity-0', 'opacity-100');
            document.getElementById('sidebarOverlay').classList.remove('pointer-events-none');
        });
        document.getElementById('closeSidebar').addEventListener('click', () => {
            document.getElementById('filterSidebar').classList.remove('open');
            document.getElementById('sidebarOverlay').classList.replace('opacity-100', 'opacity-0');
            document.getElementById('sidebarOverlay').classList.add('pointer-events-none');
        });
        document.getElementById('sidebarOverlay').addEventListener('click', () => document.getElementById('closeSidebar').click());
        document.getElementById('globalSearch').addEventListener('input', debounce(e => { STATE.search = e.target.value; render(); }, 250));
        document.getElementById('sortBy').addEventListener('change', e => { STATE.sortBy = e.target.value; render(); });
        document.getElementById('minLevel').addEventListener('input', e => { STATE.minLv = Number(e.target.value) || 0; render(); });
        document.getElementById('maxLevel').addEventListener('input', e => { STATE.maxLv = Number(e.target.value) || 115; render(); });
        document.getElementById('posStat1').addEventListener('change', e => { STATE.posStat1 = e.target.value; render(); });
        document.getElementById('negStat1').addEventListener('change', e => { STATE.negStat1 = e.target.value; render(); });
        
        document.querySelectorAll('.tier-btn').forEach(b => b.addEventListener('click', () => {
            const t = b.dataset.tier; if (STATE.tiers.has(t)) STATE.tiers.delete(t); else STATE.tiers.add(t);
            b.classList.toggle('active'); render();
        }));

        document.getElementById('professionFilters').addEventListener('click', e => {
            const b = e.target.closest('.prof-chip'); if (!b) return;
            const p = b.dataset.prof; if (STATE.profs.has(p)) STATE.profs.delete(p); else STATE.profs.add(p);
            b.classList.toggle('active'); render();
        });

        document.getElementById('interestToggle').addEventListener('click', e => {
            STATE.interestOnly = !STATE.interestOnly; e.currentTarget.classList.toggle('active'); render();
        });
        document.getElementById('coordsToggle').addEventListener('click', e => {
            STATE.coordsOnly = !STATE.coordsOnly; e.currentTarget.classList.toggle('active'); render();
        });

        document.getElementById('themeToggle').addEventListener('click', () => {
            const body = document.body; const icon = document.getElementById('themeIcon');
            if (body.classList.contains('light')) {
                body.classList.remove('light'); icon.classList.replace('fa-sun', 'fa-moon');
            } else {
                body.classList.add('light'); icon.classList.replace('fa-moon', 'fa-sun');
            }
        });

        window.onload = loadShopData;
    </script>
</body>
</html>
